{
  "query": "In the Linux kernel, the following vulnerability has been resolved btrfs dont take dev_replace rwsem on task already holding it Running fstests btrfs/011 with MKFS_OPTIONS=-O rst to force the usage of the RAID stripe-tree, we get the following splat from lockdep BTRFS info (device sdd) dev_replace from /dev/sdd (devid 1) to /dev/sdb started ============================================ WARNING possible recursive locking detected 6.11.0-rc3-btrfs-for-next #599 Not tainted -------------------------------------------- btrfs/2326 is trying to acquire lock ffff88810f215c98 (&fs_info->dev_replace.rwsem){++++}-{33}, at btrfs_map_block+0x39f/0x2250 but task is already holding lock ffff88810f215c98 (&fs_info->dev_replace.rwsem){++++}-{33}, at btrfs_map_block+0x39f/0x2250 other info that might help us debug this Possible unsafe locking scenario CPU0 ---- lock(&fs_info->dev_replace.rwsem) lock(&fs_info->dev_replace.rwsem) *** DEADLOCK *** May be due to missing lock nesting notation 1 lock held by btrfs/2326 #0 ffff88810f215c98 (&fs_info->dev_replace.rwsem){++++}-{33}, at btrfs_map_block+0x39f/0x2250 stack backtrace CPU 1 UID 0 PID 2326 Comm btrfs Not tainted 6.11.0-rc3-btrfs-for-next #599 Hardware name Bochs Bochs, BIOS Bochs 01/01/2011 Call Trace dump_stack_lvl+0x5b/0x80 __lock_acquire+0x2798/0x69d0 ? __pfx___lock_acquire+0x10/0x10 ? __pfx___lock_acquire+0x10/0x10 lock_acquire+0x19d/0x4a0 ? btrfs_map_block+0x39f/0x2250 ? __pfx_lock_acquire+0x10/0x10 ? find_held_lock+0x2d/0x110 ? lock_is_held_type+0x8f/0x100 down_read+0x8e/0x440 ? btrfs_map_block+0x39f/0x2250 ? __pfx_down_read+0x10/0x10 ? do_raw_read_unlock+0x44/0x70 ? _raw_read_unlock+0x23/0x40 btrfs_map_block+0x39f/0x2250 ? btrfs_dev_replace_by_ioctl+0xd69/0x1d00 ? btrfs_bio_counter_inc_blocked+0xd9/0x2e0 ? __kasan_slab_alloc+0x6e/0x70 ? __pfx_btrfs_map_block+0x10/0x10 ? __pfx_btrfs_bio_counter_inc_blocked+0x10/0x10 ? kmem_cache_alloc_noprof+0x1f2/0x300 ? mempool_alloc_noprof+0xed/0x2b0 btrfs_submit_chunk+0x28d/0x17e0 ? __pfx_btrfs_submit_chunk+0x10/0x10 ? bvec_alloc+0xd7/0x1b0 ? bio_add_folio+0x171/0x270 ? __pfx_bio_add_folio+0x10/0x10 ? __kasan_check_read+0x20/0x20 btrfs_submit_bio+0x37/0x80 read_extent_buffer_pages+0x3df/0x6c0 btrfs_read_extent_buffer+0x13e/0x5f0 read_tree_block+0x81/0xe0 read_block_for_search+0x4bd/0x7a0 ? __pfx_read_block_for_search+0x10/0x10 btrfs_search_slot+0x78d/0x2720 ? __pfx_btrfs_search_slot+0x10/0x10 ? lock_is_held_type+0x8f/0x100 ? kasan_save_track+0x14/0x30 ? __kasan_slab_alloc+0x6e/0x70 ? kmem_cache_alloc_noprof+0x1f2/0x300 btrfs_get_raid_extent_offset+0x181/0x820 ? __pfx_lock_acquire+0x10/0x10 ? __pfx_btrfs_get_raid_extent_offset+0x10/0x10 ? down_read+0x194/0x440 ? __pfx_down_read+0x10/0x10 ? do_raw_read_unlock+0x44/0x70 ? _raw_read_unlock+0x23/0x40 btrfs_map_block+0x5b5/0x2250 ? __pfx_btrfs_map_block+0x10/0x10 scrub_submit_initial_read+0x8fe/0x11b0 ? __pfx_scrub_submit_initial_read+0x10/0x10 submit_initial_group_read+0x161/0x3a0 ? lock_release+0x20e/0x710 ? __pfx_submit_initial_group_read+0x10/0x10 ? __pfx_lock_release+0x10/0x10 scrub_simple_mirror.isra.0+0x3eb/0x580 scrub_stripe+0xe4d/0x1440 ? lock_release+0x20e/0x710 ? __pfx_scrub_stripe+0x10/0x10 ? __pfx_lock_release+0x10/0x10 ? do_raw_read_unlock+0x44/0x70 ? _raw_read_unlock+0x23/0x40 scrub_chunk+0x257/0x4a0 scrub_enumerate_chunks+0x64c/0xf70 ? __mutex_unlock_slowpath+0x147/0x5f0 ? __pfx_scrub_enumerate_chunks+0x10/0x10 ? bit_wait_timeout+0xb0/0x170 ? __up_read+0x189/0x700 ? scrub_workers_get+0x231/0x300 ? up_write+0x490/0x4f0 btrfs_scrub_dev+0x52e/0xcd0 ? create_pending_snapshots+0x230/0x250 ? __pfx_btrfs_scrub_dev+0x10/0x10 btrfs_dev_replace_by_ioctl+0xd69/0x1d00 ? lock_acquire+0x19d/0x4a0 ? __pfx_btrfs_dev_replace_by_ioctl+0x10/0x10 ? ---truncated---",
  "keyphrases": {},
  "timestamp": "2025-07-12T05:11:18.711404",
  "retriever_config": {
    "weights": {
      "dense": 0.35,
      "sparse": 0.4,
      "graph": 0.25
    },
    "use_graph": true,
    "use_rag": true,
    "use_sparse": true
  },
  "raw_results": {
    "graph": [
      {
        "cwe_id": "1325",
        "name": "Improperly Controlled Sequential Memory Allocation",
        "abstraction": "base",
        "score": 2.3400000000000003,
        "description": "CWE-1325: Improperly Controlled Sequential Memory Allocation...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "319",
        "name": "Cleartext Transmission of Sensitive Information",
        "abstraction": "base",
        "score": 2.1189999999999998,
        "description": "CWE-319: Cleartext Transmission of Sensitive Information...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "456",
        "name": "Missing Initialization of a Variable",
        "abstraction": "variant",
        "score": 1.83936,
        "description": "CWE-456: Missing Initialization of a Variable...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "22",
        "name": "Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
        "abstraction": "base",
        "score": 1.7680000000000005,
        "description": "CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "41",
        "name": "Improper Resolution of Path Equivalence",
        "abstraction": "base",
        "score": 1.7680000000000005,
        "description": "CWE-41: Improper Resolution of Path Equivalence...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "120",
        "name": "Buffer Copy without Checking Size of Input ('Classic Buffer Overflow')",
        "abstraction": "base",
        "score": 1.7680000000000005,
        "description": "CWE-120: Buffer Copy without Checking Size of Input ('Classic Buffer Overflow')...",
        "mapping_usage": "Allowed-with-Review"
      },
      {
        "cwe_id": "123",
        "name": "Write-what-where Condition",
        "abstraction": "base",
        "score": 1.7680000000000005,
        "description": "CWE-123: Write-what-where Condition...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "364",
        "name": "Signal Handler Race Condition",
        "abstraction": "base",
        "score": 1.7550000000000001,
        "description": "CWE-364: Signal Handler Race Condition...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "833",
        "name": "Deadlock",
        "abstraction": "Base",
        "score": 1.7073675209459034,
        "description": "The product contains multiple threads or executable segments that are waiting for each other to release a necessary lock, resulting in deadlock....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "1265",
        "name": "Unintended Reentrant Invocation of Non-reentrant Code Via Nested Calls",
        "abstraction": "base",
        "score": 1.6848000000000003,
        "description": "CWE-1265: Unintended Reentrant Invocation of Non-reentrant Code Via Nested Calls...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "386",
        "name": "Symbolic Name not Mapping to Correct Object",
        "abstraction": "base",
        "score": 1.6744000000000003,
        "description": "CWE-386: Symbolic Name not Mapping to Correct Object...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "20",
        "name": "Improper Input Validation",
        "abstraction": "class",
        "score": 1.6736000000000002,
        "description": "CWE-20: Improper Input Validation...",
        "mapping_usage": "Discouraged"
      },
      {
        "cwe_id": "662",
        "name": "Improper Synchronization",
        "abstraction": "class",
        "score": 1.6736000000000002,
        "description": "CWE-662: Improper Synchronization...",
        "mapping_usage": "Discouraged"
      },
      {
        "cwe_id": "1285",
        "name": "Improper Validation of Specified Index, Position, or Offset in Input",
        "abstraction": "Base",
        "score": 1.6637753514766376,
        "description": "The product receives input that is expected to specify an index, position, or offset into an indexable resource such as a buffer or file, but it does not validate or incorrectly validates that the spe...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "770",
        "name": "Allocation of Resources Without Limits or Throttling",
        "abstraction": "Base",
        "score": 1.6074399329378024,
        "description": "The product allocates a reusable resource or group of resources on behalf of an actor without imposing any restrictions on the size or number of resources that can be allocated, in violation of the in...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "609",
        "name": "Double-Checked Locking",
        "abstraction": "base",
        "score": 1.5912000000000004,
        "description": "CWE-609: Double-Checked Locking...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "908",
        "name": "Use of Uninitialized Resource",
        "abstraction": "Base",
        "score": 1.5470103928605408,
        "description": "The product uses or accesses a resource that has not been initialized....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "476",
        "name": "NULL Pointer Dereference",
        "abstraction": "Base",
        "score": 1.5376468835805865,
        "description": "The product dereferences a pointer that it expects to be valid but is NULL....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "789",
        "name": "Memory Allocation with Excessive Size Value",
        "abstraction": "Variant",
        "score": 1.530180494158122,
        "description": "The product allocates memory based on an untrusted, large size value, but it does not ensure that the size is within expected limits, allowing arbitrary amounts of memory to be allocated....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "415",
        "name": "Double Free",
        "abstraction": "variant",
        "score": 1.4784000000000002,
        "description": "CWE-415: Double Free...",
        "mapping_usage": "Allowed"
      }
    ],
    "dense": [
      {
        "cwe_id": "667",
        "name": "Improper Locking",
        "abstraction": "Class",
        "score": 0.5651034869599106,
        "description": "The product does not properly acquire or release a lock on a resource, leading to unexpected resource state changes and behaviors....",
        "mapping_usage": "Allowed-with-Review"
      },
      {
        "cwe_id": "362",
        "name": "Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')",
        "abstraction": "Class",
        "score": 0.5484167176753107,
        "description": "The product contains a concurrent code sequence that requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code ...",
        "mapping_usage": "Allowed-with-Review"
      },
      {
        "cwe_id": "909",
        "name": "Missing Initialization of Resource",
        "abstraction": "Class",
        "score": 0.535335128142618,
        "description": "The product does not initialize a critical resource....",
        "mapping_usage": "Allowed-with-Review"
      },
      {
        "cwe_id": "1285",
        "name": "Improper Validation of Specified Index, Position, or Offset in Input",
        "abstraction": "Base",
        "score": 0.5144630577729755,
        "description": "The product receives input that is expected to specify an index, position, or offset into an indexable resource such as a buffer or file, but it does not validate or incorrectly validates that the spe...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "833",
        "name": "Deadlock",
        "abstraction": "Base",
        "score": 0.5123207989428353,
        "description": "The product contains multiple threads or executable segments that are waiting for each other to release a necessary lock, resulting in deadlock....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "367",
        "name": "Time-of-check Time-of-use (TOCTOU) Race Condition",
        "abstraction": "Base",
        "score": 0.5092346368349361,
        "description": "The product checks the state of a resource before using that resource, but the resource's state can change between the check and the use in a way that invalidates the results of the check. This can ca...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "1284",
        "name": "Improper Validation of Specified Quantity in Input",
        "abstraction": "Base",
        "score": 0.5048075208517817,
        "description": "The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "908",
        "name": "Use of Uninitialized Resource",
        "abstraction": "Base",
        "score": 0.5032586299771374,
        "description": "The product uses or accesses a resource that has not been initialized....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "119",
        "name": "Improper Restriction of Operations within the Bounds of a Memory Buffer",
        "abstraction": "Class",
        "score": 0.499930125253526,
        "description": "The product performs operations on a memory buffer, but it reads from or writes to a memory location outside the buffer's intended boundary. This may result in read or write operations on unexpected m...",
        "mapping_usage": "Discouraged"
      },
      {
        "cwe_id": "835",
        "name": "Loop with Unreachable Exit Condition ('Infinite Loop')",
        "abstraction": "Base",
        "score": 0.495676224862143,
        "description": "The product contains an iteration or loop with an exit condition that cannot be reached, i.e., an infinite loop....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "126",
        "name": "Buffer Over-read",
        "abstraction": "Variant",
        "score": 0.4945523477165717,
        "description": "The product reads from a buffer using buffer access mechanisms such as indexes or pointers that reference memory locations after the targeted buffer....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "125",
        "name": "Out-of-bounds Read",
        "abstraction": "Base",
        "score": 0.4883119152570632,
        "description": "The product reads data past the end, or before the beginning, of the intended buffer....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "191",
        "name": "Integer Underflow (Wrap or Wraparound)",
        "abstraction": "Base",
        "score": 0.48696959159544423,
        "description": "The product subtracts one value from another, such that the result is less than the minimum allowable integer value, which produces a value that is not equal to the correct result....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "190",
        "name": "Integer Overflow or Wraparound",
        "abstraction": "Base",
        "score": 0.486473091771688,
        "description": "The product performs a calculation that can\n         produce an integer overflow or wraparound when the logic\n         assumes that the resulting value will always be larger than\n         the original...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "401",
        "name": "Missing Release of Memory after Effective Lifetime",
        "abstraction": "Variant",
        "score": 0.4859920401118596,
        "description": "The product does not sufficiently track and release allocated memory after it has been used, which slowly consumes remaining memory....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "413",
        "name": "Improper Resource Locking",
        "abstraction": "Base",
        "score": 0.48437360821752345,
        "description": "The product does not lock or does not correctly lock a resource when the product must have exclusive access to the resource....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "366",
        "name": "Race Condition within a Thread",
        "abstraction": "Base",
        "score": 0.48410840778880215,
        "description": "If two threads of execution use a resource simultaneously, there exists the possibility that resources may be used while invalid, in turn making the state of execution undefined....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "131",
        "name": "Incorrect Calculation of Buffer Size",
        "abstraction": "Base",
        "score": 0.481736798750655,
        "description": "The product does not correctly calculate the size to be used when allocating a buffer, which could lead to a buffer overflow....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "416",
        "name": "Use After Free",
        "abstraction": "Variant",
        "score": 0.48147395937292464,
        "description": "The product reuses or references memory after it has been freed. At some point afterward, the memory may be allocated again and saved in another pointer, while the original pointer references a locati...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "122",
        "name": "Heap-based Buffer Overflow",
        "abstraction": "Variant",
        "score": 0.48021114691812405,
        "description": "A heap overflow condition is a buffer overflow, where the buffer that can be overwritten is allocated in the heap portion of memory, generally meaning that the buffer was allocated using a routine suc...",
        "mapping_usage": "Allowed"
      }
    ],
    "sparse": [
      {
        "cwe_id": "667",
        "name": "Improper Locking",
        "abstraction": "Class",
        "score": 248.55489821396043,
        "description": "The product does not properly acquire or release a lock on a resource, leading to unexpected resource state changes and behaviors....",
        "mapping_usage": "Allowed-with-Review"
      },
      {
        "cwe_id": "833",
        "name": "Deadlock",
        "abstraction": "Base",
        "score": 217.09955855731548,
        "description": "The product contains multiple threads or executable segments that are waiting for each other to release a necessary lock, resulting in deadlock....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "1390",
        "name": "Weak Authentication",
        "abstraction": "Class",
        "score": 164.8948080397115,
        "description": "The product uses an authentication mechanism to restrict access to specific users or identities, but the mechanism does not sufficiently prove that the claimed identity is correct....",
        "mapping_usage": "Allowed-with-Review"
      },
      {
        "cwe_id": "319",
        "name": "Cleartext Transmission of Sensitive Information",
        "abstraction": "Base",
        "score": 162.20169470175927,
        "description": "The product transmits sensitive or security-critical data in cleartext in a communication channel that can be sniffed by unauthorized actors....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "770",
        "name": "Allocation of Resources Without Limits or Throttling",
        "abstraction": "Base",
        "score": 159.29813945263516,
        "description": "The product allocates a reusable resource or group of resources on behalf of an actor without imposing any restrictions on the size or number of resources that can be allocated, in violation of the in...",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "674",
        "name": "Uncontrolled Recursion",
        "abstraction": "Class",
        "score": 158.54112960371936,
        "description": "The product does not properly control the amount of recursion that takes place,  consuming excessive resources, such as allocated memory or the program stack....",
        "mapping_usage": "Allowed-with-Review"
      },
      {
        "cwe_id": "362",
        "name": "Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')",
        "abstraction": "Class",
        "score": 157.232354227272,
        "description": "The product contains a concurrent code sequence that requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code ...",
        "mapping_usage": "Allowed-with-Review"
      },
      {
        "cwe_id": "401",
        "name": "Missing Release of Memory after Effective Lifetime",
        "abstraction": "Variant",
        "score": 156.58345598366768,
        "description": "The product does not sufficiently track and release allocated memory after it has been used, which slowly consumes remaining memory....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "835",
        "name": "Loop with Unreachable Exit Condition ('Infinite Loop')",
        "abstraction": "Base",
        "score": 149.8848331781388,
        "description": "The product contains an iteration or loop with an exit condition that cannot be reached, i.e., an infinite loop....",
        "mapping_usage": "Allowed"
      },
      {
        "cwe_id": "451",
        "name": "User Interface (UI) Misrepresentation of Critical Information",
        "abstraction": "Class",
        "score": 149.8720335145424,
        "description": "The user interface (UI) does not properly represent critical information to the user, allowing the information - or its source - to be obscured or spoofed. This is often a component in phishing attack...",
        "mapping_usage": "Allowed-with-Review"
      }
    ]
  },
  "score_statistics": {
    "dense": {
      "min": 0.48021114691812405,
      "max": 0.5651034869599106,
      "mean": 0.5021374617386916,
      "median": 0.4951142862893574,
      "count": 20
    },
    "sparse": {
      "min": 149.8720335145424,
      "max": 248.55489821396043,
      "mean": 172.4162905472722,
      "median": 158.91963452817726,
      "count": 10
    },
    "graph": {
      "min": 1.4784000000000002,
      "max": 2.3400000000000003,
      "mean": 1.7247390287979798,
      "median": 1.6796000000000002,
      "count": 20
    }
  }
}