# Vulnerability Information: CVE-2024-40920

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved net bridge mst fix suspicious rcu usage in br_mst_set_state I converted br_mst_set_state to RCU to avoid a vlan **use-after-free** but forgot to change the vlan group dereference helper. Switch to vlan group RCU deref helper to fix the suspicious rcu usage warning.

### Vulnerability Description Key Phrases
- **weakness:** **use-after-free**
- **product:** Linux kernel
- **component:** net bridge

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root Cause:**
The root cause of the vulnerability is the incorrect dereferencing of the VLAN group in the `br_mst_set_state` function after converting it to use RCU (Read-Copy-Update) for avoiding a use-after-free vulnerability. The original fix used `nbp_vlan_group(p)` which was not RCU-safe, and should have been `nbp_vlan_group_rcu(p)`.

**Weaknesses/Vulnerabilities:**
- **Suspicious RCU usage:** The primary weakness is using `nbp_vlan_group(p)` instead of `nbp_vlan_group_rcu(p)` after `br_mst_set_state` was converted to use RCU. This creates a race condition where the VLAN group could be freed while `br_mst_set_state` is accessing it.

**Impact of Exploitation:**
- **Use-after-free:** If the VLAN group is freed while still being accessed in `br_mst_set_state`, it can lead to a use-after-free condition, potentially leading to a crash, denial of service, or arbitrary code execution if exploited.

**Attack Vectors:**
- The vulnerability can be triggered through operations that involve setting the state of a bridge port using Multiple Spanning Tree (MST) protocol.

**Required Attacker Capabilities/Position:**
- The attacker would need the ability to trigger the `br_mst_set_state` function in a way that would race with the freeing of the associated VLAN group. This likely requires control over the network configuration of the bridge and its associated VLANs

**Additional Details:**
- The vulnerability was identified by syzbot.
- The fix replaces the non-RCU safe `nbp_vlan_group(p)` with `nbp_vlan_group_rcu(p)`.
- The fix is related to a previous fix for a VLAN use-after-free.
- The issue is in the Linux kernel's networking bridge module.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 416 | Use After Free | Variant | Allowed | alternate_terms | 1.000 |
| 2 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.233 |
| 3 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.231 |
| 4 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.229 |
| 5 | 911 | Improper Update of Reference Count | Base | Allowed | sparse | 0.222 |
| 6 | 476 | NULL Pointer Dereference | Base | Allowed | sparse | 0.211 |
| 7 | 908 | Use of Uninitialized Resource | Base | Allowed | sparse | 0.208 |
| 8 | 252 | Unchecked Return Value | Base | Allowed | sparse | 0.206 |
| 9 | 1317 | Improper Access Control in Fabric Bridge | Base | Allowed | dense | 0.488 |
| 10 | 364 | Signal Handler Race Condition | Base | Allowed | graph | 0.003 |

