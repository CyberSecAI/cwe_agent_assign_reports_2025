{
  "query": "In the Linux kernel, the following vulnerability has been resolved rxrpc, afs Fix peer hash locking vs RCU callback In its address list, afs now retains pointers to and refs on one or more rxrpc_peer objects. The address list is freed under RCU and at this time, it puts the refs on those peers. Now, when an rxrpc_peer object runs out of refs, it gets removed from the peer hash table and, for that, rxrpc has to take a spinlock. However, it is now being called from afss RCU cleanup, which takes place in BH context - but it is just taking an ordinary spinlock. The put may also be called from non-BH context, and so there exists the possibility of deadlock if the BH-based RCU cleanup happens whilst the hash spinlock is held. This led to the attached lockdep complaint. Fix this by changing spinlocks of rxnet->peer_hash_lock back to BH-disabling locks. ================================ WARNING inconsistent lock state 6.13.0-rc5-build2+ #1223 Tainted G E -------------------------------- inconsistent {SOFTIRQ-ON-W} -> {IN-SOFTIRQ-W} usage. swapper/1/0 [HC0[0]SC1[1]HE1SE0] takes ffff88810babe228 (&rxnet->peer_hash_lock){+.?.}-{33}, at rxrpc_put_peer+0xcb/0x180 {SOFTIRQ-ON-W} state was registered at mark_usage+0x164/0x180 __lock_acquire+0x544/0x990 lock_acquire.part.0+0x103/0x280 _raw_spin_lock+0x2f/0x40 rxrpc_peer_keepalive_worker+0x144/0x440 process_one_work+0x486/0x7c0 process_scheduled_works+0x73/0x90 worker_thread+0x1c8/0x2a0 kthread+0x19b/0x1b0 ret_from_fork+0x24/0x40 ret_from_fork_asm+0x1a/0x30 irq event stamp 972402 hardirqs last enabled at (972402) [] _raw_spin_unlock_irqrestore+0x2e/0x50 hardirqs last disabled at (972401) [] _raw_spin_lock_irqsave+0x18/0x60 softirqs last enabled at (972300) [] handle_softirqs+0x3ee/0x430 softirqs last disabled at (972313) [] __irq_exit_rcu+0x44/0x110 other info that might help us debug this Possible unsafe locking scenario CPU0 ---- lock(&rxnet->peer_hash_lock) lock(&rxnet->peer_hash_lock) *** DEADLOCK *** 1 lock held by swapper/1/0 #0 ffffffff83576be0 (rcu_callback){....}-{00}, at rcu_lock_acquire+0x7/0x30 stack backtrace CPU 1 UID 0 PID 0 Comm swapper/1 Tainted G E 6.13.0-rc5-build2+ #1223 Tainted [E]=UNSIGNED_MODULE Hardware name ASUS All Series/H97-PLUS, BIOS 2306 10/09/2014 Call Trace dump_stack_lvl+0x57/0x80 print_usage_bug.part.0+0x227/0x240 valid_state+0x53/0x70 mark_lock_irq+0xa5/0x2f0 mark_lock+0xf7/0x170 mark_usage+0xe1/0x180 __lock_acquire+0x544/0x990 lock_acquire.part.0+0x103/0x280 _raw_spin_lock+0x2f/0x40 rxrpc_put_peer+0xcb/0x180 afs_free_addrlist+0x46/0x90 [kafs] rcu_do_batch+0x2d2/0x640 rcu_core+0x2f7/0x350 handle_softirqs+0x1ee/0x430 __irq_exit_rcu+0x44/0x110 irq_exit_rcu+0xa/0x30 sysvec_apic_timer_interrupt+0x7f/0xa0",
  "count": 20,
  "results": [
    {
      "cwe_id": "667",
      "name": "Improper Locking",
      "abstraction": "Class",
      "score": 0.5347219734511091,
      "original_score": 0.5347219734511091,
      "mapping_usage": "Allowed-with-Review"
    },
    {
      "cwe_id": "833",
      "name": "Deadlock",
      "abstraction": "Base",
      "score": 0.5240922281178755,
      "original_score": 0.5240922281178755,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "413",
      "name": "Improper Resource Locking",
      "abstraction": "Base",
      "score": 0.5231199103408231,
      "original_score": 0.5231199103408231,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "362",
      "name": "Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')",
      "abstraction": "Class",
      "score": 0.5118779839905366,
      "original_score": 0.5118779839905366,
      "mapping_usage": "Allowed-with-Review"
    },
    {
      "cwe_id": "401",
      "name": "Missing Release of Memory after Effective Lifetime",
      "abstraction": "Variant",
      "score": 0.5019857437395033,
      "original_score": 0.5019857437395033,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "909",
      "name": "Missing Initialization of Resource",
      "abstraction": "Class",
      "score": 0.49547726707392287,
      "original_score": 0.49547726707392287,
      "mapping_usage": "Allowed-with-Review"
    },
    {
      "cwe_id": "911",
      "name": "Improper Update of Reference Count",
      "abstraction": "Base",
      "score": 0.49508777778323787,
      "original_score": 0.49508777778323787,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "1285",
      "name": "Improper Validation of Specified Index, Position, or Offset in Input",
      "abstraction": "Base",
      "score": 0.4901208978432003,
      "original_score": 0.4901208978432003,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "835",
      "name": "Loop with Unreachable Exit Condition ('Infinite Loop')",
      "abstraction": "Base",
      "score": 0.4867061479549174,
      "original_score": 0.4867061479549174,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "770",
      "name": "Allocation of Resources Without Limits or Throttling",
      "abstraction": "Base",
      "score": 0.4763320846942297,
      "original_score": 0.4763320846942297,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "191",
      "name": "Integer Underflow (Wrap or Wraparound)",
      "abstraction": "Base",
      "score": 0.47579345004450513,
      "original_score": 0.47579345004450513,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "908",
      "name": "Use of Uninitialized Resource",
      "abstraction": "Base",
      "score": 0.4735909304273401,
      "original_score": 0.4735909304273401,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "366",
      "name": "Race Condition within a Thread",
      "abstraction": "Base",
      "score": 0.46949343265634974,
      "original_score": 0.46949343265634974,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "1284",
      "name": "Improper Validation of Specified Quantity in Input",
      "abstraction": "Base",
      "score": 0.46925169327315625,
      "original_score": 0.46925169327315625,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "606",
      "name": "Unchecked Input for Loop Condition",
      "abstraction": "Base",
      "score": 0.4690222076270588,
      "original_score": 0.4690222076270588,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "126",
      "name": "Buffer Over-read",
      "abstraction": "Variant",
      "score": 0.4660826468198386,
      "original_score": 0.4660826468198386,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "119",
      "name": "Improper Restriction of Operations within the Bounds of a Memory Buffer",
      "abstraction": "Class",
      "score": 0.4647388995195749,
      "original_score": 0.4647388995195749,
      "mapping_usage": "Discouraged"
    },
    {
      "cwe_id": "121",
      "name": "Stack-based Buffer Overflow",
      "abstraction": "Variant",
      "score": 0.4614641398594264,
      "original_score": 0.4614641398594264,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "476",
      "name": "NULL Pointer Dereference",
      "abstraction": "Base",
      "score": 0.4594645979184297,
      "original_score": 0.4594645979184297,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "190",
      "name": "Integer Overflow or Wraparound",
      "abstraction": "Base",
      "score": 0.4585721647047103,
      "original_score": 0.4585721647047103,
      "mapping_usage": "Allowed"
    }
  ],
  "statistics": {
    "min": 0.4585721647047103,
    "max": 0.5347219734511091,
    "mean": 0.4853498088919873,
    "median": 0.4760627673693674,
    "count": 20
  }
}