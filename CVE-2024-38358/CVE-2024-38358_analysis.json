{
  "cve_id": "CVE-2024-38358",
  "description": "Wasmer is a web assembly (wasm) Runtime supporting WASIX, WASI and Emscripten. If the preopened directory has a symlink pointing outside, WASI programs can traverse the symlink and access host filesystem if the caller sets both `oflagscreat` and `rightsfd_write`. Programs can also crash the runtime by creating a symlink pointing outside with `path_symlink` and `path_open`ing the link. This issue has been addressed in commit `b9483d022` which has been included in release version 4.3.2. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
  "key_phrases": {
    "rootcause": "",
    "weakness": "",
    "impact": "access host filesystem",
    "vector": "symlink pointing outside",
    "attacker": "WASI programs",
    "product": "Wasmer",
    "version": "before 4.3.2",
    "component": ""
  },
  "reference_content": "Based on the provided information, here's an analysis of CVE-2024-38358:\n\n**Root cause of vulnerability:**\n- The vulnerability stems from insufficient checks when handling symlinks within the WASI filesystem sandbox in Wasmer. Specifically, when a preopened directory contains a symlink pointing outside the sandbox, the `path_open` syscall, when used with both `oflags::creat` and `rights::fd_write`, can be exploited to traverse the symlink, bypassing the intended security restrictions.\n\n**Weaknesses/vulnerabilities present:**\n- **Symlink Traversal:** The primary weakness is the ability to traverse symlinks that lead outside the designated filesystem sandbox. This violates the principle of least privilege and allows access to potentially sensitive areas of the host filesystem.\n- **Insufficient Input Validation:** The code lacks proper validation to ensure that symlink targets remain within the boundaries of the sandboxed file system.\n\n**Impact of exploitation:**\n- **Filesystem Access:** A malicious WASI program can read and write to files outside the sandboxed directory.\n- **Potential for Data Breach:**  By accessing arbitrary files on the host system, attackers could potentially steal sensitive data.\n- **Denial of Service:** Attackers could potentially crash the runtime by creating symlinks that point outside the sandbox.\n- **Sandbox Escape:** This bypasses the security provided by the filesystem sandbox.\n\n**Attack vectors:**\n- A malicious WASI program is required to exploit this vulnerability.\n- The program must call the `path_open` syscall with specific flags (`oflags::creat` and `rights::fd_write`).\n- The program must attempt to open a file through a symlink that points outside the sandboxed directory.\n\n**Required attacker capabilities/position:**\n- The attacker needs to be able to execute a WASI program within a Wasmer environment.\n- The attacker needs to have the ability to control the program's behavior to use the vulnerable `path_open` syscall.\n- The attacker must be aware of the symlink structure within the preopened directory.\n\n**Additional Details:**\n- The vulnerability was found by `yagehu`.\n- The affected versions are Wasmer versions 4.3.1 and earlier.\n- No patch is mentioned, indicating that the vulnerability might have been fixed in later versions.\n- The provided PoC demonstrates how a simple Rust program compiled to WASI can exploit the vulnerability by reading from a file outside the sandbox.\n- Wasmtime, another WebAssembly runtime, is mentioned as being able to successfully block this type of call, indicating that this is a Wasmer specific issue.",
  "similar_info": {
    "cwe_distribution": {},
    "cwe_consensus": "",
    "similarity_stats": {
      "thresholds": [],
      "total_samples_by_threshold": {},
      "top_cwes_by_threshold": {}
    }
  },
  "similarity_summary": {
    "consensus_cwe": "",
    "top_cwes": [],
    "confidence_levels": {},
    "total_samples": 0
  },
  "analysis": "# Summary\n| CWE ID  | CWE Name                                                                        | Confidence | CWE Abstraction Level | CWE Vulnerability Mapping Label | CWE-Vulnerability Mapping Notes |\n| :-------- | :------------------------------------------------------------------------------ | :--------- | :---------------------- | :------------------------------ | :------------------------------ |\n| CWE-59    | Improper Link Resolution Before File Access ('Link Following')                 | 0.9        | Base                    | Primary                         | Allowed                         |\n| CWE-367   | Time-of-check Time-of-use (TOCTOU) Race Condition                               | 0.7        | Base                    | Secondary                       | Allowed                         |\n| CWE-61    | UNIX Symbolic Link (Symlink) Following                                        | 0.6        | Compound                | Secondary                       | Allowed                         |\n\n## Evidence and Confidence\n\n*   **Confidence Score:** 0.8\n*   **Evidence Strength:** HIGH\n\n## Relationship Analysis\nThe primary weakness is CWE-59, which describes the **improper link resolution** that allows access to unintended resources. This is a Base-level CWE, providing a specific and actionable description of the vulnerability. CWE-367 (TOCTOU) is considered as a secondary factor because a race condition could potentially exacerbate the symlink issue, but the core problem is still the **improper link resolution**. CWE-61 is a compound of multiple weaknesses that must occur simultaneously and it is attack-oriented.\n\n```mermaid\ngraph TD\n    cwe59[\"CWE-59: Improper Link Resolution Before File Access\"]\n    cwe367[\"CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition\"]\n    cwe61[\"CWE-61: UNIX Symbolic Link (Symlink) Following\"]\n\n    cwe363[\"CWE-363: Race Condition Enabling Link Following\"]\n    cwe363 -->|CANPRECEDE| cwe59\n    cwe363 -->|CHILDOF| cwe367\n\n    cwe59 -->|PARENTOF| cwe61\n    cwe367 -->|PARENTOF| cwe363\n\n\n    classDef primary fill:#f96,stroke:#333,stroke-width:2px\n    classDef secondary fill:#69f,stroke:#333\n    classDef tertiary fill:#9e9,stroke:#333\n    class cwe59 primary\n    class cwe367,cwe61 secondary\n```\n\n## Vulnerability Chain\nThe vulnerability chain starts with **insufficient checks** on symlinks, leading to **improper link resolution**, which allows attackers to **access the host filesystem**. The root cause is the **improper handling of symlinks**, which can be represented as CWE-59. A potential race condition (CWE-367) could be present, but the primary issue is the symlink traversal.\n\n## Summary of Analysis\nThe analysis is primarily based on the provided evidence, which indicates that the Wasmer runtime **does not properly handle symlinks** in preopened directories. This allows WASI programs to traverse these symlinks and access the host filesystem, representing a **clear case of improper link resolution**.\n\nThe selection of CWE-59 is based on its direct relevance to the vulnerability description, which mentions that \"WASI programs can traverse the symlink and access host filesystem.\" This aligns with the CWE's description of **improper prevention of filenames identifying links that resolve to unintended resources**.\n\nCWE-367 (TOCTOU) is considered due to the potential for a race condition to exacerbate the symlink issue. However, the core problem remains the **improper link resolution**, making CWE-59 the primary CWE. CWE-61 is a compound of multiple weaknesses and it is attack-oriented.\n\nThe selected CWEs are at the optimal level of specificity, with CWE-59 being a Base-level CWE that directly addresses the **improper link resolution** vulnerability.\n\nRelevant CWE Information:\n\n# Enhanced Context (25 CWEs)\nThe following CWEs were identified as potentially relevant to this vulnerability:\n\n## CWE-59: Improper Link Resolution Before File Access ('Link Following')\n**Abstraction Level**: Base\n**Similarity Score**: 0.75\n**Source**: dense\n\n**Description**:\nThe product attempts to access a file based on the filename, but it **does not properly prevent** that filename from identifying a link or shortcut that resolves to an unintended resource.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.\n\n## CWE-61: UNIX Symbolic Link (Symlink) Following\n**Abstraction Level**: Compound\n**Similarity Score**: 0.75\n**Source**: dense\n\n**Description**:\nThe product, when opening a file or directory, **does not sufficiently account** for when the file is a symbolic link that resolves to a target outside of the intended control sphere. This could allow an attacker to cause the product to operate on unauthorized files.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This is a well-known Composite of multiple weaknesses that must all occur simultaneously, although it is attack-oriented in nature.\n\n## CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition\n**Abstraction Level**: Base\n**Similarity Score**: 0.72\n**Source**: dense\n\n**Description**:\nThe product checks the state of a resource before using that resource, but the resource's state can change between the check and the use in a way that invalidates the results of the check. This can cause the product to perform invalid actions when the resource is in an unexpected state.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.\n\n## CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')\n**Abstraction Level**: Base\n**Similarity Score**: 1081.62\n**Source**: sparse\n\n**Description**:\nThe product uses external input to construct a pathname that is intended to identify a file or directory that is located underneath a restricted parent directory, but the product **does not properly neutralize** special elements within the pathname that can cause the pathname to resolve to a location that is outside of the restricted directory.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.\n\nCWE-22 (Improper Limitation of a Pathname to a Restricted Directory 'Path Traversal') was considered but not selected as the primary CWE because, although path traversal is involved, the root cause is the **improper handling of symlinks**, which allows the traversal to occur in the first place.\n\nCWE-386 (Symbolic Name not Mapping to Correct Object) was considered but not selected because it is too abstract and doesn't capture the specific issue of **improper link resolution** leading to filesystem access.\n\nCWE-476 (NULL Pointer Dereference) was considered but not selected as it doesn't appear to be relevant to the vulnerability description.",
  "analysis_with_relationships": "# Summary\n| CWE ID  | CWE Name                                                                        | Confidence | CWE Abstraction Level | CWE Vulnerability Mapping Label | CWE-Vulnerability Mapping Notes |\n| :-------- | :------------------------------------------------------------------------------ | :--------- | :---------------------- | :------------------------------ | :------------------------------ |\n| CWE-59    | Improper Link Resolution Before File Access ('Link Following')                 | 0.9        | Base                    | Primary                         | Allowed                         |\n| CWE-367   | Time-of-check Time-of-use (TOCTOU) Race Condition                               | 0.7        | Base                    | Secondary                       | Allowed                         |\n| CWE-61    | UNIX Symbolic Link (Symlink) Following                                        | 0.6        | Compound                | Secondary                       | Allowed                         |\n\n## Evidence and Confidence\n\n*   **Confidence Score:** 0.8\n*   **Evidence Strength:** HIGH\n\n## Relationship Analysis\nThe primary weakness is CWE-59, which describes the **improper link resolution** that allows access to unintended resources. This is a Base-level CWE, providing a specific and actionable description of the vulnerability. CWE-367 (TOCTOU) is considered as a secondary factor because a race condition could potentially exacerbate the symlink issue, but the core problem is still the **improper link resolution**. CWE-61 is a compound of multiple weaknesses that must occur simultaneously and it is attack-oriented.\n\n```mermaid\ngraph TD\n    cwe59[\"CWE-59: Improper Link Resolution Before File Access\"]\n    cwe367[\"CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition\"]\n    cwe61[\"CWE-61: UNIX Symbolic Link (Symlink) Following\"]\n\n    cwe363[\"CWE-363: Race Condition Enabling Link Following\"]\n    cwe363 -->|CANPRECEDE| cwe59\n    cwe363 -->|CHILDOF| cwe367\n\n    cwe59 -->|PARENTOF| cwe61\n    cwe367 -->|PARENTOF| cwe363\n\n\n    classDef primary fill:#f96,stroke:#333,stroke-width:2px\n    classDef secondary fill:#69f,stroke:#333\n    classDef tertiary fill:#9e9,stroke:#333\n    class cwe59 primary\n    class cwe367,cwe61 secondary\n```\n\n## Vulnerability Chain\nThe vulnerability chain starts with **insufficient checks** on symlinks, leading to **improper link resolution**, which allows attackers to **access the host filesystem**. The root cause is the **improper handling of symlinks**, which can be represented as CWE-59. A potential race condition (CWE-367) could be present, but the primary issue is the symlink traversal.\n\n## Summary of Analysis\nThe analysis is primarily based on the provided evidence, which indicates that the Wasmer runtime **does not properly handle symlinks** in preopened directories. This allows WASI programs to traverse these symlinks and access the host filesystem, representing a **clear case of improper link resolution**.\n\nThe selection of CWE-59 is based on its direct relevance to the vulnerability description, which mentions that \"WASI programs can traverse the symlink and access host filesystem.\" This aligns with the CWE's description of **improper prevention of filenames identifying links that resolve to unintended resources**.\n\nCWE-367 (TOCTOU) is considered due to the potential for a race condition to exacerbate the symlink issue. However, the core problem remains the **improper link resolution**, making CWE-59 the primary CWE. CWE-61 is a compound of multiple weaknesses and it is attack-oriented.\n\nThe selected CWEs are at the optimal level of specificity, with CWE-59 being a Base-level CWE that directly addresses the **improper link resolution** vulnerability.\n\nRelevant CWE Information:\n\n# Enhanced Context (25 CWEs)\nThe following CWEs were identified as potentially relevant to this vulnerability:\n\n## CWE-59: Improper Link Resolution Before File Access ('Link Following')\n**Abstraction Level**: Base\n**Similarity Score**: 0.75\n**Source**: dense\n\n**Description**:\nThe product attempts to access a file based on the filename, but it **does not properly prevent** that filename from identifying a link or shortcut that resolves to an unintended resource.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.\n\n## CWE-61: UNIX Symbolic Link (Symlink) Following\n**Abstraction Level**: Compound\n**Similarity Score**: 0.75\n**Source**: dense\n\n**Description**:\nThe product, when opening a file or directory, **does not sufficiently account** for when the file is a symbolic link that resolves to a target outside of the intended control sphere. This could allow an attacker to cause the product to operate on unauthorized files.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This is a well-known Composite of multiple weaknesses that must all occur simultaneously, although it is attack-oriented in nature.\n\n## CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition\n**Abstraction Level**: Base\n**Similarity Score**: 0.72\n**Source**: dense\n\n**Description**:\nThe product checks the state of a resource before using that resource, but the resource's state can change between the check and the use in a way that invalidates the results of the check. This can cause the product to perform invalid actions when the resource is in an unexpected state.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.\n\n## CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')\n**Abstraction Level**: Base\n**Similarity Score**: 1081.62\n**Source**: sparse\n\n**Description**:\nThe product uses external input to construct a pathname that is intended to identify a file or directory that is located underneath a restricted parent directory, but the product **does not properly neutralize** special elements within the pathname that can cause the pathname to resolve to a location that is outside of the restricted directory.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.\n\nCWE-22 (Improper Limitation of a Pathname to a Restricted Directory 'Path Traversal') was considered but not selected as the primary CWE because, although path traversal is involved, the root cause is the **improper handling of symlinks**, which allows the traversal to occur in the first place.\n\nCWE-386 (Symbolic Name not Mapping to Correct Object) was considered but not selected because it is too abstract and doesn't capture the specific issue of **improper link resolution** leading to filesystem access.\n\nCWE-476 (NULL Pointer Dereference) was considered but not selected as it doesn't appear to be relevant to the vulnerability description.\n\n\n## CWE Relationship Analysis\n\nCurrent CWEs represent these abstraction levels: .\n\n\n### Vulnerability Chain Analysis\n\n**Chain starting from CWE-476:**\n- 476 (NULL Pointer Dereference) - ROOT\n\n\n**Chain starting from CWE-22:**\n- 22 (Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')) - ROOT\n\n\n\n### CWE Relationship Diagram\n\n```mermaid\ngraph TD\n    classDef primary fill:#f96,stroke:#333,stroke-width:2px\n    classDef secondary fill:#69f,stroke:#333\n    classDef tertiary fill:#9e9,stroke:#333\n```",
  "criticism": "",
  "resolution": "",
  "relevant_cwes": [
    {
      "metadata": {
        "doc_id": "59",
        "name": "Improper Link Resolution Before File Access ('Link Following')",
        "source": "sparse"
      },
      "similarity": 169.90003899816395
    },
    {
      "metadata": {
        "doc_id": "61",
        "name": "UNIX Symbolic Link (Symlink) Following",
        "source": "sparse"
      },
      "similarity": 165.73046475656503
    },
    {
      "metadata": {
        "doc_id": "367",
        "name": "Time-of-check Time-of-use (TOCTOU) Race Condition",
        "source": "sparse"
      },
      "similarity": 147.83263288011776
    },
    {
      "metadata": {
        "doc_id": "22",
        "name": "Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
        "source": "sparse"
      },
      "similarity": 147.58948023495452
    },
    {
      "metadata": {
        "doc_id": "277",
        "name": "Insecure Inherited Permissions",
        "source": "sparse"
      },
      "similarity": 141.19047354438592
    },
    {
      "metadata": {
        "doc_id": "125",
        "name": "Out-of-bounds Read",
        "source": "sparse"
      },
      "similarity": 138.0181966366765
    },
    {
      "metadata": {
        "doc_id": "476",
        "name": "NULL Pointer Dereference",
        "source": "sparse"
      },
      "similarity": 137.40609541284547
    },
    {
      "metadata": {
        "doc_id": "427",
        "name": "Uncontrolled Search Path Element",
        "source": "sparse"
      },
      "similarity": 136.3844981881718
    },
    {
      "metadata": {
        "doc_id": "409",
        "name": "Improper Handling of Highly Compressed Data (Data Amplification)",
        "type": "Base",
        "original_content": "The product does not handle or incorrectly handles a compressed input with a very high compression ratio that produces a large output.",
        "source": "dense",
        "mapping_notes": {
          "usage": "Allowed",
          "rationale": "This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.",
          "comments": "Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.",
          "reasons": [
            "Acceptable-Use"
          ]
        },
        "score_info": {
          "retrievers": [
            "dense",
            "graph"
          ],
          "retriever_count": 2,
          "normalized_scores": {
            "dense": 0.491361208463461,
            "graph": 1.4750774272447431
          }
        }
      },
      "similarity": 0.491361208463461
    },
    {
      "doc_id": "386",
      "text": "CWE-386: Symbolic Name not Mapping to Correct Object",
      "score": 2.7950000000000004,
      "metadata": {
        "doc_id": "386",
        "name": "Symbolic Name not Mapping to Correct Object",
        "type": "base",
        "original_content": "CWE-386: Symbolic Name not Mapping to Correct Object",
        "relationships": [
          {
            "source_id": "386",
            "target_id": "61",
            "label": "REQUIREDBY",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "386",
            "target_id": "486",
            "label": "PEEROF",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "386",
            "target_id": "610",
            "label": "PEEROF",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "386",
            "target_id": "367",
            "label": "PEEROF",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "386",
            "target_id": "706",
            "label": "CHILDOF",
            "properties": {
              "ordinal": "Primary",
              "view_id": "1000"
            }
          },
          {
            "source_id": "706",
            "target_id": "386",
            "label": "PARENTOF",
            "properties": {
              "ordinal": "Primary",
              "view_id": "1000"
            }
          },
          {
            "source_id": "61",
            "target_id": "386",
            "label": "REQUIRES",
            "properties": {
              "view_id": "1000"
            }
          }
        ],
        "score_components": {
          "relationship_chain": 0.9,
          "sequence_path": 1.0,
          "peer_group": 0.9
        },
        "abstraction_factor": 1.3,
        "graph_path_info": {
          "path_types": [
            "relationship_chain",
            "vulnerability_sequence_forward",
            "peer_relationship"
          ],
          "best_paths": {
            "relationship_chain": {
              "path": [
                [
                  "61",
                  "386",
                  "REQUIRES"
                ]
              ],
              "score": 0.9,
              "type": "relationship_chain",
              "source": "61"
            },
            "vulnerability_sequence_forward": {
              "path": [
                [
                  "61",
                  "386",
                  "REQUIRES"
                ]
              ],
              "score": 1.0,
              "type": "vulnerability_sequence_forward",
              "source": "61"
            },
            "peer_relationship": {
              "path": [
                [
                  "386",
                  "367",
                  "PEEROF"
                ]
              ],
              "score": 0.9,
              "type": "peer_relationship",
              "source": "367"
            }
          }
        },
        "position": "after",
        "sources": [
          "graph"
        ],
        "source": "graph",
        "mapping_notes": {
          "usage": "Allowed",
          "rationale": "This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.",
          "comments": "Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.",
          "reasons": [
            "Acceptable-Use"
          ]
        },
        "score_info": {
          "retrievers": [
            "graph"
          ],
          "retriever_count": 1,
          "normalized_scores": {
            "graph": 2.7950000000000004
          }
        }
      },
      "similarity": 2.7950000000000004
    }
  ],
  "identified_cwes": {
    "analyzer": [
      "CWE-476",
      "CWE-22",
      "CWE-59",
      "CWE-363",
      "CWE-386",
      "CWE-367",
      "CWE-61"
    ],
    "critic_additional": []
  },
  "keyphrase_cwe_mapping": {}
}