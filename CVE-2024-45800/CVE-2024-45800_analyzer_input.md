# Vulnerability Information: CVE-2024-45800

## Vulnerability Description
Snappymail is an open source web-based email client. SnappyMail uses the `cleanHtml()` function to cleanup HTML and CSS in emails. Research discovered that the function has a few bugs which cause an mXSS exploit. Because the function allowed too many (invalid) HTML elements, it was possible (with incorrect markup) to trick the browser to fix the broken markup into valid markup. As a result a motivated attacker may be able to inject javascript. However, due to the default Content Security Policy the impact of the exploit is minimal. It could be possible to create an attack which leaks some data when loading images through the proxy. This way it might be possible to use the proxy to attack the local system, like with `http//localhost5000/leak`. Another attack could be to load a JavaScript attachment of the email. This is very tricky as the email must link to every possible UID as each email has a unique UID which has a value between 1 and 18446744073709551615 **v2.38.0** and up now remove unsupported HTML elements which mitigates the issue. Users are advised to upgrade. Older versions can install an extension named Security mXSS as a mitigation. This will be available at the administration area at `/?admin#/packages`. **NOTE** this extension can not fix malicious code in encrypted messages or (html) attachments as it cant manipulate the JavaScript code for this. It only protects normal message HTML.

### Vulnerability Description Key Phrases
- **rootcause:** **improper input sanitization**
- **weakness:** **cross-site scripting**
- **impact:** information disclosure
- **vector:** malicious HTML elements
- **attacker:** attackers
- **product:** Snappymail
- **version:** v2.38.0 and earlier
- **component:** cleanHtml() function

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root cause of vulnerability:**
The vulnerability lies in the `cleanHtml()` function within SnappyMail's `Html.js` file. This function is responsible for sanitizing HTML and CSS in emails. The function had bugs related to how it handled invalid HTML elements and CSS cleanup, which could be exploited to achieve mXSS. Specifically, the HTML sanitization logic allowed too many (invalid) HTML elements and, due to the attempt to fix Microsoft Outlook/Word broken HTML, introduced new issues in CSS processing.

**Weaknesses/vulnerabilities present:**
- **mXSS (Mutation Cross-Site Scripting):** The core issue is mXSS due to incorrect HTML sanitization. The sanitizer allowed the browser to "fix" broken HTML into valid markup that could be manipulated to trigger malicious behavior.
- **Inadequate CSS cleanup:** The attempt to fix broken HTML from Microsoft Outlook/Word emails created a different issue in the CSS sanitization logic, allowing for the injection of malicious CSS and HTML.
- **Allowing too many HTML elements:** The sanitizer was not strict enough in filtering out potentially dangerous HTML elements.

**Impact of exploitation:**
- **XSS:** The most direct impact is the potential for Cross-Site Scripting (XSS).  The vulnerability can lead to arbitrary JavaScript execution within the context of the user's session.
- **Data Leakage:** It could be possible to leak data when loading images through the proxy. By using a crafted URL with `http://localhost:5000/leak`, an attacker might be able to attack the local system through the proxy.
- **Loading Malicious Attachments:** Attackers can attempt to load malicious Javascript attachments by creating a link to the attachment within the HTML of the email. This is complicated by the need to know the email UID, but it is possible to leak this UID in a first email and then load the attachment in a second one.
- **Limited by CSP:** The default Content Security Policy mitigates the risk to some extent, however, XSS is still possible.

**Attack vectors:**
- **Email:** The attack vector is primarily through crafted emails containing malicious HTML and CSS.
- **HTML Sanitizer Bypass:** The primary attack vector involves exploiting the vulnerabilities within the `cleanHtml()` function to bypass the intended sanitization.

**Required attacker capabilities/position:**
- **Ability to send emails:** Attackers need to be able to send emails to a vulnerable SnappyMail user.
- **Knowledge of the Vulnerability:** The attacker needs to be aware of the specific weaknesses in the HTML sanitizer to craft a successful exploit.
- **User Interaction:** The user needs to open/view the malicious email for the exploit to be triggered.

**Additional details:**
- The provided content includes specific examples of malicious code that can trigger the vulnerability, such as the `<math>` tag example, and the CSS exploit using `<!--/style>`.
- The patched version (2.38.0) addresses the issue by removing unsupported HTML elements.
- Workarounds exist, including a "Security mXSS" extension and manual rebuilding of JavaScript.
- The vulnerability is classified as "moderate" severity.
- The fix is related to commit `cfbc47488a6b2e2ae4be484f501ee1a3485f542e` where the code was updated to use allowedTags instead of disallowedTags.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | sparse | 1.382 |
| 2 | 116 | Improper Encoding or Escaping of Output | Class | Allowed-with-Review | sparse | 1.290 |
| 3 | 138 | Improper Neutralization of Special Elements | Class | Discouraged | sparse | 1.250 |
| 4 | 1333 | Inefficient Regular Expression Complexity | Base | Allowed | sparse | 1.250 |
| 5 | 923 | Improper Restriction of Communication Channel to Intended Endpoints | Class | Allowed-with-Review | sparse | 1.249 |
| 6 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 1.231 |
| 7 | 451 | User Interface (UI) Misrepresentation of Critical Information | Class | Allowed-with-Review | sparse | 1.229 |
| 8 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 1.213 |
| 9 | 359 | Exposure of Private Personal Information to an Unauthorized Actor | Base | Allowed | dense | 0.529 |
| 10 | 117 | Improper Output Neutralization for Logs | Base | Allowed | graph | 0.003 |

