# Vulnerability Information: CVE-2024-7110

## Vulnerability Description
An issue was discovered in GitLab EE affecting all versions starting 17.0 to 17.1.6, 17.2 prior to 17.2.4, and 17.3 prior to 17.3.1 allows an attacker to execute arbitrary command in a victims pipeline through prompt injection.

### Vulnerability Description Key Phrases
- **impact:** execute arbitrary command
- **vector:** prompt injection
- **attacker:** attacker
- **product:** GitLab EE
- **version:** all versions starting 17.0 to 17.1.6, 17.2 prior to 17.2.4, and 17.3 prior to 17.3.1

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**

- The vulnerability stems from a prompt injection flaw in the "Resolve Vulnerability" feature of GitLab. This feature uses an LLM to generate code patches for reported vulnerabilities. The LLM's prompt is constructed using data from SAST (Static Application Security Testing) reports. Attackers can inject malicious instructions into the LLM prompt by crafting a malicious SAST report, specifically by manipulating the "name" field within a vulnerability identifier.

**Weaknesses/Vulnerabilities Present:**

- **Prompt Injection:** The core vulnerability is the lack of sanitization or validation of user-controlled data (from SAST reports) that is used to build the prompt for the LLM. This allows an attacker to inject arbitrary instructions into the prompt.
- **Lack of Input Sanitization:** The system does not sanitize the `name` field of the SAST report's identifier, allowing an attacker to inject arbitrary text, including malicious commands.

**Impact of Exploitation:**

- **Arbitrary Code Execution:** An attacker can inject instructions into the LLM prompt that will be included in the generated merge request and its associated pipeline. This allows them to execute arbitrary code within the context of the victim's CI pipeline.
- **Credentials Exposure:** In the example provided, the attacker injects code to print the `$CI_JOB_TOKEN` to the job log, potentially exposing sensitive information.
- **Supply Chain Attack Potential:** This could be used to compromise victim environments through a manipulated SAST report, creating a supply chain vulnerability.

**Attack Vectors:**

- **Malicious SAST Report:** The primary attack vector is crafting a specially crafted SAST report. This report is uploaded via a fake SAST job in a GitLab CI pipeline.
- **"Resolve Vulnerability" Feature:** The victim must use the "Resolve Vulnerability" feature on the vulnerable finding.

**Required Attacker Capabilities/Position:**

- **Ability to Create a SAST Report:** The attacker needs to be able to create and submit a SAST report, which typically requires them to be a contributor to the vulnerable project.
- **Access to CI Configuration:** They need to be able to define a CI configuration that generates the SAST report and uploads it as an artifact.
- **Victim Interaction:** The victim must use the "Resolve Vulnerability" feature. This can be triggered by any user who has rights to view vulnerabilities and create MRs.

**Additional Notes:**

- The provided content includes a full, executable example with a proof of concept.
- The example shows a malicious CI config that includes the injected instructions, but the attacker is able to inject other malicious code.
- The vulnerability is present in how the LLM is being prompted, the injection is happening in the step of creating the prompt based on the parsed SAST report.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 77 | Improper Neutralization of Special Elements used in a Command ('Command Injection') | Class | Allowed-with-Review | sparse | 0.102 |
| 2 | 696 | Incorrect Behavior Order | Class | Allowed-with-Review | sparse | 0.101 |
| 3 | 400 | Uncontrolled Resource Consumption | Class | Discouraged | sparse | 0.098 |
| 4 | 285 | Improper Authorization | Class | Discouraged | sparse | 0.094 |
| 5 | 1286 | Improper Validation of Syntactic Correctness of Input | Base | Allowed | sparse | 0.093 |
| 6 | 755 | Improper Handling of Exceptional Conditions | Class | Discouraged | sparse | 0.092 |
| 7 | 250 | Execution with Unnecessary Privileges | Base | Allowed | sparse | 0.092 |
| 8 | 121 | Stack-based Buffer Overflow | Variant | Allowed | sparse | 0.092 |
| 9 | 88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | dense | 0.576 |
| 10 | 410 | Insufficient Resource Pool | Base | Allowed | graph | 0.002 |

