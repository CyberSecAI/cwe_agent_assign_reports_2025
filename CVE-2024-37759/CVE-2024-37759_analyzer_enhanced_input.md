## Vulnerability Description
DataGear v5.0.0 and earlier was discovered to contain a SpEL (Spring Expression Language) **expression injection** vulnerability via the Data Viewing interface.

### Vulnerability Description Key Phrases
- **weakness:** **expression injection**
- **product:** DataGear
- **version:** v5.0.0 and earlier
- **component:** Data Viewing interface

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**
The vulnerability lies in the `org.datagear.persistence.support.ConversionSqlParamValueMapper#evaluateVariableExpression` function of DataGear v5.0.0. This function directly parses SpEL (Spring Expression Language) expressions without any sanitization or filtering. The expression parameter is controllable by the user, leading to SpEL injection.

**Weaknesses/Vulnerabilities:**
- **SpEL Expression Injection:** The core vulnerability is the ability to inject arbitrary SpEL expressions.
- **Lack of Input Sanitization:** The application does not sanitize or validate user-provided input before parsing it as a SpEL expression.

**Impact of Exploitation:**
- **Remote Code Execution (RCE):** Successful exploitation allows an attacker to execute arbitrary code on the server, potentially leading to full system compromise.

**Attack Vectors:**
- **HTTP Request to `/data/{schemaId}/{tableName}/view`:**  The vulnerability is triggered when a request is made to this endpoint.
- **Data Field Injection:** The attacker injects a malicious SpEL expression into the `data` field of the request, particularly when the database table lacks a primary key.
- **"View" Button Click:** The SpEL expression is executed when the "view" button is clicked, which triggers the vulnerable code path.

**Required Attacker Capabilities/Position:**
- **Access to DataGear Application:** The attacker needs access to a vulnerable DataGear instance.
- **Authenticated User (with permissions to view data):** The attacker needs to be logged into the DataGear application.
- **Ability to Manipulate HTTP Requests:** The attacker must be able to craft HTTP requests to the vulnerable endpoint and insert malicious SpEL expressions.

**Technical Details:**

The vulnerable code snippet is provided:

```java
protected Object evaluateVariableExpression(Connection cn, Table table, Column column, String value, 		NameExpression expression, ExpressionEvaluationContext expressionEvaluationContext, 		List<Object> expressionValues) throws Throwable {
	// ......
	try
	{
		spelExpression = this.spelExpressionParser.parseExpression(expression.getContent());
	}
	catch (Throwable t)
	{
		// ......
	}

	try
	{
		expValue = spelExpression.getValue(expressionEvaluationContext.getVariableExpressionBean());
	}
	catch (Throwable t)
	{
		// ......
	}
	// ......
	return expValue;
}
```

This code demonstrates the direct parsing of a SpEL expression (`expression.getContent()`) using `this.spelExpressionParser.parseExpression()` without input validation. The result is then evaluated using `spelExpression.getValue()`.

**Exploit Example:**

The provided proof-of-concept uses a malicious SpEL expression to execute the `calc` command:
`#{T(java.lang.String).forName('java.lang.Runtime').getRuntime().exec('calc')}`

This expression utilizes Java reflection to obtain a `Runtime` instance and execute a system command.

**Additional Information:**

The vulnerability was reported by `crumbledwall` and was fixed in DataGear version 5.1.0.
A python script is provided that automates the exploit, using a fake mysql server.

This information is more detailed than the typical CVE description, which usually only provides a general overview.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 917 | Improper Neutralization of Special Elements used in an Expression Language Statement ('Expression Language Injection') | Base | Allowed | sparse | 0.175 |
| 2 | 94 | Improper Control of Generation of Code ('Code Injection') | Base | Allowed-with-Review | sparse | 0.150 |
| 3 | 1333 | Inefficient Regular Expression Complexity | Base | Allowed | sparse | 0.131 |
| 4 | 1336 | Improper Neutralization of Special Elements Used in a Template Engine | Base | Allowed | sparse | 0.130 |
| 5 | 78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | sparse | 0.119 |
| 6 | 185 | Incorrect Regular Expression | Class | Allowed-with-Review | sparse | 0.118 |
| 7 | 625 | Permissive Regular Expression | Base | Allowed | sparse | 0.116 |
| 8 | 96 | Improper Neutralization of Directives in Statically Saved Code ('Static Code Injection') | Base | Allowed | sparse | 0.115 |
| 9 | 652 | Improper Neutralization of Data within XQuery Expressions ('XQuery Injection') | Base | Allowed | dense | 0.564 |
| 10 | 184 | Incomplete List of Disallowed Inputs | Base | Allowed | graph | 0.002 |



# Complete CWE Specifications

CWE-917: Improper Neutralization of Special Elements used in an Expression Language Statement ('Expression Language Injection')

CWE-94: Improper Control of Generation of Code ('Code Injection')

CWE-1333: Inefficient Regular Expression Complexity

CWE-1336: Improper Neutralization of Special Elements Used in a Template Engine

CWE-78: Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')

CWE-185: Incorrect Regular Expression

CWE-625: Permissive Regular Expression

CWE-96: Improper Neutralization of Directives in Statically Saved Code ('Static Code Injection')

CWE-652: Improper Neutralization of Data within XQuery Expressions ('XQuery Injection')

CWE-184: Incomplete List of Disallowed Inputs