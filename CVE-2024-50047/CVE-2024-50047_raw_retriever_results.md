# Raw Retriever Results for CVE-2024-50047

# Raw Retriever Results for CVE-2024-50047
## Query
In the Linux kernel, the following vulnerability has been resolved smb client fix UAF in async decryption Doing an async decryption (large read) crashes with a slab-use-after-free way down in the crypto API. Reproducer # mount.cifs -o ...,seal,esize=1 //srv/share /mnt # dd if=/mnt/largefile of=/dev/null ... [ 194.196391] ================================================================== [ 194.196844] BUG KASAN slab-use-after-free in gf128mul_4k_lle+0xc1/0x110 [ 194.197269] Read of size 8 at addr ffff888112bd0448 by task kworker/u772/899 [ 194.197707] [ 194.197818] CPU 12 UID 0 PID 899 Comm kworker/u772 Not tainted 6.11.0-lku-00028-gfca3ca14a17a-dirty #43 [ 194.198400] Hardware name QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.2-3-gd478f380-prebuilt.qemu.org 04/01/2014 [ 194.199046] Workqueue smb3decryptd smb2_decrypt_offload [cifs] [ 194.200032] Call Trace [ 194.200191] [ 194.200327] dump_stack_lvl+0x4e/0x70 [ 194.200558] ? gf128mul_4k_lle+0xc1/0x110 [ 194.200809] print_report+0x174/0x505 [ 194.201040] ? __pfx__raw_spin_lock_irqsave+0x10/0x10 [ 194.201352] ? srso_return_thunk+0x5/0x5f [ 194.201604] ? __virt_addr_valid+0xdf/0x1c0 [ 194.201868] ? gf128mul_4k_lle+0xc1/0x110 [ 194.202128] kasan_report+0xc8/0x150 [ 194.202361] ? gf128mul_4k_lle+0xc1/0x110 [ 194.202616] gf128mul_4k_lle+0xc1/0x110 [ 194.202863] ghash_update+0x184/0x210 [ 194.203103] shash_ahash_update+0x184/0x2a0 [ 194.203377] ? __pfx_shash_ahash_update+0x10/0x10 [ 194.203651] ? srso_return_thunk+0x5/0x5f [ 194.203877] ? crypto_gcm_init_common+0x1ba/0x340 [ 194.204142] gcm_hash_assoc_remain_continue+0x10a/0x140 [ 194.204434] crypt_message+0xec1/0x10a0 [cifs] [ 194.206489] ? __pfx_crypt_message+0x10/0x10 [cifs] [ 194.208507] ? srso_return_thunk+0x5/0x5f [ 194.209205] ? srso_return_thunk+0x5/0x5f [ 194.209925] ? srso_return_thunk+0x5/0x5f [ 194.210443] ? srso_return_thunk+0x5/0x5f [ 194.211037] decrypt_raw_data+0x15f/0x250 [cifs] [ 194.212906] ? __pfx_decrypt_raw_data+0x10/0x10 [cifs] [ 194.214670] ? srso_return_thunk+0x5/0x5f [ 194.215193] smb2_decrypt_offload+0x12a/0x6c0 [cifs] This is because TFM is being used in parallel. Fix this by allocating a new AEAD TFM for async decryption, but keep the existing one for synchronous READ cases (similar to what is done in smb3_calc_signature()). Also remove the calls to aead_request_set_callback() and crypto_wait_req() since its always going to be a synchronous operation.

## Keyphrases
- **rootcause**: 'Use-after-free in async decryption due to shared TFM'
- **weakness**: 'The same TFM was being used for both sync', 'async operations', 'which caused a race condition', 'use-after-free when using async decryption'

## Score Statistics
| Retriever | Min | Max | Mean | Median | Count |
|-----------|-----|-----|------|--------|-------|
| Dense | 0.5239 | 0.5858 | 0.5568 | 0.5675 | 20 |
| Sparse | 630.0101 | 1229.3409 | 802.0954 | 777.7661 | 11 |
| Graph | 1.5552 | 3.6400 | 2.1025 | 1.9705 | 20 |

## Graph Retriever Results (20)
| # | CWE ID | Name | Abstraction | Score | Mapping Usage |
|---|--------|------|-------------|-------|---------------|
| 1 | 197 | Numeric Truncation Error | base | 3.6400 | Allowed |
| 2 | 364 | Signal Handler Race Condition | base | 2.8652 | Allowed |
| 3 | 123 | Write-what-where Condition | base | 2.7014 | Allowed |
| 4 | 120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | base | 2.7014 | Allowed-with-Review |
| 5 | 194 | Unexpected Sign Extension | variant | 2.6040 | Allowed |
| 6 | 276 | Incorrect Default Permissions | base | 2.3296 | Allowed |
| 7 | 1265 | Unintended Reentrant Invocation of Non-reentrant Code Via Nested Calls | base | 2.2100 | Allowed |
| 8 | 390 | Detection of Error Condition Without Action | base | 2.2100 | Allowed |
| 9 | 415 | Double Free | variant | 2.1720 | Allowed |
| 10 | 416 | Use After Free | Variant | 2.1707 | Allowed |
| 11 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | 1.7703 | Allowed-with-Review |
| 12 | 134 | Use of Externally-Controlled Format String | base | 1.6848 | Allowed |
| 13 | 170 | Improper Null Termination | base | 1.6848 | Allowed |
| 14 | 1325 | Improperly Controlled Sequential Memory Allocation | base | 1.6848 | Allowed |
| 15 | 386 | Symbolic Name not Mapping to Correct Object | base | 1.6744 | Allowed |

## Dense Retriever Results (20)
| # | CWE ID | Name | Abstraction | Score | Original Score | Mapping Usage |
|---|--------|------|-------------|-------|----------------|---------------|
| 1 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | 0.5858 | 0.5858 | Allowed-with-Review |
| 2 | 401 | Missing Release of Memory after Effective Lifetime | Variant | 0.5789 | 0.5789 | Allowed |
| 3 | 667 | Improper Locking | Class | 0.5729 | 0.5729 | Allowed-with-Review |
| 4 | 122 | Heap-based Buffer Overflow | Variant | 0.5726 | 0.5726 | Allowed |
| 5 | 1285 | Improper Validation of Specified Index, Position, or Offset in Input | Base | 0.5715 | 0.5715 | Allowed |
| 6 | 1284 | Improper Validation of Specified Quantity in Input | Base | 0.5713 | 0.5713 | Allowed |
| 7 | 126 | Buffer Over-read | Variant | 0.5702 | 0.5702 | Allowed |
| 8 | 327 | Use of a Broken or Risky Cryptographic Algorithm | Class | 0.5696 | 0.5696 | Allowed-with-Review |
| 9 | 131 | Incorrect Calculation of Buffer Size | Base | 0.5689 | 0.5689 | Allowed |
| 10 | 789 | Memory Allocation with Excessive Size Value | Variant | 0.5680 | 0.5680 | Allowed |
| 11 | 770 | Allocation of Resources Without Limits or Throttling | Base | 0.5671 | 0.5671 | Allowed |
| 12 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | 0.5626 | 0.5626 | Allowed |
| 13 | 909 | Missing Initialization of Resource | Class | 0.5612 | 0.5612 | Allowed-with-Review |
| 14 | 190 | Integer Overflow or Wraparound | Base | 0.5415 | 0.5415 | Allowed |
| 15 | 121 | Stack-based Buffer Overflow | Variant | 0.5350 | 0.5350 | Allowed |

## Sparse Retriever Results (11)
| # | CWE ID | Name | Score | Original Score | Mapping Usage |
|---|--------|------|-------|---------------|---------------|
| 1 | 194 | Unexpected Sign Extension | 1229.3409 | 1229.3409 | Allowed |
| 2 | 197 | Numeric Truncation Error | 968.4363 | 968.4363 | Allowed |
| 3 | 276 | Incorrect Default Permissions | 910.3317 | 910.3317 | Allowed |
| 4 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | 800.0000 | 800.0000 | Allowed-with-Review |
| 5 | 416 | Use After Free | 800.0000 | 800.0000 | Allowed |
| 6 | 125 | Out-of-bounds Read | 777.7661 | 777.7661 | Allowed |
| 7 | 23 | Relative Path Traversal | 700.1217 | 700.1217 | Allowed |
| 8 | 190 | Integer Overflow or Wraparound | 699.9849 | 699.9849 | Allowed |
| 9 | 667 | Improper Locking | 675.3365 | 675.3365 | Allowed-with-Review |
| 10 | 770 | Allocation of Resources Without Limits or Throttling | 631.7206 | 631.7206 | Allowed |
| 11 | 789 | Memory Allocation with Excessive Size Value | 630.0101 | 630.0101 | Allowed |
