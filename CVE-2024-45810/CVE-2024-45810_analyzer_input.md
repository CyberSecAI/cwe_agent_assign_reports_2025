# Vulnerability Information: CVE-2024-45810

## Vulnerability Description
Envoy is a cloud-native high-performance edge/middle/service proxy. Envoy will crash when the http async client is handling `sendLocalReply` under some circumstance, e.g., websocket upgrade, and requests mirroring. The http async client will crash during the `sendLocalReply()` in http async client, one reason is http async client is duplicating the status code, another one is the destroy of router is called at the destructor of the async stream, while the stream is deferred deleted at first. There will be problems that the stream decoder is destroyed but its reference is called in `router.onDestroy()`, causing segment fault. This will impact ext_authz if the `upgrade` and `connection` header are allowed, and request mirrorring. This issue has been addressed in versions 1.31.2, 1.30.6, 1.29.9, and 1.28.7. Users are advised to upgrade. There are no known workarounds for this vulnerability.

### Vulnerability Description Key Phrases
- **weakness:** **improper object destruction**
- **impact:** crash
- **vector:** websocket upgrade, and requests mirroring
- **product:** Envoy
- **version:** before 1.31.2, 1.30.6, 1.29.9, and 1.28.7
- **component:** http async client

## CVE Reference Links Content Summary
- **Root cause of vulnerability:** A crash occurs in the Envoy HTTP async client due to a double status code issue and the destruction of the router at the destructor of the async stream while the stream is deferred deleted. The stream decoder is destroyed, but its reference is called in `router.onDestroy()`, causing a segfault.
- **Weaknesses/vulnerabilities present:** Double status code issue in HTTP async client, incorrect lifecycle management of async streams leading to use-after-free, which causes the stream decoder to be destroyed prematurely, resulting in a segfault when `router.onDestroy()` attempts to access the destroyed decoder.
- **Impact of exploitation:** Envoy will crash, interrupting service and traffic processing.
- **Attack vectors:** Sending a WebSocket upgrade request when `upgrade` and `connection` headers are allowed and request mirroring is enabled. The authentication server must then return a 400 error code to trigger the crash.
- **Required attacker capabilities/position:** The attacker needs to be able to send HTTP requests to an Envoy instance configured to allow `upgrade` and `connection` headers, with request mirroring enabled. The attacker also needs to send a WebSocket upgrade request that is rejected by an authentication server (resulting in a 400 response), leading to a crash of the Envoy instance.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | sparse | 0.749 |
| 2 | 789 | Memory Allocation with Excessive Size Value | Variant | Allowed | sparse | 0.733 |
| 3 | 674 | Uncontrolled Recursion | Class | Allowed-with-Review | sparse | 0.680 |
| 4 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 0.677 |
| 5 | 113 | Improper Neutralization of CRLF Sequences in HTTP Headers ('HTTP Request/Response Splitting') | Variant | Allowed | sparse | 0.650 |
| 6 | 1333 | Inefficient Regular Expression Complexity | Base | Allowed | sparse | 0.645 |
| 7 | 407 | Inefficient Algorithmic Complexity | Class | Allowed-with-Review | sparse | 0.639 |
| 8 | 94 | Improper Control of Generation of Code ('Code Injection') | Base | Allowed-with-Review | sparse | 0.639 |
| 9 | 941 | Incorrectly Specified Destination in a Communication Channel | Base | Allowed | dense | 0.472 |
| 10 | 1325 | Improperly Controlled Sequential Memory Allocation | Base | Allowed | graph | 0.003 |

