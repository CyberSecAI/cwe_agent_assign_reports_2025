## Vulnerability Description
Netatalk before 3.2.1 has an **off-by-one error** and resultant **heap-based buffer overflow** because of setting ibuf[len] to \0 in FPMapName in afp_mapname in etc/afpd/directory.c. 2.4.1 and 3.1.19 are also fixed versions.

### Vulnerability Description Key Phrases
- **rootcause:** **off-by-one error**
- **weakness:** **heap-based buffer overflow**
- **product:** Netatalk
- **version:** before 3.2.1
- **component:** FPMapName in afp_mapname in etc/afpd/directory.c

## CVE Reference Links Content Summary
Based on the provided information, here's a breakdown of the vulnerability:

**Root Cause:**
- The vulnerability stems from a lack of proper input validation on the length field after parsing user-provided data in the `afp_mapname` function within `directory.c`.

**Weaknesses/Vulnerabilities:**
- **Heap Out-of-Bounds Write:** The primary weakness is a heap out-of-bounds write. Specifically, a single byte (null terminator `\0`) is written past the allocated buffer.
- **Insufficient Input Validation:** The code fails to validate the length of user-supplied data, allowing for a write beyond the buffer's boundary.

**Impact of Exploitation:**
- **Potential Remote Code Execution:** Under specific circumstances, this out-of-bounds write can corrupt metadata of the adjacent heap block. This corruption can potentially enable an attacker to execute arbitrary code with root privileges.
- **System Crash:** If ASAN is enabled while compiling netatalk, it leads to a crash.

**Attack Vectors:**
- **Network:** The vulnerability is triggered via a network request targeting the AFP service (afpd daemon).
- The vulnerability is present in the `FPMapName` operation of the Netatalk's afpd daemon.
- It can be triggered when logging in with the Guest user authentication module.

**Required Attacker Capabilities/Position:**
- **Unauthenticated Network Access:** An attacker needs network access to the AFP service but does not require prior authentication if the Guest authentication module is enabled.

**Additional Technical Details:**
- The vulnerability is located in the `afp_mapname` function within the `directory.c` file, specifically in this line: `ibuf[len] = '\0';`.
- The vulnerable code paths were introduced around Netatalk version 2.0.0 when the user login flow was rewritten to accommodate AFP v3.
- The vulnerability exists in Netatalk versions 2.0.0 through 3.2.0.
- A proof-of-concept (POC) is provided, which includes a crash log illustrating the out-of-bounds write.

**Mitigation:**
- The vulnerability is fixed in Netatalk versions 2.4.1, 3.1.19, and 3.2.1. Users are advised to upgrade to one of these versions or apply the patch with git hash `77b5d99`.
- As a temporary workaround, the `uams_guest.so` authentication module can be disabled in the `afp.conf` configuration file.

**CVSS Score:**
- CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:L (7.3)

The information provided includes a detailed vulnerability description, affected versions, a patch, mitigation strategies, and the relevant source code location.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 119 | Improper Restriction of Operations within the Bounds of a Memory Buffer | Class | Discouraged | alternate_terms | 0.800 |
| 2 | 190 | Integer Overflow or Wraparound | Base | Allowed | alternate_terms | 0.800 |
| 3 | 193 | Off-by-one Error | Base | Allowed | sparse | 0.307 |
| 4 | 122 | Heap-based Buffer Overflow | Variant | Allowed | sparse | 0.263 |
| 5 | 125 | Out-of-bounds Read | Base | Allowed | sparse | 0.246 |
| 6 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 0.245 |
| 7 | 126 | Buffer Over-read | Variant | Allowed | sparse | 0.241 |
| 8 | 170 | Improper Null Termination | Base | Allowed | sparse | 0.233 |
| 9 | 121 | Stack-based Buffer Overflow | Variant | Allowed | dense | 0.545 |
| 10 | 128 | Wrap-around Error | Base | Allowed | graph | 0.003 |



# Complete CWE Specifications

CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer

CWE-190: Integer Overflow or Wraparound

CWE-193: Off-by-one Error

CWE-122: Heap-based Buffer Overflow

CWE-125: Out-of-bounds Read

CWE-1284: Improper Validation of Specified Quantity in Input

CWE-126: Buffer Over-read

CWE-170: Improper Null Termination

CWE-121: Stack-based Buffer Overflow

CWE-128: Wrap-around Error