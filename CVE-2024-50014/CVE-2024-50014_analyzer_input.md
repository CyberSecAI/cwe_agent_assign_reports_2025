# Vulnerability Information: CVE-2024-50014

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved ext4 fix access to uninitialised lock in fc replay path The following kernel trace can be triggered with fstest generic/629 when executed against a filesystem with fast-commit feature enabled INFO trying to register non-static key. The code is fine but needs lockdep annotation, or maybe you didnt initialize this object before use? turning off the locking correctness validator. CPU 0 PID 866 Comm mount Not tainted 6.10.0+ #11 Hardware name QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.2-3-gd478f380-prebuilt.qemu.org 04/01/2014 Call Trace dump_stack_lvl+0x66/0x90 register_lock_class+0x759/0x7d0 __lock_acquire+0x85/0x2630 ? __find_get_block+0xb4/0x380 lock_acquire+0xd1/0x2d0 ? __ext4_journal_get_write_access+0xd5/0x160 _raw_spin_lock+0x33/0x40 ? __ext4_journal_get_write_access+0xd5/0x160 __ext4_journal_get_write_access+0xd5/0x160 ext4_reserve_inode_write+0x61/0xb0 __ext4_mark_inode_dirty+0x79/0x270 ? ext4_ext_replay_set_iblocks+0x2f8/0x450 ext4_ext_replay_set_iblocks+0x330/0x450 ext4_fc_replay+0x14c8/0x1540 ? jread+0x88/0x2e0 ? rcu_is_watching+0x11/0x40 do_one_pass+0x447/0xd00 jbd2_journal_recover+0x139/0x1b0 jbd2_journal_load+0x96/0x390 ext4_load_and_init_journal+0x253/0xd40 ext4_fill_super+0x2cc6/0x3180 ... In the replay path theres an attempt to lock sbi->s_bdev_wb_lock in function ext4_check_bdev_write_error(). Unfortunately, at this point this spinlock has not been initialized yet. Moving its initialization to an earlier point in __ext4_fill_super() fixes this splat.

### Vulnerability Description Key Phrases
- **rootcause:** **The spinlock sbi->s_bdev_wb_lock was not initialized before being used in the ext4_check_bdev_write_error() function.**
- **weakness:** **Use of uninitialized lock.**
- **impact:** Kernel crash due to lockdep annotation failure when trying to register a non-static key
- **vector:** File system operation with fast-commit feature enabled, specifically during the journal replay path.
- **attacker:** An attacker is not necessarily needed to trigger the vulnerability, it can be triggered by a normal user or system operation.
- **product:** Linux Kernel
- **version:** 6.10.0+
- **component:** ext4 filesystem

## CVE Reference Links Content Summary
Based on the provided information, here's an analysis of the vulnerability:

**Root Cause:**
The root cause is an uninitialized spinlock `sbi->s_bdev_wb_lock` within the ext4 filesystem driver during the fast-commit replay process. Specifically, the lock is being accessed in `ext4_check_bdev_write_error()` within the replay path before it has been properly initialized.

**Weaknesses/Vulnerabilities:**
- **Use of Uninitialized Lock:** The primary vulnerability is the attempt to acquire an uninitialized spinlock. This leads to undefined behavior and can cause a kernel panic (splat).
- **Race Condition:** Although not explicitly stated, the use of an uninitialized lock is a race condition because depending on the execution path and timing, the lock might be accessed before it's initialized.

**Impact of Exploitation:**
- **Kernel Panic/Denial of Service:** The most likely impact is a kernel panic, causing a denial of service. The system will crash, requiring a reboot.
- **Data Corruption (Potential):** While not explicitly mentioned, accessing an uninitialized lock could, in theory, lead to data corruption if the lock's memory happens to have values that cause further corruption.

**Attack Vectors:**
- **Mounting an ext4 Filesystem with fast-commit enabled:** This vulnerability can be triggered during the mount process of an ext4 filesystem that has the fast-commit feature enabled.
- **Specific Test Case:** The provided information indicates that the vulnerability can be triggered using the `fstest generic/629` test case.

**Required Attacker Capabilities/Position:**
- **Local Access:** An attacker would likely need local access to mount a crafted or corrupted ext4 filesystem.
- **Fast-Commit Filesystem:** The target filesystem must have the fast-commit feature enabled for this vulnerability to be triggered during the replay process.

**More Detail than CVE:**
The provided content offers significant detail, including:
- The specific call trace leading to the vulnerability.
- The exact location of the uninitialized lock within the code.
- The test case (`fstest generic/629`) that can trigger the vulnerability
- The fix which involves moving the initialization of the lock to an earlier point in the code.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.601 |
| 2 | 909 | Missing Initialization of Resource | Class | Allowed-with-Review | sparse | 0.592 |
| 3 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.587 |
| 4 | 833 | Deadlock | Base | Allowed | sparse | 0.567 |
| 5 | 908 | Use of Uninitialized Resource | Base | Allowed | sparse | 0.561 |
| 6 | 674 | Uncontrolled Recursion | Class | Allowed-with-Review | sparse | 0.556 |
| 7 | 835 | Loop with Unreachable Exit Condition ('Infinite Loop') | Base | Allowed | sparse | 0.552 |
| 8 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.551 |
| 9 | 413 | Improper Resource Locking | Base | Allowed | dense | 0.571 |
| 10 | 120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | Base | Allowed-with-Review | graph | 0.002 |

