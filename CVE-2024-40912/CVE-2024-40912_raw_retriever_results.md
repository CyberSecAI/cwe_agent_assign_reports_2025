# Raw Retriever Results for CVE-2024-40912

# Raw Retriever Results for CVE-2024-40912
## Query
In the Linux kernel, the following vulnerability has been resolvedwifi mac80211 Fix deadlock in ieee80211_sta_ps_deliver_wakeup()The ieee80211_sta_ps_deliver_wakeup() function takes sta->ps_lock tosynchronizes with ieee80211_tx_h_unicast_ps_buf() which is called fromsoftirq context. However using only spin_lock() to get sta->ps_lock inieee80211_sta_ps_deliver_wakeup() does not prevent softirq to executeon this same CPU, to run ieee80211_tx_h_unicast_ps_buf() and try totake this same lock ending in deadlock. Below is an example of rcu stallthat arises in such situation. rcu INFO rcu_sched self-detected stall on CPU rcu 2-.... (42413413 ticks this GP) idle=b154/1/0x4000000000000000 softirq=1763/1765 fqs=21206996 rcu (t=42586894 jiffies g=2057 q=362405 ncpus=4) CPU 2 PID 719 Comm wpa_supplicant Tainted G W 6.4.0-02158-g1b062f552873 #742 Hardware name RPT (r1) (DT) pstate 00000005 (nzcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--) pc queued_spin_lock_slowpath+0x58/0x2d0 lr invoke_tx_handlers_early+0x5b4/0x5c0 sp ffff00001ef64660 x29 ffff00001ef64660 x28 ffff000009bc1070 x27 ffff000009bc0ad8 x26 ffff000009bc0900 x25 ffff00001ef647a8 x24 0000000000000000 x23 ffff000009bc0900 x22 ffff000009bc0900 x21 ffff00000ac0e000 x20 ffff00000a279e00 x19 ffff00001ef646e8 x18 0000000000000000 x17 ffff800016468000 x16 ffff00001ef608c0 x15 0010533c93f64f80 x14 0010395c9faa3946 x13 0000000000000000 x12 00000000fa83b2da x11 000000012edeceea x10 ffff0000010fbe00 x9 0000000000895440 x8 000000000010533c x7 ffff00000ad8b740 x6 ffff00000c350880 x5 0000000000000007 x4 0000000000000001 x3 0000000000000000 x2 0000000000000000 x1 0000000000000001 x0 ffff00000ac0e0e8 Call trace queued_spin_lock_slowpath+0x58/0x2d0 ieee80211_tx+0x80/0x12c ieee80211_tx_pending+0x110/0x278 tasklet_action_common.constprop.0+0x10c/0x144 tasklet_action+0x20/0x28 _stext+0x11c/0x284 ____do_softirq+0xc/0x14 call_on_irq_stack+0x24/0x34 do_softirq_own_stack+0x18/0x20 do_softirq+0x74/0x7c __local_bh_enable_ip+0xa0/0xa4 _ieee80211_wake_txqs+0x3b0/0x4b8 __ieee80211_wake_queue+0x12c/0x168 ieee80211_add_pending_skbs+0xec/0x138 ieee80211_sta_ps_deliver_wakeup+0x2a4/0x480 ieee80211_mps_sta_status_update.part.0+0xd8/0x11c ieee80211_mps_sta_status_update+0x18/0x24 sta_apply_parameters+0x3bc/0x4c0 ieee80211_change_station+0x1b8/0x2dc nl80211_set_station+0x444/0x49c genl_family_rcv_msg_doit.isra.0+0xa4/0xfc genl_rcv_msg+0x1b0/0x244 netlink_rcv_skb+0x38/0x10c genl_rcv+0x34/0x48 netlink_unicast+0x254/0x2bc netlink_sendmsg+0x190/0x3b4 ____sys_sendmsg+0x1e8/0x218 ___sys_sendmsg+0x68/0x8c __sys_sendmsg+0x44/0x84 __arm64_sys_sendmsg+0x20/0x28 do_el0_svc+0x6c/0xe8 el0_svc+0x14/0x48 el0t_64_sync_handler+0xb0/0xb4 el0t_64_sync+0x14c/0x150Using spin_lock_bh()/spin_unlock_bh() instead prevents softirq to raiseon the same CPU that is holding the lock.

## Keyphrases
- **rootcause**: 'The function ieee80211_sta_ps_deliver_wakeup() uses spin_lock() to synchronize with ieee80211_tx_h_unicast_ps_buf()', 'but does not prevent softirq from executing on the same CPU', 'leading to a deadlock.'
- **weakness**: 'The usage of spin_lock() in ieee80211_sta_ps_deliver_wakeup() does not prevent softirqs from interrupting the critical section on the same CPU', 'which leads to a deadlock when the softirq context attempts to acquire the same lock.'

## Score Statistics
| Retriever | Min | Max | Mean | Median | Count |
|-----------|-----|-----|------|--------|-------|
| Dense | 0.4496 | 0.5532 | 0.4856 | 0.4811 | 20 |
| Sparse | 483.9787 | 577.2320 | 516.2439 | 504.8112 | 12 |
| Graph | 1.7125 | 2.6784 | 2.1543 | 2.2100 | 20 |

## Graph Retriever Results (20)
| # | CWE ID | Name | Abstraction | Score | Mapping Usage |
|---|--------|------|-------------|-------|---------------|
| 1 | 129 | Improper Validation of Array Index | variant | 2.6784 | Allowed |
| 2 | 416 | Use After Free | variant | 2.5507 | Allowed |
| 3 | 770 | Allocation of Resources Without Limits or Throttling | base | 2.4232 | Allowed |
| 4 | 120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | base | 2.4232 | Allowed-with-Review |
| 5 | 123 | Write-what-where Condition | base | 2.4232 | Allowed |
| 6 | 843 | Access of Resource Using Incompatible Type ('Type Confusion') | base | 2.2100 | Allowed |
| 7 | 1257 | Improper Access Control Applied to Mirrored or Aliased Memory Regions | base | 2.2100 | Allowed |
| 8 | 1260 | Improper Handling of Overlap Between Protected Memory Ranges | base | 2.2100 | Allowed |
| 9 | 128 | Wrap-around Error | base | 2.2100 | Allowed |
| 10 | 1339 | Insufficient Precision or Accuracy of a Real Number | base | 2.2100 | Allowed |
| 11 | 839 | Numeric Range Comparison Without Minimum Check | base | 2.2100 | Allowed |
| 12 | 1325 | Improperly Controlled Sequential Memory Allocation | base | 2.2090 | Allowed |
| 13 | 789 | Memory Allocation with Excessive Size Value | variant | 2.1427 | Allowed |
| 14 | 328 | Use of Weak Hash | base | 2.1190 | Allowed |
| 15 | 195 | Signed to Unsigned Conversion Error | variant | 2.0400 | Allowed |

## Dense Retriever Results (20)
| # | CWE ID | Name | Abstraction | Score | Original Score | Mapping Usage |
|---|--------|------|-------------|-------|----------------|---------------|
| 1 | 833 | Deadlock | Base | 0.5532 | 0.5532 | Allowed |
| 2 | 667 | Improper Locking | Class | 0.5363 | 0.5363 | Allowed-with-Review |
| 3 | 413 | Improper Resource Locking | Base | 0.5248 | 0.5248 | Allowed |
| 4 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | 0.5190 | 0.5190 | Allowed-with-Review |
| 5 | 1285 | Improper Validation of Specified Index, Position, or Offset in Input | Base | 0.5103 | 0.5103 | Allowed |
| 6 | 909 | Missing Initialization of Resource | Class | 0.5077 | 0.5077 | Allowed-with-Review |
| 7 | 401 | Missing Release of Memory after Effective Lifetime | Variant | 0.5033 | 0.5033 | Allowed |
| 8 | 606 | Unchecked Input for Loop Condition | Base | 0.5029 | 0.5029 | Allowed |
| 9 | 835 | Loop with Unreachable Exit Condition ('Infinite Loop') | Base | 0.4996 | 0.4996 | Allowed |
| 10 | 121 | Stack-based Buffer Overflow | Variant | 0.4987 | 0.4987 | Allowed |
| 11 | 911 | Improper Update of Reference Count | Base | 0.4636 | 0.4636 | Allowed |
| 12 | 364 | Signal Handler Race Condition | Base | 0.4634 | 0.4634 | Allowed |
| 13 | 191 | Integer Underflow (Wrap or Wraparound) | Base | 0.4573 | 0.4573 | Allowed |
| 14 | 1256 | Improper Restriction of Software Interfaces to Hardware Features | Base | 0.4569 | 0.4569 | Allowed |
| 15 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | 0.4556 | 0.4556 | Allowed |

## Sparse Retriever Results (12)
| # | CWE ID | Name | Score | Original Score | Mapping Usage |
|---|--------|------|-------|---------------|---------------|
| 1 | 833 | Deadlock | 577.2320 | 577.2320 | Allowed |
| 2 | 667 | Improper Locking | 576.1051 | 576.1051 | Allowed-with-Review |
| 3 | 400 | Uncontrolled Resource Consumption | 523.9591 | 523.9591 | Discouraged |
| 4 | 119 | Improper Restriction of Operations within the Bounds of a Memory Buffer | 521.8519 | 521.8519 | Discouraged |
| 5 | 328 | Use of Weak Hash | 518.8175 | 518.8175 | Allowed |
| 6 | 212 | Improper Removal of Sensitive Information Before Storage or Transfer | 506.4375 | 506.4375 | Allowed |
| 7 | 863 | Incorrect Authorization | 503.1849 | 503.1849 | Allowed-with-Review |
| 8 | 674 | Uncontrolled Recursion | 501.8289 | 501.8289 | Allowed-with-Review |
| 9 | 835 | Loop with Unreachable Exit Condition ('Infinite Loop') | 499.5263 | 499.5263 | Allowed |
| 10 | 200 | Exposure of Sensitive Information to an Unauthorized Actor | 496.0516 | 496.0516 | Discouraged |
| 11 | 347 | Improper Verification of Cryptographic Signature | 485.9527 | 485.9527 | Allowed |
| 12 | 663 | Use of a Non-reentrant Function in a Concurrent Context | 483.9787 | 483.9787 | Allowed |
