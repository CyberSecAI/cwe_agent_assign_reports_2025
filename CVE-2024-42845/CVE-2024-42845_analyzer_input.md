# Vulnerability Information: CVE-2024-42845

## Vulnerability Description
An **eval Injection** vulnerability in the component invesalius/reader/dicom.py of InVesalius 3.1.99991 through 3.1.99998 allows attackers to execute arbitrary code via loading a crafted DICOM file.

### Vulnerability Description Key Phrases
- **rootcause:** **eval Injection**
- **impact:** execute arbitrary code
- **attacker:** attackers
- **product:** InVesalius
- **version:** 3.1.99991 through 3.1.99998
- **component:** invesalius/reader/dicom.py

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability described:

**Root cause of vulnerability:**
- The vulnerability stems from the use of the `eval()` function on user-controlled data within the `GetImagePosition` function in the `invesalius/reader/dicom.py` file. This function processes data extracted from the DICOM file's tag at position `(0x020, 0x032)`.

**Weaknesses/vulnerabilities present:**
- **Unsafe use of `eval()`:** The core issue is the direct use of `eval()` on data extracted from a DICOM file. This allows an attacker to inject arbitrary Python code by crafting malicious data into the DICOM file's tag.
- **Lack of input sanitization:** The code attempts to replace commas with periods, but it does not sanitize other malicious inputs that could be used in the payload.

**Impact of exploitation:**
- **Remote Code Execution (RCE):** An attacker can achieve arbitrary code execution on the victim's machine by importing a crafted DICOM file containing a malicious Python payload. The payload will be executed with the same privileges as the Invesalius application.

**Attack vectors:**
- **Crafted DICOM file:** The attacker needs to create a malicious DICOM file with a specific tag (0x0020, 0x0032) containing the malicious Python payload.

**Required attacker capabilities/position:**
- The attacker needs the ability to create or modify DICOM files.
- The attacker needs to lure a victim into importing the crafted DICOM file into their Invesalius application.

**Technical Details:**
- The vulnerable code is located within the `GetImagePosition` function in the `invesalius/reader/dicom.py` script file.
- The vulnerable code block is as follows:
```python
def GetImagePosition(self):
    try:
        data = self.data_image[str(0x020)][str(0x032)].replace(",", ".")
    except KeyError:
        return ""
    if data:
        return [eval(value) for value in data.split("\\")]
        return ""
```
- The image position is calculated using coordinates separated by `\` characters. For instance, coordinates might appear as `5.1\4.3\3.2`.
- An attacker can append a malicious Python payload after the last coordinate, also delimited by a backslash. This payload will be executed using the `eval()` function.
- The vulnerability affects Invesalius3 versions from 3.1.99991 to 3.1.99998.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 95 | Improper Neutralization of Directives in Dynamically Evaluated Code ('Eval Injection') | Variant | Allowed | sparse | 0.202 |
| 2 | 94 | Improper Control of Generation of Code ('Code Injection') | Base | Allowed-with-Review | sparse | 0.192 |
| 3 | 78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | sparse | 0.149 |
| 4 | 625 | Permissive Regular Expression | Base | Allowed | sparse | 0.149 |
| 5 | 835 | Loop with Unreachable Exit Condition ('Infinite Loop') | Base | Allowed | sparse | 0.148 |
| 6 | 790 | Improper Filtering of Special Elements | Class | Allowed-with-Review | sparse | 0.146 |
| 7 | 1336 | Improper Neutralization of Special Elements Used in a Template Engine | Base | Allowed | sparse | 0.145 |
| 8 | 502 | Deserialization of Untrusted Data | Base | Allowed | sparse | 0.145 |
| 9 | 89 | Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection') | Base | Allowed | dense | 0.517 |
| 10 | 184 | Incomplete List of Disallowed Inputs | Base | Allowed | graph | 0.003 |

