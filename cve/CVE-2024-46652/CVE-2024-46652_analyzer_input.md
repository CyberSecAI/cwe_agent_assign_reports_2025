# Vulnerability Information: CVE-2024-46652

## Vulnerability Description
Tenda AC8v4 V16.03.34.06 has a **stack overflow** vulnerability in the fromAdvSetMacMtuWan function.

### Vulnerability Description Key Phrases
- **weakness:** **stack overflow**
- **product:** Tenda AC8v4
- **version:** V16.03.34.06
- **component:** fromAdvSetMacMtuWan function

## CVE Reference Links Content Summary
The provided content details a stack overflow vulnerability in Tenda AC8v4 router firmware, specifically within the `fromAdvSetMacMtuWan` function.

**Root cause of vulnerability:**

- A stack buffer overflow occurs due to the usage of `strcpy` within the `sub_458FBC` function. User-controlled parameters (`wanMTU`, `wanSpeed`, `cloneType`, `mac`, `serviceName`, `serverName`) are copied into a fixed-size buffer (`a3` in `sub_458FBC`) without proper bounds checking. The size of the destination `a3` is 153 bytes, while the attacker can control the size of the input parameters. When the input parameters are larger than 153 bytes, this leads to a stack overflow. The `a3` variable is part of `v5` array in `fromAdvSetMacMtuWan`, so overflowing it also overflows the surrounding stack.

**Weaknesses/vulnerabilities present:**

- Stack buffer overflow vulnerability in the `fromAdvSetMacMtuWan` function, specifically the `strcpy` usage in the `sub_458FBC` function which does not check the size of the input parameters and copies them to the stack.

**Impact of exploitation:**

- Remote Code Execution (RCE) can be achieved by constructing a Return-Oriented Programming (ROP) chain to redirect execution flow to attacker-controlled code.

**Attack vectors:**

- Sending a POST request to `/goform/AdvSetMacMtuWan` with a specially crafted payload within the `wanMTU` parameter. This payload will overwrite the return address on the stack.

**Required attacker capabilities/position:**

- The attacker must be able to send HTTP requests to the web interface of the Tenda AC8v4 router. This could be done remotely, if the web interface is exposed to the Internet, or from the local network.

**Additional details:**

- The exploit requires bypassing a check on `wans.flag`. In the simulation environment, the value returned by `GetValue("wans.flag", v4)` is always 0, preventing the vulnerable code from being executed, so the attacker had to modify the assembly to bypass the check. The author notes that in a real environment, the value of `wans.flag` can be made greater than 0.
- The exploit uses ROP gadgets from libc to bypass the restriction that the return address cannot be located in the `httpd` binary due to the strcpy operation and the null byte limitation.
- The attacker had to find multiple ROP gadgets, one for controlling the return address, and others for controlling other registers such as $a0, $t9, $s4, $sp.
- The attacker used a writable memory location to store the value to be loaded by the `lw $v0, 0xec($v0)` instruction.
- The author emphasizes that Address Space Layout Randomization (ASLR) is not enabled on the device, which makes it easier to write the exploit.
- The provided exploit code utilizes `requests` and `pwn` libraries for crafting and sending the malicious POST request.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 121 | Stack-based Buffer Overflow | Variant | Allowed | alternate_terms | 1.000 |
| 2 | 190 | Integer Overflow or Wraparound | Base | Allowed | alternate_terms | 0.800 |
| 3 | 120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | Base | Allowed-with-Review | sparse | 0.115 |
| 4 | 674 | Uncontrolled Recursion | Class | Allowed-with-Review | sparse | 0.099 |
| 5 | 835 | Loop with Unreachable Exit Condition ('Infinite Loop') | Base | Allowed | sparse | 0.097 |
| 6 | 1325 | Improperly Controlled Sequential Memory Allocation | Base | Allowed | sparse | 0.085 |
| 7 | 170 | Improper Null Termination | Base | Allowed | sparse | 0.083 |
| 8 | 676 | Use of Potentially Dangerous Function | Base | Allowed | sparse | 0.083 |
| 9 | 78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | dense | 0.583 |
| 10 | 128 | Wrap-around Error | Base | Allowed | graph | 0.002 |

