# Vulnerability Information: CVE-2024-38588

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved ftrace Fix possible **use-after-free** issue in ftrace_location() KASAN reports a bug BUG KASAN **use-after-free** in ftrace_location+0x90/0x120 Read of size 8 at addr ffff888141d40010 by task insmod/424 CPU 8 PID 424 Comm insmod Tainted G W 6.9.0-rc2+ [...] Call Trace dump_stack_lvl+0x68/0xa0 print_report+0xcf/0x610 kasan_report+0xb5/0xe0 ftrace_location+0x90/0x120 register_kprobe+0x14b/0xa40 kprobe_init+0x2d/0xff0 [kprobe_example] do_one_initcall+0x8f/0x2d0 do_init_module+0x13a/0x3c0 load_module+0x3082/0x33d0 init_module_from_file+0xd2/0x130 __x64_sys_finit_module+0x306/0x440 do_syscall_64+0x68/0x140 entry_SYSCALL_64_after_hwframe+0x71/0x79 The root cause is that, in lookup_rec(), ftrace record of some address is being searched in ftrace pages of some module, but those ftrace pages at the same time is being freed in ftrace_release_mod() as the corresponding module is being deleted CPU1 | CPU2 register_kprobes() { | delete_module() { check_kprobe_address_safe() { | arch_check_ftrace_location() { | ftrace_location() { | lookup_rec() // USE! | ftrace_release_mod() // Free! To fix this issue 1. Hold rcu lock as accessing ftrace pages in ftrace_location_range() 2. Use ftrace_location_range() instead of lookup_rec() in

### Vulnerability Description Key Phrases
- **rootcause:** **race condition**
- **weakness:** **use-after-free**
- **product:** Linux kernel
- **component:** ftrace_location()

## CVE Reference Links Content Summary
```
{
  "cveId": "CVE-2024-38588",
  "baseScore": "not available",
  "impactScore": "not available",
  "exploitabilityScore": "not available",
  "vectorString": "not available",
  "attackVector": "Local",
  "attackComplexity": "High",
  "privilegesRequired": "Low",
  "userInteraction": "None",
  "scope": "Unchanged",
  "confidentialityImpact": "None",
  "integrityImpact": "None",
  "availabilityImpact": "High",
  "description": "The root cause is that, in lookup_rec(), ftrace record of some address is being searched in ftrace pages of some module, but those ftrace pages at the same time is being freed in ftrace_release_mod() as the corresponding module is being deleted.",
  "vulnerabilityDetails": [
    {
      "source": "git.kernel.org_7e8aa285_20250110_112903.html",
      "details": "Root cause: In `lookup_rec()`, the ftrace record of an address is searched in the ftrace pages of a module, while these ftrace pages are being freed in `ftrace_release_mod()` because the corresponding module is being deleted.\n\nWeaknesses: Use-after-free vulnerability in `ftrace_location()` function.\n\nImpact: Kernel crash or other undefined behavior.\n\nAttack vector: Loading and unloading kernel modules while ftrace is active, causing a race condition.\n\nAttacker capabilities/position:  Attacker needs to be able to load and unload kernel modules (requires some privileges), and also trigger kprobes."
    },
    {
      "source": "git.kernel.org_3c8655b6_20250110_112901.html",
      "details": "Root cause: In `lookup_rec()`, the ftrace record of an address is searched in the ftrace pages of a module, while these ftrace pages are being freed in `ftrace_release_mod()` because the corresponding module is being deleted.\n\nWeaknesses: Use-after-free vulnerability in `ftrace_location()` function.\n\nImpact: Kernel crash or other undefined behavior.\n\nAttack vector: Loading and unloading kernel modules while ftrace is active, causing a race condition.\n\nAttacker capabilities/position:  Attacker needs to be able to load and unload kernel modules (requires some privileges), and also trigger kprobes."
    },
    {
      "source": "git.kernel.org_f2ca8cb8_20250110_112903.html",
      "details": "Root cause: In `lookup_rec()`, the ftrace record of an address is searched in the ftrace pages of a module, while these ftrace pages are being freed in `ftrace_release_mod()` because the corresponding module is being deleted.\n\nWeaknesses: Use-after-free vulnerability in `ftrace_location()` function.\n\nImpact: Kernel crash or other undefined behavior.\n\nAttack vector: Loading and unloading kernel modules while ftrace is active, causing a race condition.\n\nAttacker capabilities/position:  Attacker needs to be able to load and unload kernel modules (requires some privileges), and also trigger kprobes."
    },
    {
      "source": "git.kernel.org_8dc2dc3b_20250110_112904.html",
       "details": "Root cause: In `lookup_rec()`, the ftrace record of an address is searched in the ftrace pages of a module, while these ftrace pages are being freed in `ftrace_release_mod()` because the corresponding module is being deleted.\n\nWeaknesses: Use-after-free vulnerability in `ftrace_location()` function.\n\nImpact: Kernel crash or other undefined behavior.\n\nAttack vector: Loading and unloading kernel modules while ftrace is active, causing a race condition.\n\nAttacker capabilities/position:  Attacker needs to be able to load and unload kernel modules (requires some privileges), and also trigger kprobes."
    },
    {
      "source": "git.kernel.org_e2f2724a_20250110_112900.html",
      "details": "Root cause: In `lookup_rec()`, the ftrace record of an address is searched in the ftrace pages of a module, while these ftrace pages are being freed in `ftrace_release_mod()` because the corresponding module is being deleted.\n\nWeaknesses: Use-after-free vulnerability in `ftrace_location()` function.\n\nImpact: Kernel crash or other undefined behavior.\n\nAttack vector: Loading and unloading kernel modules while ftrace is active, causing a race condition.\n\nAttacker capabilities/position:  Attacker needs to be able to load and unload kernel modules (requires some privileges), and also trigger kprobes."
    },
    {
      "source": "git.kernel.org_56898ae2_20250110_112902.html",
      "details": "Root cause: In `lookup_rec()`, the ftrace record of an address is searched in the ftrace pages of a module, while these ftrace pages are being freed in `ftrace_release_mod()` because the corresponding module is being deleted.\n\nWeaknesses: Use-after-free vulnerability in `ftrace_location()` function.\n\nImpact: Kernel crash or other undefined behavior.\n\nAttack vector: Loading and unloading kernel modules while ftrace is active, causing a race condition.\n\nAttacker capabilities/position:  Attacker needs to be able to load and unload kernel modules (requires some privileges), and also trigger kprobes."
    },
     {
      "source": "git.kernel.org_af15d809_20250110_112901.html",
      "details": "Root cause: In `lookup_rec()`, the ftrace record of an address is searched in the ftrace pages of a module, while these ftrace pages are being freed in `ftrace_release_mod()` because the corresponding module is being deleted.\n\nWeaknesses: Use-after-free vulnerability in `ftrace_location()` function.\n\nImpact: Kernel crash or other undefined behavior.\n\nAttack vector: Loading and unloading kernel modules while ftrace is active, causing a race condition.\n\nAttacker capabilities/position:  Attacker needs to be able to load and unload kernel modules (requires some privileges), and also trigger kprobes."
    },
    {
      "source": "git.kernel.org_90265f2b_20250110_112904.html",
      "details":"Root cause: In `lookup_rec()`, the ftrace record of an address is searched in the ftrace pages of a module, while these ftrace pages are being freed in `ftrace_release_mod()` because the corresponding module is being deleted.\n\nWeaknesses: Use-after-free vulnerability in `ftrace_location()` function.\n\nImpact: Kernel crash or other undefined behavior.\n\nAttack vector: Loading and unloading kernel modules while ftrace is active, causing a race condition.\n\nAttacker capabilities/position:  Attacker needs to be able to load and unload kernel modules (requires some privileges), and also trigger kprobes."
    }
  ]
}
```

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | alternate_terms | 1.000 |
| 2 | 416 | Use After Free | Variant | Allowed | alternate_terms | 1.000 |
| 3 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.550 |
| 4 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.538 |
| 5 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.498 |
| 6 | 364 | Signal Handler Race Condition | Base | Allowed | sparse | 0.489 |
| 7 | 415 | Double Free | Variant | Allowed | sparse | 0.486 |
| 8 | 1390 | Weak Authentication | Class | Allowed-with-Review | sparse | 0.478 |
| 9 | 909 | Missing Initialization of Resource | Class | Allowed-with-Review | dense | 0.562 |
| 10 | 609 | Double-Checked Locking | Base | Allowed | graph | 0.003 |

