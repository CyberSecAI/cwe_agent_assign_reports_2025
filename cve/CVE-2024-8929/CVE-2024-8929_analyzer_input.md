# Vulnerability Information: CVE-2024-8929

## Vulnerability Description
In PHP versions 8.1.* before 8.1.31, 8.2.* before 8.2.26, 8.3.* before 8.3.14, a hostile MySQL server can cause the client to disclose the content of its heap containing data from other SQL requests and possible other data belonging to different users of the same server.

### Vulnerability Description Key Phrases
- **impact:** disclose heap content
- **attacker:** hostile MySQL server
- **product:** PHP
- **version:** 8.1.* before 8.1.31, 8.2.* before 8.2.26, 8.3.* before 8.3.14

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**

- The vulnerability lies in the `php_mysqlnd_rset_field_read` function within the `mysqlnd` extension of PHP. This function parses MySQL field packets.
- The function incorrectly parses the `def` field of a MySQL field packet. It attempts to read a length-encoded string, even though the field is not supported anymore (`COM_FIELD_LIST`).
- The code allocates memory based on this length without validating the length against the remaining buffer size.

**Weaknesses/Vulnerabilities:**

- **Heap buffer over-read:** By manipulating the length field in the field packet, an attacker can force the function to read beyond the allocated buffer, resulting in a heap over-read. Specifically, it is using the attacker controlled length to read more than the remaining data in the buffer.
- **Lack of input validation:** The function does not properly validate the length field against the available buffer space.

**Impact of Exploitation:**

- **Information Disclosure:** The primary impact is the disclosure of sensitive information stored in the heap memory. Because PHP-FPM workers reuse memory, subsequent MySQL requests might return data from previous queries or other data held in the process's heap.
- **Potential for further exploitation:** While not explicitly mentioned, other vulnerabilities may be exposed through the leaked heap content, though this is speculative and not explained in detail.

**Attack Vectors:**

- **Malicious MySQL Server:** An attacker can set up a fake MySQL server that responds with crafted field packets containing an arbitrary length, triggering the heap over-read on the client (PHP application).
- **Man-in-the-Middle Attack:** An attacker could intercept and modify legitimate MySQL responses, injecting a crafted field packet.
- The attacker needs to be able to initiate a SQL Query on the vulnerable server.

**Required Attacker Capabilities/Position:**

- The attacker needs to control the MySQL server or be able to tamper with network packets.
- The attacker needs to make a MySQL query.
- The targeted system needs to use a vulnerable PHP version with `mysqlnd` extension.
- The attack exploits PHP-FPM to retain contextual data between requests.

**Additional Information:**

- The provided text includes a Proof of Concept (PoC) in the form of Python and PHP scripts.
- The vulnerability is not exploitable in all places that may seem similar, but a list of similar possible vulnerabilities is provided.
- The vulnerability is more easily exploitable in shared hosting environments.
- The `def` field is intended for use with `COM_FIELD_LIST`, which is no longer supported by the mysqlnd extension.

**CVE ID:** CVE-2024-8929

**CWEs:** CWE-126, CWE-200, CWE-244, CWE-488

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | sparse | 0.091 |
| 2 | 639 | Authorization Bypass Through User-Controlled Key | Base | Allowed | sparse | 0.091 |
| 3 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.089 |
| 4 | 116 | Improper Encoding or Escaping of Output | Class | Allowed-with-Review | sparse | 0.089 |
| 5 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 0.088 |
| 6 | 126 | Buffer Over-read | Variant | Allowed | sparse | 0.087 |
| 7 | 502 | Deserialization of Untrusted Data | Base | Allowed | sparse | 0.086 |
| 8 | 522 | Insufficiently Protected Credentials | Class | Allowed-with-Review | sparse | 0.086 |
| 9 | 922 | Insecure Storage of Sensitive Information | Class | Allowed-with-Review | dense | 0.472 |
| 10 | 184 | Incomplete List of Disallowed Inputs | Base | Allowed | graph | 0.002 |

