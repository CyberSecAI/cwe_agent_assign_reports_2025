# Vulnerability Information: CVE-2024-6409

## Vulnerability Description
A **race condition** vulnerability was discovered in how signals are handled by OpenSSHs server (sshd). If a remote attacker does not authenticate within a set time period, then sshds SIGALRM handler is called asynchronously. However, this signal handler calls various functions that are not async-signal-safe, for example, syslog(). As a consequence of a successful attack, in the worst case scenario, an attacker may be able to perform a remote code execution (RCE) as an unprivileged user running the sshd server.

### Vulnerability Description Key Phrases
- **rootcause:** **race condition**
- **weakness:** **use of non async-signal-safe functions in signal handler**
- **impact:** remote code execution
- **attacker:** remote attacker
- **product:** OpenSSH server

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the CVE-2024-6409 vulnerability:

**Root cause of vulnerability:**
- A race condition exists in OpenSSH's signal handling mechanism, specifically within the `SIGALRM` handler in the `sshd` server. This handler is invoked when a client fails to authenticate within the configured `LoginGraceTime`.
- The vulnerability stems from the use of non-async-signal-safe functions (like `syslog()`) within the `SIGALRM` handler. Specifically, the `cleanup_exit()` function, which calls these unsafe functions (e.g., `packet_destroy_all()` which calls `free()`), is called in the signal handler.

**Weaknesses/vulnerabilities present:**
- Use of non-async-signal-safe functions within a signal handler
- A race condition in the unprivileged privsep child process of the OpenSSH server due to calling `cleanup_exit()`.

**Impact of exploitation:**
- **Remote Code Execution (RCE):** An unauthenticated remote attacker may achieve RCE as the unprivileged user running the `sshd` server. This arises from heap corruption due to the use of `free()` in signal context and the presence of a ROP chain in shared libraries to call arbitrary code.
- **Denial of Service (DoS):** Exploitation can also cause DoS.

**Attack vectors:**
- The vulnerability is exploitable remotely over a network by sending a crafted SSH connection to a vulnerable server, failing to authenticate and triggering the `SIGALRM` signal via timeout.
- Triggering the vulnerability requires a connection to the SSH server where the client fails to authenticate.

**Required attacker capabilities/position:**
- A remote attacker can exploit the vulnerability.
- The attacker must have network access to the target's SSH port.
- The attacker has to trigger a timeout by not authenticating in order to invoke the signal handler.
- No authentication is required.

**Additional Information:**
- The core issue stems from the incorrect use of the `cleanup_exit` function in a signal handler, particularly in Red Hat Enterprise Linux 9 and derivatives, because of a backported patch that introduces async-signal-unsafe behavior.
- Upstream OpenSSH is not directly vulnerable since the vulnerable logic introduced by `openssh-7.6p1-audit.patch` is specific to Red Hat, but that vulnerability made it into RHEL. The upstream code does not call these problematic functions, so this issue is specific to patched versions of `openssh`.
- The issue is present in OpenSSH versions 8.7p1 and 8.8p1.
- A mitigation is to set `LoginGraceTime 0` which effectively prevents exploitation of the race condition, although that creates another potential avenue for DoS.

- A fix involves removing `cleanup_exit()` from signal handler or changing it to use the async-signal-safe `_exit(1)` instead.
- The attack vector involves a race condition within the privsep child process, running with reduced privileges, which reduces the immediate impact, although full RCE may still be possible.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | alternate_terms | 1.000 |
| 2 | 828 | Signal Handler with Functionality that is not Asynchronous-Safe | Variant | Allowed | sparse | 0.581 |
| 3 | 364 | Signal Handler Race Condition | Base | Allowed | sparse | 0.581 |
| 4 | 831 | Signal Handler Function Associated with Multiple Signals | Variant | Allowed | sparse | 0.506 |
| 5 | 479 | Signal Handler Use of a Non-reentrant Function | Variant | Allowed | sparse | 0.476 |
| 6 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.460 |
| 7 | 663 | Use of a Non-reentrant Function in a Concurrent Context | Base | Allowed | sparse | 0.430 |
| 8 | 770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | sparse | 0.429 |
| 9 | 432 | Dangerous Signal Handler not Disabled During Sensitive Operations | Base | Allowed | dense | 0.498 |
| 10 | 123 | Write-what-where Condition | Base | Allowed | graph | 0.002 |

