## Vulnerability Description
Directus is a real-time API and App dashboard for managing SQL database content. A denial of service (DoS) attack by **field duplication in GraphQL** is a type of attack where an attacker exploits the flexibility of GraphQL to overwhelm a server by requesting the same field multiple times in a single query. This can cause the server to perform redundant computations and consume excessive resources, leading to a denial of service for legitimate users. Request to the endpoint /graphql are sent when visualizing graphs generated at a dashboard. By modifying the data sent and duplicating many times the fields a DoS attack is possible. This vulnerability is fixed in 10.12.0.

### Vulnerability Description Key Phrases
- **rootcause:** **field duplication in GraphQL**
- **impact:** DoS attack and denial of service
- **product:** Directus
- **version:** 10.12.0
- **component:** /graphql endpoint

## CVE Reference Links Content Summary
Based on the provided information, here's an analysis of CVE-2024-39895:

**Root Cause of Vulnerability:**
The vulnerability stems from the lack of a limit on the number of tokens parsed in GraphQL queries. This allows an attacker to craft a query with a large number of duplicated fields, leading to excessive resource consumption on the server.

**Weaknesses/Vulnerabilities Present:**
- **Unrestricted GraphQL Query Complexity:** The primary weakness is the absence of a mechanism to limit the complexity of GraphQL queries, specifically regarding the number of tokens being parsed. This allows for field duplication attacks.
- **Denial of Service (DoS):** The vulnerability allows for a denial-of-service attack by overwhelming the server with computationally intensive queries.

**Impact of Exploitation:**
- **Service Unavailability:** Successful exploitation leads to the server becoming unresponsive, causing a denial of service for legitimate users.
- **Resource Exhaustion:** The attack causes excessive consumption of server resources, leading to performance degradation and potential service crashes.

**Attack Vectors:**
- **Network:** The attack is performed over the network by sending a crafted HTTP request to the `/graphql` endpoint.
- **GraphQL API:** The attack leverages the GraphQL API to send a malicious query.

**Required Attacker Capabilities/Position:**
- **Network Access:** The attacker needs to be able to send HTTP requests to the vulnerable server.
- **Basic Understanding of GraphQL:** The attacker needs to understand how to construct GraphQL queries with duplicated fields.
- **Low Privileges:** The attacker only needs low privileges to exploit this vulnerability, as no special permissions are required to send the crafted queries.

**Technical Details:**
- The vulnerability occurs in the Directus application, specifically in how it handles GraphQL queries.
- The fix involves adding a configurable limit (`GRAPHQL_QUERY_TOKEN_LIMIT`) to the number of tokens parsed when processing GraphQL queries. This limit is set to 5000 by default.
- The patch introduces a `maxTokens` option in the GraphQL parser to limit the number of tokens, preventing excessively large queries from being processed.
- The vulnerability is located in the `/api/src/middleware/graphql.ts` file, and the fix is implemented by adding the maxTokens option when parsing the query with the `graphql-js` library

**Code Snippets:**
- The vulnerability is triggered by sending a GraphQL query where fields are massively duplicated, as seen in the provided PoC example:
```
{'query': 'query { query_4f4722ea: test_table_aggregated { max {id id id id id id id id id id } max {id id id id id id id id id id } max {id id id id id id id id id id } max {id id id id id id id id id id } max {id id id id id id id id id id } max {id id id id id id id id id id } max {id id id id id id id id id id } max {id id id id id id id id id id } max {id id id id id id id id id id } max {id id id id id id id id id id } } }'}
```
- The fix includes changes in `api/src/middleware/graphql.ts` which introduces the `maxTokens` setting to the parser:
```
 document = parse(new Source(query), {
        maxTokens: Number(env['GRAPHQL_QUERY_TOKEN_LIMIT']),
      });
```

**CVSS Metrics:**
- CVSS v3 Base Score: 6.5
- Attack Vector: Network
- Attack Complexity: Low
- Privileges Required: Low
- User Interaction: None
- Scope: Unchanged
- Confidentiality: None
- Integrity: None
- Availability: High
- CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H

**CVE ID:** CVE-2024-39895

**CWE:** CWE-400 (Uncontrolled Resource Consumption)

In summary, CVE-2024-39895 is a moderate severity vulnerability that allows an attacker to cause a denial of service by sending specially crafted GraphQL queries with duplicated fields, leading to excessive resource consumption. The fix introduces a limit on the number of tokens parsed in GraphQL queries.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | sparse | 0.708 |
| 2 | 1176 | Inefficient CPU Computation | Class | Allowed-with-Review | sparse | 0.689 |
| 3 | 674 | Uncontrolled Recursion | Class | Allowed-with-Review | sparse | 0.689 |
| 4 | 770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | sparse | 0.670 |
| 5 | 400 | Uncontrolled Resource Consumption | Class | Discouraged | sparse | 0.669 |
| 6 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 0.666 |
| 7 | 789 | Memory Allocation with Excessive Size Value | Variant | Allowed | sparse | 0.663 |
| 8 | 1333 | Inefficient Regular Expression Complexity | Base | Allowed | sparse | 0.657 |
| 9 | 943 | Improper Neutralization of Special Elements in Data Query Logic | Class | Allowed-with-Review | dense | 0.459 |
| 10 | 410 | Insufficient Resource Pool | Base | Allowed | graph | 0.003 |



# Complete CWE Specifications

CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')

CWE-1176: Inefficient CPU Computation

CWE-674: Uncontrolled Recursion

CWE-770: Allocation of Resources Without Limits or Throttling

CWE-400: Uncontrolled Resource Consumption

CWE-1284: Improper Validation of Specified Quantity in Input

CWE-789: Memory Allocation with Excessive Size Value

CWE-1333: Inefficient Regular Expression Complexity

CWE-943: Improper Neutralization of Special Elements in Data Query Logic

CWE-410: Insufficient Resource Pool