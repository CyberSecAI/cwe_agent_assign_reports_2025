## Vulnerability Description
Woodpecker is a simple yet powerful CI/CD engine with great extensibility. The server allow to create any user who can trigger a pipeline run malicious workflows 1. Those workflows can either lead to a host takeover that runs the agent executing the workflow. 2. Or allow to extract the secrets who would be normally provided to the plugins whos entrypoint are overwritten. This issue has been addressed in release version 2.7.0. Users are advised to upgrade. There are no known workarounds for this vulnerability.

### Vulnerability Description Key Phrases
- **impact:** host takeover
- **vector:** malicious workflows
- **attacker:** user who can trigger a pipeline run
- **product:** Woodpecker
- **version:** before 2.7.0

### CWE for similar CVE Descriptions
### Primary CWE Match
CWE-NVD-noinfo

#### Top CWEs
- CWE-NVD-noinfo (Count: 6)

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability described:

**Root Cause of Vulnerability:**

The vulnerability stems from the ability to manipulate the workspace base path for plugins, specifically the `plugins/docker` image, allowing an attacker to overwrite the plugin's entrypoint and gain code execution in the privileged container or leak secrets.

**Weaknesses/Vulnerabilities Present:**

1.  **Unrestricted Workspace Base Path:** The server allowed users to define a custom workspace base path that is then mounted into the plugin container.
2.  **Privileged Container Execution:**  The `plugins/docker` image, runs in privileged mode, which is necessary for building docker images within the CI environment but also opens the door for this type of attack.
3.  **Insufficient Input Validation:** The system only checked if "Commands" and "Entrypoint" were unset before allowing the container to run in privileged mode using the "IsPlugin" function, but not the workspace configuration.
4.  **Secret Leakage:** By overwriting the entrypoint of a plugin, an attacker could extract secrets intended for the plugin that were normally provided through environment variables.

**Impact of Exploitation:**

1.  **Host Takeover:** An attacker can gain code execution inside the privileged container, potentially leading to a host takeover of the agent executing the workflow.
2.  **Secret Exfiltration:** An attacker can extract secrets provided to plugins by overwriting the entrypoint and dumping environment variables to the logs which can contain sensitive information.
3.  **Arbitrary Code Execution:** An attacker can run arbitrary commands on the agent machine by replacing the original plugin's entrypoint with a malicious one.

**Attack Vectors:**

1.  **Workflow Configuration Manipulation:** An attacker crafts a malicious workflow YAML file with a custom workspace base path that is designed to overwrite the `plugins/docker` entrypoint.
2. **User Creation:** The server allowed any user to trigger a pipeline, if an attacker can get access to a user on the system they can trigger a malicious pipeline run.

**Required Attacker Capabilities/Position:**

1.  **Access to a User Account:** An attacker needs a valid user account on the Woodpecker CI server to create or modify pipelines or a "gated" repo feature bypass.
2.  **Knowledge of Workflow Syntax:** An attacker needs to be familiar with the Woodpecker CI workflow syntax to manipulate the `workspace` and `steps` configurations.
3.  **Understanding of the Vulnerability:** The attacker needs knowledge of the plugin execution model and the privileged nature of the `plugins/docker` image.

**Additional Information**

- The vulnerability was fixed in version 2.7.0.
- A workaround was to enable the "gated" repo feature and review each change upfront.
- The pull request [#3933](https://github.com/woodpecker-ci/woodpecker/pull/3933) addresses the vulnerability.
- The vulnerability is tracked as CVE-2024-41121.
- The vulnerability has a CVSS v3 score of 8.8.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.148 |
| 2 | 1333 | Inefficient Regular Expression Complexity | Base | Allowed | sparse | 0.146 |
| 3 | 212 | Improper Removal of Sensitive Information Before Storage or Transfer | Base | Allowed | sparse | 0.145 |
| 4 | 789 | Memory Allocation with Excessive Size Value | Variant | Allowed | sparse | 0.144 |
| 5 | 1336 | Improper Neutralization of Special Elements Used in a Template Engine | Base | Allowed | sparse | 0.143 |
| 6 | 22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | sparse | 0.141 |
| 7 | 214 | Invocation of Process Using Visible Sensitive Information | Base | Allowed | sparse | 0.140 |
| 8 | 285 | Improper Authorization | Class | Discouraged | sparse | 0.140 |
| 9 | 88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | dense | 0.470 |
| 10 | 78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | graph | 0.003 |



# Complete CWE Specifications

CWE-863: Incorrect Authorization

CWE-1333: Inefficient Regular Expression Complexity

CWE-212: Improper Removal of Sensitive Information Before Storage or Transfer

CWE-789: Memory Allocation with Excessive Size Value

CWE-1336: Improper Neutralization of Special Elements Used in a Template Engine

CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')

CWE-214: Invocation of Process Using Visible Sensitive Information

CWE-285: Improper Authorization

CWE-88: Improper Neutralization of Argument Delimiters in a Command ('Argument Injection')

CWE-78: Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')