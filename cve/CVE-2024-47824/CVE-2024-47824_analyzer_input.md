# Vulnerability Information: CVE-2024-47824

## Vulnerability Description
matrix-react-sdk is react-based software development kit for inserting a Matrix chat/VOIP client into a web page. Starting in version 3.18.0 and before 3.102.0, matrix-react-sdk allows a malicious homeserver to potentially steal message keys for a room when a user invites another user to that room, via injection of a malicious device controlled by the homeserver. This is possible because matrix-react-sdk before 3.102.0 shared historical message keys on invite. Version 3.102.0 fixes this issue by disabling **sharing message keys on invite** by removing calls to the vulnerable functionality. No known workarounds are available.

### Vulnerability Description Key Phrases
- **rootcause:** **sharing message keys on invite**
- **impact:** steal message keys for a room
- **vector:** injection of a malicious device
- **attacker:** malicious homeserver
- **product:** matrix-react-sdk
- **version:** 3.18.0 to before 3.102.0

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2024-47824:

**Root Cause of Vulnerability:**
The vulnerability stems from the `matrix-react-sdk`'s practice of sharing historical message keys with newly invited users. This was done by calling `MatrixClient.sendSharedHistoryKeys` in the matrix-js-sdk.

**Weaknesses/Vulnerabilities Present:**
- The core vulnerability lies in the insecure sharing of message keys upon invitation. A malicious homeserver could inject a malicious device controlled by the server and use this to potentially gain access to historical message keys.
- The `matrix-react-sdk` was vulnerable because it was calling the vulnerable `sendSharedHistoryKeys` function.

**Impact of Exploitation:**
- A malicious homeserver could exploit this vulnerability to steal message keys for a room. This would allow the attacker to decrypt and read past messages in the room, violating the confidentiality of the communication.

**Attack Vectors:**
- The primary attack vector involves a malicious homeserver injecting a controlled device into the room. The homeserver then triggers an invite, causing the vulnerable `sendSharedHistoryKeys` to be called, which can potentially expose keys to the injected device.

**Required Attacker Capabilities/Position:**
- The attacker needs to control a malicious homeserver.
- The attacker's homeserver needs to be involved in a room where a user is being invited by a user employing the vulnerable `matrix-react-sdk` version.

**Additional Information:**
- The vulnerability was addressed by disabling the sharing of message keys on invite, specifically by removing the calls to `MatrixClient.sendSharedHistoryKeys`.
- This vulnerability is related to a vulnerability in `matrix-js-sdk` tracked as [CVE-2024-47080](https://github.com/advisories/GHSA-4jf8-g8wp-cx7c). While the underlying cause is in `matrix-js-sdk`, the specific use case of sharing keys on invite in `matrix-react-sdk` is considered a separate vulnerability.
- The vulnerable code was removed in commit `6fc9d7641c51ca3db8225cf58b9d6e6fdd2d6556` which was part of the pull request #12618.
- Versions of `matrix-react-sdk` prior to 3.102.0 were vulnerable.
- The fix was implemented in matrix-react-sdk version 3.102.0.
- The project has been archived and moved to [element-hq/matrix-react-sdk](https://github.com/element-hq/matrix-react-sdk) after the fix, meaning that no releases in the new location were vulnerable.
- The vulnerability was discovered by `dkasak`.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 290 | Authentication Bypass by Spoofing | Base | Allowed | sparse | 0.703 |
| 2 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | sparse | 0.566 |
| 3 | 770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | sparse | 0.541 |
| 4 | 93 | Improper Neutralization of CRLF Sequences ('CRLF Injection') | Base | Allowed | sparse | 0.521 |
| 5 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.514 |
| 6 | 1333 | Inefficient Regular Expression Complexity | Base | Allowed | sparse | 0.514 |
| 7 | 116 | Improper Encoding or Escaping of Output | Class | Allowed-with-Review | sparse | 0.505 |
| 8 | 322 | Key Exchange without Entity Authentication | Base | Allowed | sparse | 0.504 |
| 9 | 941 | Incorrectly Specified Destination in a Communication Channel | Base | Allowed | dense | 0.389 |
| 10 | 113 | Improper Neutralization of CRLF Sequences in HTTP Headers ('HTTP Request/Response Splitting') | Variant | Allowed | graph | 0.003 |

