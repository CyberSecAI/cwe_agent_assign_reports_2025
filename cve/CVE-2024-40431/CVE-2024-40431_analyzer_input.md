# Vulnerability Information: CVE-2024-40431

## Vulnerability Description
A **lack of input validation** in Realtek SD card reader driver before 10.0.26100.21374 through the implementation of the IOCTL_SCSI_PASS_THROUGH control of the SD card reader driver allows an attacker to write to predictable kernel memory locations, even as a low-privileged user.

### Vulnerability Description Key Phrases
- **rootcause:** **lack of input validation**
- **impact:** write to predictable kernel memory locations
- **vector:** ioctl
- **attacker:** low-privileged user
- **product:** Realtek SD card reader driver
- **version:** before 10.0.26100.21374
- **component:** IOCTL_SCSI_PASS_THROUGH control

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of CVE-2024-40431:

**Root Cause:**

- The root cause is an insufficient bounds check in the `IOCTL_SCSI_PASS_THROUGH` handler within the `RtsPer.sys` driver.
- Specifically, the driver uses the `DataBufferOffset` field from the `SCSI_PASS_THROUGH` structure, which is provided by user-mode, to calculate the destination address for a data copy operation.
- The driver fails to validate if this offset remains within the bounds of the `IRP::SystemBuffer`, leading to out-of-bounds memory access.

**Weaknesses/Vulnerabilities:**

- **Arbitrary Kernel Memory Write:**  The primary vulnerability is the ability to write to arbitrary kernel memory. By manipulating the `DataBufferOffset` in the `SCSI_PASS_THROUGH` structure, an attacker can control the write destination.
- **Lack of Bounds Checking:** The core issue is the missing validation on `DataBufferOffset` against the size of the `IRP::SystemBuffer`.
- **Abuse of IOCTL_SCSI_PASS_THROUGH:**  The vulnerability stems from the handler of `IOCTL_SCSI_PASS_THROUGH` not correctly validating offsets before performing memory copy operations.

**Impact of Exploitation:**

- **Arbitrary Code Execution:** An attacker can overwrite critical kernel data structures, such as CI!g\_CiOptions (used for driver signature enforcement), and achieve arbitrary code execution. This would effectively allow the attacker to disable driver signature verification, load unsigned drivers, and fully compromise the system.
- **Privilege Escalation:**  A non-privileged user can elevate their privileges to kernel level by exploiting this vulnerability.
- **System Instability:** Incorrect memory writes can lead to system crashes (BSOD).

**Attack Vectors:**

- **User-Mode Application:** The attack is launched from user mode by an application using `DeviceIoControl` to send crafted `IOCTL_SCSI_PASS_THROUGH` requests to the driver.

**Required Attacker Capabilities/Position:**

- **Access to the Device Object:** The attacker needs to have access to the device object created by `RtsPer.sys`, which, based on the content, is available to all users.
- **Ability to Send IOCTLs:** The attacker needs to be able to send IO control codes (`IOCTL_SCSI_PASS_THROUGH`) to the driver through the device object.
- **Knowledge of Kernel Memory Layout (Indirect):**  The exploit requires a mechanism to determine the address of a target in kernel memory. This is accomplished using a combination of the heap massage, and the CVE-2022-25479 stack leak.

**Additional Details (Beyond CVE Description):**

- **Exploitation Technique:** The blog post details a practical method to exploit the vulnerability. It involves leveraging the stack leak vulnerability (CVE-2022-25479) to obtain the address of the `IRP::SystemBuffer`, which is then used to calculate the offset for the desired kernel write address.
- **Targeted Address Example:** The blog post specifically mentions using the `CI!g_CiOptions` address as an example of a targeted kernel location for overwriting in order to load unsigned drivers.
- **Stability:** The method of re-using the same system buffer address after leaking it multiple times is highlighted as fairly stable.
- **Mitigation**: The vulnerability is fixed in `RtsPer.sys` version 10.0.26100.21374 or higher.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 787 | Out-of-bounds Write | Base | Allowed | sparse | 0.283 |
| 2 | 20 | Improper Input Validation | Class | Discouraged | sparse | 0.281 |
| 3 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.280 |
| 4 | 119 | Improper Restriction of Operations within the Bounds of a Memory Buffer | Class | Discouraged | sparse | 0.280 |
| 5 | 1285 | Improper Validation of Specified Index, Position, or Offset in Input | Base | Allowed | sparse | 0.279 |
| 6 | 476 | NULL Pointer Dereference | Base | Allowed | sparse | 0.267 |
| 7 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 0.264 |
| 8 | 269 | Improper Privilege Management | Class | Discouraged | sparse | 0.252 |
| 9 | 782 | Exposed IOCTL with Insufficient Access Control | Variant | Allowed | dense | 0.619 |
| 10 | 825 | Expired Pointer Dereference | Base | Allowed | graph | 0.003 |

