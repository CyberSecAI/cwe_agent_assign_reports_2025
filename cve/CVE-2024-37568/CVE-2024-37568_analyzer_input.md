# Vulnerability Information: CVE-2024-37568

## Vulnerability Description
lepture Authlib before 1.3.1 has **algorithm confusion with asymmetric public keys**. Unless an algorithm is specified in a jwt.decode call, HMAC verification is allowed with any asymmetric public key. (This is similar to CVE-2022-29217 and CVE-2024-33663.)

### Vulnerability Description Key Phrases
- **rootcause:** **algorithm confusion with asymmetric public keys**
- **impact:** HMAC verification is allowed with any asymmetric public key
- **product:** lepture Authlib
- **version:** before 1.3.1

## CVE Reference Links Content Summary
Based on the provided information, here's an analysis of CVE-2024-37568:

**Root Cause of Vulnerability:**

The vulnerability stems from a lack of proper algorithm verification in the `jwt.decode` function of the `authlib` library. Specifically, when the `algorithm` parameter is not explicitly specified during JWT decoding, the library permits HMAC verification using asymmetric public keys. This means that an attacker could craft a malicious JWT using a symmetric HMAC algorithm with a public key intended for asymmetric cryptography (e.g. RSA) and successfully have it validated by the vulnerable library.

**Weaknesses/Vulnerabilities Present:**

*   **Algorithm Confusion:** The core issue is the library's failure to distinguish between symmetric (HMAC) and asymmetric (e.g., RSA) key types during JWT verification, leading to the possibility of using a public key as a secret key.
*   **Missing Algorithm Check:** The library does not enforce or warn about the omission of the `algorithm` parameter in `jwt.decode`, leaving it up to the user to specify, which often leads to insecure configurations.
*   **Inadequate Key Type Verification:** The library doesn't properly validate whether the provided key is appropriate for the specified algorithm. Specifically it does not check if a key is asymmetric when it's provided to a symmetric algorithm

**Impact of Exploitation:**

*   **Token Forgery:** Attackers can forge valid JWTs by using a public key as a secret key with a symmetric algorithm (like HS256), effectively bypassing the intended security mechanisms, thus allowing them to impersonate legitimate users.
*   **Unauthorized Access:** By crafting forged tokens, attackers can gain unauthorized access to resources or functionalities protected by JWT-based authentication.
*  **Privilege Escalation**: Attackers can potentially escalate their privileges by forging JWTs with higher access permissions.

**Attack Vectors:**

*   **Malicious JWT Crafting:** An attacker crafts a JWT using a symmetric HMAC algorithm (e.g., HS256) and signs it using a public key (intended for asymmetric cryptography such as RSA).
*   **Bypassing Signature Verification:** By leveraging the algorithm confusion, the attacker's crafted JWT bypasses the server's intended verification process.

**Required Attacker Capabilities/Position:**

*   **Knowledge of Public Key:** The attacker needs access to the public key used by the server for asymmetric cryptography. This key is typically public information.
*   **Ability to Craft JWT:** The attacker must be able to construct a JWT with a chosen payload and the ability to sign the JWT using a symmetric algorithm and the public key as a secret.
*   **Network Access to Vulnerable System**: The attacker needs to be able to send requests with the forged JWT to the server.

**Additional Information:**

*   The vulnerability affects `authlib` versions prior to 1.3.1.
*   The issue is also present in the `joserfc` library (Authlib's underlying library for JOSE).
*   The vulnerability is similar to CVE-2022-29217 and CVE-2024-33663 but has a higher severity because it applies to all verification with asymmetric public keys and not just specific formats.
*   The fix implemented in version 1.3.1 includes a blocklist of public key formats when verifying with HMAC.
*   The recommended fix is to make the algorithm field mandatory when decoding or at least throw a warning when not used to prevent this class of vulnerabilties, and ensure the key is appropriate for the algorithm used.
*  The error message when doing HMAC verification with a public key should be improved to more explicitly state what the problem is.

The provided information gives more detail than the official CVE description, elaborating on the specifics of the algorithm confusion, the method of exploitation, and the impact of this vulnerability.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 327 | Use of a Broken or Risky Cryptographic Algorithm | Class | Allowed-with-Review | sparse | 0.289 |
| 2 | 405 | Asymmetric Resource Consumption (Amplification) | Class | Allowed-with-Review | sparse | 0.282 |
| 3 | 325 | Missing Cryptographic Step | Base | Allowed | sparse | 0.282 |
| 4 | 328 | Use of Weak Hash | Base | Allowed | sparse | 0.267 |
| 5 | 203 | Observable Discrepancy | Base | Allowed | sparse | 0.264 |
| 6 | 780 | Use of RSA Algorithm without OAEP | Variant | Allowed | sparse | 0.258 |
| 7 | 330 | Use of Insufficiently Random Values | Class | Discouraged | sparse | 0.253 |
| 8 | 321 | Use of Hard-coded Cryptographic Key | Variant | Allowed | sparse | 0.252 |
| 9 | 304 | Missing Critical Step in Authentication | Base | Allowed | dense | 0.477 |
| 10 | 208 | Observable Timing Discrepancy | Base | Allowed | graph | 0.002 |

