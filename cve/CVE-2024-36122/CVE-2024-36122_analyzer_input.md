# Vulnerability Information: CVE-2024-36122

## Vulnerability Description
Discourse is an open-source discussion platform. Prior to version 3.2.3 on the `stable` branch and version 3.3.0.beta4 on the `beta` and `tests-passed` branches, moderators using the review queue to review users may see a users email address even when the Allow moderators to view email addresses setting is disabled. This issue is patched in version 3.2.3 on the `stable` branch and version 3.3.0.beta4 on the `beta` and `tests-passed` branches. As possible workarounds, either prevent moderators from accessing the review queue or disable the approve suspect users site setting and the must approve users site setting to prevent users from being added to the review queue.

### Vulnerability Description Key Phrases
- **impact:** see users email address
- **attacker:** moderators
- **product:** Discourse
- **version:** prior to 3.2.3 on stable, 3.3.0.beta4 on beta and tests-passed
- **component:** review queue

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2024-36122:

**Root Cause:**
The vulnerability stems from the `ReviewableUserSerializer` in Discourse not properly checking user scopes when including email addresses in the payload. Specifically, it fails to prevent moderators from viewing user email addresses in the review queue when the "Allow moderators to view email addresses" setting is disabled.

**Weaknesses/Vulnerabilities Present:**
- **Information Disclosure:** The vulnerability exposes user email addresses to moderators who should not have access, violating the intended access control settings.
- **Inadequate Scope Check:** The `ReviewableUserSerializer` does not correctly enforce permission checks based on the current user's scope in the context of the review queue. It was including the email regardless of the `moderators_view_emails` setting if the user was in a reviewable state.

**Impact of Exploitation:**
- Unauthorized access to user email addresses by moderators. This could potentially lead to privacy violations.

**Attack Vectors:**
- The attack vector is via the network (web application interface).
- A moderator can access the review queue to view user data.

**Required Attacker Capabilities/Position:**
- The attacker must be a moderator within a Discourse instance.
- The "Allow moderators to view email addresses" site setting must be disabled.
- Users must be placed into the review queue (e.g. by the "must approve users" setting).
- The attacker needs to access the review queue in order to view user data.

**Additional details from the provided content:**
- The vulnerability is present in Discourse versions `stable <= 3.2.2`, `beta <= 3.3.0.beta3`, and `tests-passed <= 3.3.0.beta3`.
- Patched versions are `stable >= 3.2.3`, `beta >= 3.3.0.beta4`, and `tests-passed >= 3.3.0.beta4`.
- The fix involves modifying the `ReviewableUserSerializer` to exclude email addresses based on user scope. A new method `include_email?` was added to check if the current scope has the ability to check emails, removing the email from the payload if not. This check is performed within the serializer's `attributes` method.

**CVSS Score:**
- CVSS v3 base score is 2.4/10, classified as Low severity.
- CVSS vector string is `CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:U/C:L/I:N/A:N`

In summary, this vulnerability is an information disclosure issue where moderators are able to see user emails under specific conditions even if they should not be able to. The fix ensures that the email is only included when the moderator is allowed to view emails.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 0.247 |
| 2 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.230 |
| 3 | 1390 | Weak Authentication | Class | Allowed-with-Review | sparse | 0.214 |
| 4 | 285 | Improper Authorization | Class | Discouraged | sparse | 0.214 |
| 5 | 835 | Loop with Unreachable Exit Condition ('Infinite Loop') | Base | Allowed | sparse | 0.213 |
| 6 | 538 | Insertion of Sensitive Information into Externally-Accessible File or Directory | Base | Allowed | sparse | 0.208 |
| 7 | 525 | Use of Web Browser Cache Containing Sensitive Information | Variant | Allowed | sparse | 0.206 |
| 8 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | sparse | 0.205 |
| 9 | 359 | Exposure of Private Personal Information to an Unauthorized Actor | Base | Allowed | dense | 0.433 |
| 10 | 226 | Sensitive Information in Resource Not Removed Before Reuse | Base | Allowed | graph | 0.002 |

