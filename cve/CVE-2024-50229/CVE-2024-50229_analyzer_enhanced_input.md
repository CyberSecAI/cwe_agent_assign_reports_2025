## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved nilfs2 fix potential deadlock with newly created symlinks Syzbot reported that page_symlink(), called by nilfs_symlink(), triggers memory reclamation involving the filesystem layer, which can result in **circular lock dependencies among the reader/writer semaphore nilfs->ns_segctor_sem, s_writers percpu_rwsem (intwrite) and the fs_reclaim pseudo lock**. This is because after commit 21fc61c73c39 (dont put symlink bodies in pagecache into highmem), the gfp flags of the page cache for symbolic links are overwritten to GFP_KERNEL via inode_nohighmem(). This is not a problem for symlinks read from the backing device, because the __GFP_FS flag is dropped after inode_nohighmem() is called. However, when a new symlink is created with nilfs_symlink(), the gfp flags remain overwritten to GFP_KERNEL. Then, memory allocation called from page_symlink() etc. triggers memory reclamation including the FS layer, which may call nilfs_evict_inode() or nilfs_dirty_inode(). And these can cause a deadlock if they are called while nilfs->ns_segctor_sem is held Fix this issue by dropping the __GFP_FS flag from the page cache GFP flags of newly created symlinks in the same way that nilfs_new_inode() and __nilfs_read_inode() do, as a workaround until we adopt nofs allocation scope consistently or improve the locking constraints.

### Vulnerability Description Key Phrases
- **rootcause:** **circular lock dependencies among the reader/writer semaphore nilfs->ns_segctor_sem, s_writers percpu_rwsem (intwrite) and the fs_reclaim pseudo lock**
- **impact:** potential deadlock
- **attacker:** Syzbot
- **product:** Linux kernel
- **component:** nilfs2

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root Cause:**
The root cause of the vulnerability is the incorrect handling of GFP flags for newly created symbolic links in the nilfs2 filesystem. After commit 21fc61c73c39, the page cache GFP flags for symlinks are overwritten to `GFP_KERNEL` via `inode_nohighmem()`. While symlinks read from the backing device correctly drop the `__GFP_FS` flag after this, newly created symlinks retain the `GFP_KERNEL` flag which can lead to a deadlock.

**Weaknesses/Vulnerabilities:**
- **Incorrect GFP Flag Handling:** The `__GFP_FS` flag is not dropped for newly created symlinks, leading to memory allocation issues.
- **Circular Lock Dependencies:** The issue triggers memory reclamation that involves the filesystem layer, leading to circular lock dependencies involving `nilfs->ns_segctor_sem`, `s_writers percpu_rwsem (intwrite)` and `fs_reclaim`.
- **Deadlock:** The circular dependencies can lead to a deadlock if `nilfs_evict_inode()` or `nilfs_dirty_inode()` are called while `nilfs->ns_segctor_sem` is held.

**Impact of Exploitation:**
- **Denial of Service:** The deadlock can cause the system to become unresponsive, leading to a denial of service.

**Attack Vectors:**
- **Symbolic Link Creation:** An attacker would need to create a new symbolic link on a nilfs2 filesystem. This action triggers the vulnerable code path.
- The vulnerability was reported by syzbot, which uses automated fuzzing. Therefore, the specific user-space trigger is unknown, but it is reproducible with syzkaller.

**Required Attacker Capabilities/Position:**
- **File system access:** The attacker must be able to create a symlink on a nilfs2 filesystem.

**Additional Details:**

- The fix involves dropping the `__GFP_FS` flag from the page cache GFP flags of newly created symlinks, similar to how it's done in `nilfs_new_inode()` and `__nilfs_read_inode()`.
- This fix is considered a workaround until more robust solutions, such as consistently adopting nofs allocation or improving locking constraints, can be implemented.
- The vulnerability was reported by syzbot, and the provided links give further context on the issue and fix.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 59 | Improper Link Resolution Before File Access ('Link Following') | Base | Allowed | sparse | 0.991 |
| 2 | 61 | UNIX Symbolic Link (Symlink) Following | Compound | Allowed | sparse | 0.956 |
| 3 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.934 |
| 4 | 833 | Deadlock | Base | Allowed | sparse | 0.919 |
| 5 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.913 |
| 6 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.882 |
| 7 | 88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | sparse | 0.856 |
| 8 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.854 |
| 9 | 62 | UNIX Hard Link | Variant | Allowed | dense | 0.552 |
| 10 | 73 | External Control of File Name or Path | Base | Allowed | graph | 0.002 |



# Complete CWE Specifications

CWE-59: Improper Link Resolution Before File Access ('Link Following')

CWE-61: UNIX Symbolic Link (Symlink) Following

CWE-667: Improper Locking

CWE-833: Deadlock

CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')

CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition

CWE-88: Improper Neutralization of Argument Delimiters in a Command ('Argument Injection')

CWE-401: Missing Release of Memory after Effective Lifetime

CWE-62: UNIX Hard Link

CWE-73: External Control of File Name or Path