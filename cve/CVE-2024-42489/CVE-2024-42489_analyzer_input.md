# Vulnerability Information: CVE-2024-42489

## Vulnerability Description
Pro Macros provides XWiki rendering macros. **Missing escaping in the Viewpdf macro** allows any user with view right on the `CKEditor.HTMLConverter` page or edit or comment right on any page to perform remote code execution. Other macros like Viewppt are vulnerable to the same kind of attack. This vulnerability is fixed in 1.10.1.

### Vulnerability Description Key Phrases
- **rootcause:** **Missing escaping in the Viewpdf macro**
- **impact:** remote code execution
- **attacker:** any user with view right on the `CKEditor.HTMLConverter` page or edit or comment right on any page
- **product:** Pro Macros
- **version:** before 1.10.1
- **component:** Viewpdf macro

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**

*   The vulnerability stems from a lack of proper input sanitization in the `Viewpdf` macro and similar macros (`Viewppt`, `Viewdoc`, `Viewxls`, and `Viewfile`). The macro's `name` parameter (or `att--filename`) is inserted into a context where XWiki syntax is executed without prior escaping, leading to potential code injection. Specifically, the `Viewpdf.xml` file shows that the `filename` parameter was not properly escaped before being used in a `pdfviewer` macro (and similarly for other macros).

**Weaknesses/Vulnerabilities:**

*   **Remote Code Execution (RCE):**  The primary vulnerability is RCE. By injecting malicious XWiki syntax, attackers can execute arbitrary Groovy code on the server. This is made possible by the vulnerable macros, which directly use the provided parameter without sanitizing it.
*   **Missing Input Sanitization:** The core issue is the lack of escaping/sanitization of user-provided input (`name` parameter in the macros). This allows the injection of malicious code.

**Impact of Exploitation:**

*   **Full System Compromise:** Successful exploitation allows attackers to access and modify all data stored in the XWiki instance.
*   **Server Access:** It's possible that an attacker could leverage RCE to gain access to the server on which XWiki is running.
*   **Confidentiality, Integrity, and Availability:** This vulnerability affects all three aspects of security, as the attacker could read, modify, and destroy the data, causing a complete compromise of the system.

**Attack Vectors:**

*   **Macro Parameter Injection:** The primary attack vector is through the `name` parameter (or `att--filename` parameter) of the vulnerable macros. This parameter can be manipulated to inject malicious code.
*   **CKEditor.HTMLConverter:** Attackers can also exploit this vulnerability using the `CKEditor.HTMLConverter`, accessible with view rights, to inject the malicious macro call via a crafted javascript snippet.

**Required Attacker Capabilities/Position:**

*   **No Authentication Required:** The vulnerability can be exploited by unauthenticated users (guests) who have view rights to any page. This is due to the fact that the CKEditor.HTMLConverter can be accessed with view rights.
*   **Knowledge of XWiki Syntax:** The attacker needs to understand how XWiki syntax works to construct a successful injection.
*   **Ability to Submit Crafted Requests:** The attacker needs to be able to submit HTTP requests with the malicious parameter through the vulnerable macro.

**Additional Notes:**

*   The vulnerability affects versions `1.0` and above of the `xwiki-pro-macros` package.
*   The vulnerability was patched in version `1.10.1` by properly escaping the macro parameters.
*   The provided commit diffs show that the fix involves using `$services.rendering.escape()` on the `name`/`filename` parameters before using them in the macro.
*   The vulnerability is rated as **Critical** with a CVSS score of 10.0.
*  The provided content contains a PoC (Proof of Concept) that demonstrates how to exploit the vulnerability.
* The CVE ID associated with this vulnerability is **CVE-2024-42489**

In summary, this is a critical vulnerability due to its ease of exploitation, lack of required authentication, and the severe impact of full system compromise. The vulnerability was fixed by ensuring proper escaping of user-provided parameters before execution.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 116 | Improper Encoding or Escaping of Output | Class | Allowed-with-Review | sparse | 0.398 |
| 2 | 352 | Cross-Site Request Forgery (CSRF) | Compound | Allowed | sparse | 0.333 |
| 3 | 862 | Missing Authorization | Class | Allowed-with-Review | sparse | 0.324 |
| 4 | 1336 | Improper Neutralization of Special Elements Used in a Template Engine | Base | Allowed | sparse | 0.318 |
| 5 | 306 | Missing Authentication for Critical Function | Base | Allowed | sparse | 0.295 |
| 6 | 285 | Improper Authorization | Class | Discouraged | sparse | 0.293 |
| 7 | 356 | Product UI does not Warn User of Unsafe Actions | Base | Allowed | sparse | 0.292 |
| 8 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | sparse | 0.292 |
| 9 | 152 | Improper Neutralization of Macro Symbols | Variant | Allowed | dense | 0.551 |
| 10 | 494 | Download of Code Without Integrity Check | Base | Allowed | graph | 0.002 |

