# Vulnerability Information: CVE-2024-50087

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved btrfs fix **uninitialized pointer free** on read_alloc_one_name() error The function read_alloc_one_name() does not initialize the name field of the passed fscrypt_str struct if kmalloc fails to allocate the corresponding buffer. Thus, it is not guaranteed that fscrypt_str.name is initialized when freeing it. This is a follow-up to the linked patch that fixes the remaining instances of the bug introduced by commit e43eec81c516 (btrfs use struct qstr instead of name and namelen pairs).

### Vulnerability Description Key Phrases
- **rootcause:** **uninitialized pointer free**
- **product:** Linux kernel
- **component:** read_alloc_one_name() function in btrfs

## CVE Reference Links Content Summary
The provided content relates to the following vulnerability:

**Root cause of vulnerability:**
The `read_alloc_one_name()` function in the Btrfs filesystem driver does not initialize the `name` field of the `fscrypt_str` struct when `kmalloc` fails to allocate the buffer for the name. This results in the `fscrypt_str.name` pointer not being guaranteed to be initialized before being freed, which can lead to a use-after-free vulnerability.

**Weaknesses/vulnerabilities present:**
- Uninitialized pointer: The `fscrypt_str.name` pointer is not guaranteed to be initialized if `kmalloc` fails during the allocation of memory for the name.
- Use-after-free: If `kmalloc` fails, the uninitialized `fscrypt_str.name` might be freed, leading to a use-after-free.

**Impact of exploitation:**
- The vulnerability can lead to a crash or potentially arbitrary code execution due to the use-after-free.

**Attack vectors:**
- The vulnerability is triggered when reading directory entries with encrypted filenames in Btrfs. A specific scenario that causes `kmalloc` to fail would be needed to trigger it.

**Required attacker capabilities/position:**
- An attacker needs to be able to trigger the error condition in `kmalloc` within the `read_alloc_one_name()` function while reading directory entries with encrypted filenames in Btrfs.
- This implies the attacker has to be able to interact with a Btrfs filesystem where encrypted filenames are present and be able to cause memory allocation to fail, possibly through a large number of requests.

**Additional details:**
- The fix involves initializing the `fscrypt_str name` structure to `{ 0 }` before any potential kmalloc failure. This ensures that the `name` field is always initialized, preventing a use-after-free in case `kmalloc` fails.
- The fix is applied to the `replay_one_name` and `check_item_in_log` functions within `fs/btrfs/tree-log.c`.
- The vulnerability was introduced in commit `e43eec81c516` ("btrfs: use struct qstr instead of name and namelen pairs")

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 909 | Missing Initialization of Resource | Class | Allowed-with-Review | sparse | 0.548 |
| 2 | 252 | Unchecked Return Value | Base | Allowed | sparse | 0.489 |
| 3 | 824 | Access of Uninitialized Pointer | Base | Allowed | sparse | 0.484 |
| 4 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.484 |
| 5 | 908 | Use of Uninitialized Resource | Base | Allowed | sparse | 0.468 |
| 6 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.467 |
| 7 | 457 | Use of Uninitialized Variable | Variant | Allowed | sparse | 0.459 |
| 8 | 665 | Improper Initialization | Class | Discouraged | sparse | 0.456 |
| 9 | 190 | Integer Overflow or Wraparound | Base | Allowed | dense | 0.457 |
| 10 | 456 | Missing Initialization of a Variable | Variant | Allowed | graph | 0.003 |

