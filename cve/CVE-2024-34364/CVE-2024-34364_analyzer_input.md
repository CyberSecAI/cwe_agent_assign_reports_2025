# Vulnerability Information: CVE-2024-34364

## Vulnerability Description
Envoy is a cloud-native, open source edge and service proxy. Envoy exposed an out-of-memory (OOM) vector from the mirror response, since async HTTP client will buffer the response with an unbounded buffer.

### Vulnerability Description Key Phrases
- **impact:** out-of-memory (OOM)
- **product:** Envoy

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**

- The vulnerability stems from the way Envoy's async HTTP client handles mirror responses. It buffers the entire response in memory without any limits, leading to potential out-of-memory (OOM) conditions.

**Weaknesses/Vulnerabilities:**

- **Unbounded Buffer:** The primary vulnerability is the lack of a size limit on the buffer used to store mirror responses. This allows a malicious backend to send extremely large responses, which will be fully buffered.
- **Vulnerable Components:**  Multiple components within Envoy that utilize the HTTP async client are susceptible, including:
    - wasm filter
    - lua filter
    - ext_proc
    - oauth filter
    - ext_authz
    - jwks_fetcher
    - gcp_auther_filter
    - aws_metadata_fetcher
    - opentelemetry/http_trace_exporter
    - opentelemetry/dynatrace/sampler_config_provider
    - config_subscription/rest/rest_api_fetcher
    - rate_limiter

**Impact of Exploitation:**

- **Denial of Service (DoS):** An attacker can cause a denial of service by triggering an out-of-memory error in Envoy.
- **OOM:**  The Envoy process will be terminated due to excessive memory consumption.

**Attack Vectors:**

- **Malicious Backend:** A malicious backend server sending large HTTP response messages to a mirror service.
- The vulnerability is network-based.

**Required Attacker Capabilities/Position:**

- **Network Access:** The attacker needs to be able to send HTTP responses to a service that is being mirrored by Envoy.
- **Control over Mirrored Backend:** The attacker must have control of the backend service that is being mirrored, allowing them to send arbitrarily large responses.
- **Low Privileges:** Low privileges are required to exploit this vulnerability.
- **User Interaction**: User interaction is required to initiate the request that triggers the mirroring.

**Mitigation:**

- **Disable Mirror Response Buffering:** Patched versions disable buffering for mirror responses, as Envoy does not use them.
- **Configurable Buffer Limit:** Provide a configuration option for the HTTP async client that includes a hard limit on buffer size. This limit can be set through a runtime key.

**CVSS Score:**
- Moderate: 5.7
- CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:N/I:N/A:H

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | sparse | 0.075 |
| 2 | 789 | Memory Allocation with Excessive Size Value | Variant | Allowed | sparse | 0.074 |
| 3 | 409 | Improper Handling of Highly Compressed Data (Data Amplification) | Base | Allowed | sparse | 0.071 |
| 4 | 674 | Uncontrolled Recursion | Class | Allowed-with-Review | sparse | 0.068 |
| 5 | 697 | Incorrect Comparison | Pillar | Discouraged | sparse | 0.067 |
| 6 | 120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | Base | Allowed-with-Review | sparse | 0.065 |
| 7 | 126 | Buffer Over-read | Variant | Allowed | sparse | 0.062 |
| 8 | 190 | Integer Overflow or Wraparound | Base | Allowed | sparse | 0.061 |
| 9 | 444 | Inconsistent Interpretation of HTTP Requests ('HTTP Request/Response Smuggling') | Base | Allowed | dense | 0.379 |
| 10 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | graph | 0.002 |

