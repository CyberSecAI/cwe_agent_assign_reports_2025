# Vulnerability Information: CVE-2024-38597

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved eth sungem remove .ndo_poll_controller to avoid deadlocks Erhard reports netpoll warnings from sungem netpoll_send_skb_on_dev() eth0 enabled interrupts in poll (gem_start_xmit+0x0/0x398) WARNING CPU 1 PID 1 at net/core/netpoll.c370 netpoll_send_skb+0x1fc/0x20c gem_poll_controller() disables interrupts, which may sleep. We cant sleep in netpoll, it has interrupts disabled completely. Strangely, gem_poll_controller() doesnt even poll the completions, and instead acts as if an interrupt has fired so it just schedules NAPI and exits. None of this has been necessary for years, since netpoll invokes NAPI directly.

### Vulnerability Description Key Phrases
- **weakness:** **race condition**
- **impact:** deadlock
- **product:** Linux kernel
- **component:** netpoll_send_skb_on_dev(), gem_start_xmit+0x0/0x398, gem_poll_controller()

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root Cause:**
The `gem_poll_controller` function in the `sungem` network driver was causing deadlocks due to incorrect interrupt handling within the `netpoll` context.

**Weaknesses/Vulnerabilities:**
- The `gem_poll_controller` function disables interrupts, which can lead to sleeping within the `netpoll` context where sleeping is not allowed.
- The function does not actually poll for completions but simulates an interrupt, leading to an incorrect scheduling of NAPI.
- The `ndo_poll_controller` was not needed because `netpoll` directly invokes NAPI.

**Impact of Exploitation:**
The primary impact was deadlocks and warnings related to incorrect interrupt handling within the `netpoll` context, potentially causing network instability when `netpoll` is being used.

**Attack Vectors:**
The vulnerability was triggered by using `netpoll`, which is typically used for network debugging or in emergency network configurations. Specifically, the issue arises when `netpoll` tries to send a packet.

**Required Attacker Capabilities/Position:**
An attacker would need the capability to trigger the `netpoll` functionality. This might involve specific network configurations, debugging scenarios or emergency network recovery scenarios where netpoll is enabled. The attacker doesn't need direct access to the system beyond the ability to trigger network traffic that would involve `netpoll`.

**Additional Notes:**
- The fix involves removing the `gem_poll_controller` function and its registration in the `net_device_ops` structure. This change prevents the problematic interrupt disabling within the netpoll context.
- The linked commit messages explicitly state that the function wasn't needed for years because `netpoll` invokes NAPI directly.
- The vulnerability was reported by Erhard Furtner and the fix was reviewed by Eric Dumazet.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | alternate_terms | 1.000 |
| 2 | 833 | Deadlock | Base | Allowed | sparse | 0.335 |
| 3 | 226 | Sensitive Information in Resource Not Removed Before Reuse | Base | Allowed | sparse | 0.291 |
| 4 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.290 |
| 5 | 364 | Signal Handler Race Condition | Base | Allowed | sparse | 0.275 |
| 6 | 400 | Uncontrolled Resource Consumption | Class | Discouraged | sparse | 0.275 |
| 7 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.273 |
| 8 | 61 | UNIX Symbolic Link (Symlink) Following | Compound | Allowed | sparse | 0.260 |
| 9 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | dense | 0.452 |
| 10 | 609 | Double-Checked Locking | Base | Allowed | graph | 0.003 |

