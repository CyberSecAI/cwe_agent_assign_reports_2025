## Vulnerability Description
Khoj is an application that creates personal AI agents. The Khoj Obsidian, Desktop and Web clients **inadequately sanitize the AI models response and user inputs**. This can trigger Cross Site Scripting (XSS) via Prompt Injection from untrusted documents either indexed by the user on Khoj or read by Khoj from the internet when the user invokes the /online command. This vulnerability is fixed in 1.13.0.

### Vulnerability Description Key Phrases
- **rootcause:** **inadequately sanitize the AI models response and user inputs**
- **weakness:** **cross-site scripting**
- **vector:** prompt injection
- **product:** Khoj
- **version:** before 1.13.0
- **component:** Obsidian, Desktop and Web clients

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability described:

**Root Cause:**

The vulnerability stems from inadequate sanitization of AI model responses and user inputs within the Khoj Obsidian, Desktop, and Web clients. This lack of proper sanitization allows for the injection of malicious code, specifically through prompt injection, when processing untrusted documents or web content.

**Weaknesses/Vulnerabilities Present:**

*   **Cross-Site Scripting (XSS):** The core vulnerability is XSS, triggered by the injection of malicious HTML and JavaScript.
*   **Prompt Injection:** The AI model can be manipulated through crafted prompts in indexed documents or read from adversarial websites, causing it to generate malicious responses.
*  **Lack of Input Sanitization:** The application fails to properly sanitize user inputs and AI-generated content before rendering them in the chat interface.

**Impact of Exploitation:**

*   **Notification of Malicious Document Access:** Attackers can be notified when their malicious documents are accessed by Khoj.
*   **Unwanted Image Loading:** Attackers can inject code to load unexpected images into a user's chat session.
*   **Client Application Issues:** Malicious JavaScript can cause the user's client application to hang.
*   **Potential Secret Stealing:** Attackers could potentially steal secrets from the desktop app by abusing exposed `preload.js` functions.
*   **Potential Remote Code Execution (RCE):** Under specific system configurations, HTML injection combined with special URI schemes could lead to one-click RCE.

**Attack Vectors:**

*   **Maliciously Crafted Documents:** Users indexing documents containing malicious prompts can trigger the vulnerability.
*   **Adversarial Websites:** When users invoke the `/online` command, Khoj might read malicious content from adversarial websites, which could then be used to trigger the vulnerability.
*   **Direct User Input:** Malicious payloads can also be injected through direct user inputs in the chat modal.

**Required Attacker Capabilities/Position:**

*   **Ability to Create or Modify Documents:** Attackers need the ability to create or modify documents that are indexed by Khoj or to host malicious content on the internet that Khoj might access when using the `/online` command.
*   **User Interaction:** Exploitation of this vulnerability requires user interaction, either by using the `/online` command or by interacting with the chat application.

**Mitigation:**

The provided content also details the fix and mitigation:

*   **DOMPurify Sanitization:** The rendered chat messages are now sanitized using DOMPurify.
*   **Content Security Policy (CSP):** CSP restrictions have been implemented across Obsidian, Desktop, and Web chat clients.
*   **Future Improvement**:  The team plans to use finetuned LLMs to separate Data from Instructions to better address prompt injection.

**CVE ID:** CVE-2024-25639

**CWE:** CWE-80 (Improper Neutralization of Script-Related HTML Tags in a Web Page (Basic XSS))

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 116 | Improper Encoding or Escaping of Output | Class | Allowed-with-Review | sparse | 0.389 |
| 2 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | sparse | 0.378 |
| 3 | 113 | Improper Neutralization of CRLF Sequences in HTTP Headers ('HTTP Request/Response Splitting') | Variant | Allowed | sparse | 0.376 |
| 4 | 138 | Improper Neutralization of Special Elements | Class | Discouraged | sparse | 0.368 |
| 5 | 89 | Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection') | Base | Allowed | sparse | 0.348 |
| 6 | 74 | Improper Neutralization of Special Elements in Output Used by a Downstream Component ('Injection') | Class | Discouraged | sparse | 0.347 |
| 7 | 918 | Server-Side Request Forgery (SSRF) | Base | Allowed | sparse | 0.347 |
| 8 | 352 | Cross-Site Request Forgery (CSRF) | Compound | Allowed | sparse | 0.340 |
| 9 | 502 | Deserialization of Untrusted Data | Base | Allowed | dense | 0.450 |
| 10 | 184 | Incomplete List of Disallowed Inputs | Base | Allowed | graph | 0.002 |



# Complete CWE Specifications

CWE-116: Improper Encoding or Escaping of Output

CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')

CWE-113: Improper Neutralization of CRLF Sequences in HTTP Headers ('HTTP Request/Response Splitting')

CWE-138: Improper Neutralization of Special Elements

CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')

CWE-74: Improper Neutralization of Special Elements in Output Used by a Downstream Component ('Injection')

CWE-918: Server-Side Request Forgery (SSRF)

CWE-352: Cross-Site Request Forgery (CSRF)

CWE-502: Deserialization of Untrusted Data

CWE-184: Incomplete List of Disallowed Inputs