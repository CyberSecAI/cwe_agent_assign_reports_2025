# Vulnerability Information: CVE-2024-51746

## Vulnerability Description
Gitsign is a keyless Sigstore to signing tool for Git commits with your a GitHub / OIDC identity. gitsign may select the wrong Rekor entry to use during online verification when multiple entries are returned by the log. gitsign uses Rekors search API to fetch entries that apply to a signature being verified. The parameters used for the search are the public key and the payload. The search API returns entries that match either condition rather than both. When gitsigns credential cache is used, there can be multiple entries that use the same ephemeral keypair / signing certificate. As gitsign assumes both conditions are matched by Rekor, there is no additional validation that the entrys hash matches the payload being verified, meaning that the wrong entry can be used to successfully pass verification. Impact is minimal as while gitsign does not match the payload against the entry, it does ensure that the certificate matches. This would need to be exploited during the certificate validity window (10 minutes) by the key holder.

### Vulnerability Description Key Phrases
- **rootcause:** **improper validation of Rekor entries**
- **impact:** use wrong Rekor entry
- **product:** gitsign

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**

- The vulnerability stems from gitsign's incorrect assumption about how Rekor's search API works. Gitsign expects the API to return entries that match both the public key and the payload hash. However, Rekor's API returns entries matching *either* the public key or the payload hash.

**Weaknesses/Vulnerabilities:**

- **Incorrect Assumption:** Gitsign incorrectly assumes that Rekor's search API matches both the public key and the payload hash.
- **Lack of Payload Hash Validation:** Gitsign does not perform additional validation to ensure the entry's hash matches the payload being verified. This allows the tool to select an incorrect entry with a matching key but mismatched payload.
- **Reliance on Rekor API Order:** The exploitability depends on the order of matching entries in the response from the Rekor search API which makes triggering the vulnerability unreliable.

**Impact of Exploitation:**

- **Incorrect Verification:** An attacker could potentially use a different Rekor entry than the one intended for verification. Although, the signature will only pass verification if the certificate associated with the entry matches.
- **Limited Scope:** The impact is considered minimal because the attacker would have to exploit the vulnerability within a short certificate validity window of 10 minutes and would need to be the holder of the signing key.

**Attack Vectors:**

- **Online Verification:** The vulnerability is triggered during online verification using the `gitsign verify` command or `git log --show-signature` where gitsign queries Rekor.

**Required Attacker Capabilities/Position:**

- **Key Holder:** The attacker must be the key holder to generate a signature with an ephemeral keypair to exploit this vulnerability.
- **Within Certificate Validity Window:** The exploit must occur within the 10-minute validity window of the ephemeral certificate associated with the key.
- **Credential Cache Usage:** The gitsign credential cache must be enabled.
- **Multiple Rekor Entries:** Multiple Rekor entries for the same keypair must exist to trigger the vulnerability.

**Additional Notes:**

- The issue is dependent on the order of matching entries returned by Rekor, making the exploit less reliable and harder to reproduce consistently.
- The vulnerability has been assigned CVE-2024-51746.
- The fix is included in version 0.11.0 of gitsign.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 347 | Improper Verification of Cryptographic Signature | Base | Allowed | sparse | 0.971 |
| 2 | 295 | Improper Certificate Validation | Base | Allowed | sparse | 0.873 |
| 3 | 203 | Observable Discrepancy | Base | Allowed | sparse | 0.824 |
| 4 | 427 | Uncontrolled Search Path Element | Base | Allowed | sparse | 0.820 |
| 5 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.817 |
| 6 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | sparse | 0.817 |
| 7 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.804 |
| 8 | 88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | sparse | 0.803 |
| 9 | 1291 | Public Key Re-Use for Signing both Debug and Production Code | Base | Allowed | dense | 0.365 |
| 10 | 296 | Improper Following of a Certificate's Chain of Trust | Base | Allowed | graph | 0.002 |

