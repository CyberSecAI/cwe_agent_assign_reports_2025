# Vulnerability Information: CVE-2024-12952

## Vulnerability Description
A vulnerability classified as critical was found in melMass comfy_mtb up to 0.1.4. Affected by this vulnerability is the function run_command of the file comfy_mtb/endpoint.py of the component Dependency Handler. The manipulation leads to **code injection**. The attack can be launched remotely. The exploit has been disclosed to the public and may be used. The patch is named d6e004cce2c32f8e48b868e66b89f82da4887dc3. It is recommended to apply a patch to fix this issue.

### Vulnerability Description Key Phrases
- **weakness:** **code injection**
- **product:** melMass comfy_mtb
- **version:** up to 0.1.4
- **component:** comfy_mtb/endpoint.py

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root cause of vulnerability:**
The `comfy_mtb` plugin allowed for remote installation of arbitrary Python dependencies via an API endpoint. This was due to the `ACTIONS_installDependency` function in `endpoint.py` which would install any dependency name provided in the request if it was part of the allowed dependencies. The allowed dependencies were based on the return of `get_node_dependencies()` function in `install.py`

**Weaknesses/vulnerabilities present:**
- **Unrestricted Dependency Installation:** The plugin did not properly restrict which Python packages could be installed remotely, it only verified the package name if it was part of `get_node_dependencies()`.
- **Remote Code Execution:** By installing a malicious package, an attacker could execute arbitrary code on the server running the plugin.

**Impact of exploitation:**
- **Remote Code Execution (RCE):** Successful exploitation would grant the attacker the ability to execute arbitrary code on the server. This could lead to full system compromise, data breaches, malware deployment, and other severe consequences.

**Attack vectors:**
- **API Endpoint:** The vulnerability is triggered by making a request to the `/mtb/install` API endpoint exposed by the plugin.

**Required attacker capabilities/position:**
- **Network Access:** The attacker needs to be able to send requests to the API endpoint of the server running the vulnerable `comfy_mtb` plugin.
- **Knowledge of API:** The attacker needs to know the format of the request expected by the `/mtb/install` endpoint and how to specify the dependency to be installed.
- **Malicious Package:** The attacker needs to have a malicious python package prepared to be installed remotely.

**Additional Information:**
- The vulnerability was reported by user `boy-hack` and confirmed by the maintainer `melMass`.
- The issue was assigned high priority and was addressed in commit `d6e004c`.
- The fix involves introducing a whitelist to restrict allowed packages that can be installed and stripping attempts to pass flags during the installation.
- The vulnerability is located in `endpoint.py` specifically in the `ACTIONS_installDependency` function.
- The file `install.py` is also related to this vulnerability, where `get_node_dependencies()` function is located.
- The vulnerable code was present in commit `827c64c`.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | sparse | 0.531 |
| 2 | 89 | Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection') | Base | Allowed | sparse | 0.509 |
| 3 | 1336 | Improper Neutralization of Special Elements Used in a Template Engine | Base | Allowed | sparse | 0.449 |
| 4 | 1241 | Use of Predictable Algorithm in Random Number Generator | Base | Allowed | sparse | 0.443 |
| 5 | 93 | Improper Neutralization of CRLF Sequences ('CRLF Injection') | Base | Allowed | sparse | 0.441 |
| 6 | 99 | Improper Control of Resource Identifiers ('Resource Injection') | Class | Allowed-with-Review | sparse | 0.428 |
| 7 | 208 | Observable Timing Discrepancy | Base | Allowed | sparse | 0.426 |
| 8 | 334 | Small Space of Random Values | Base | Allowed | sparse | 0.425 |
| 9 | 78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | dense | 0.594 |
| 10 | 113 | Improper Neutralization of CRLF Sequences in HTTP Headers ('HTTP Request/Response Splitting') | Variant | Allowed | graph | 0.003 |

