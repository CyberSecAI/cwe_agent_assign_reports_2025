# Vulnerability Information: CVE-2024-45388

## Vulnerability Description
Hoverfly is a lightweight service virtualization/ API simulation / API mocking tool for developers and testers. The `/api/v2/simulation` POST handler allows users to create new simulation views from the contents of a user-specified file. This feature can be abused by an attacker to read arbitrary files from the Hoverfly server. Note that, although the code prevents absolute paths from being specified, an attacker can escape out of the `hf.Cfg.ResponsesBodyFilesPath` base path by using `../` segments and reach any arbitrary files. This issue was found using the **Uncontrolled data used in path expression** CodeQL query for python. Users are advised to make sure the final path (`filepath.Join(hf.Cfg.ResponsesBodyFilesPath, filePath)`) is contained within the expected base path (`filepath.Join(hf.Cfg.ResponsesBodyFilesPath, /)`). This issue is also tracked as GHSL-2023-274.

### Vulnerability Description Key Phrases
- **rootcause:** **Uncontrolled data used in path expression**
- **impact:** read arbitrary files
- **attacker:** attacker
- **product:** Hoverfly
- **component:** /api/v2/simulation POST handler

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2024-45388:

**Root cause of vulnerability:**

- The vulnerability stems from insufficient path validation when reading response body files in the `/api/v2/simulation` endpoint of the Hoverfly application.
- The `readResponseBodyFile` function, which constructs the file path to be read, attempts to prevent absolute paths but is vulnerable to path traversal.

**Weaknesses/vulnerabilities present:**

-   **Path Traversal:** The application does not properly sanitize user-provided file paths, allowing an attacker to use ".." sequences to navigate outside the intended directory (`hf.Cfg.ResponsesBodyFilesPath`) and access arbitrary files on the server.
-   **Uncontrolled Data in Path Expression:** The application uses user-controlled data (the `bodyFile` field in the request body) to construct a file path without sufficient validation.

**Impact of exploitation:**

-   **Arbitrary File Read:** A successful exploit allows an attacker to read the content of any file on the server that the Hoverfly application has permissions to access.
-   **Information Disclosure:** This can lead to the disclosure of sensitive information such as configuration files, credentials, or other confidential data.

**Attack vectors:**

-   **HTTP POST Request:** The vulnerability is triggered by sending a specifically crafted POST request to the `/api/v2/simulation` endpoint.
-   **Request Body:** The malicious file path is included within the `bodyFile` field of a JSON payload in the request body.

**Required attacker capabilities/position:**

-   **Network Access:** The attacker needs to be able to send HTTP requests to the Hoverfly server.
-   **Authentication (if enabled):** While the provided code snippets suggest the endpoint is protected by token authentication, the vulnerability itself is related to path handling once the request has passed that check.
-   **Knowledge of API:** The attacker needs knowledge of the `/api/v2/simulation` endpoint and the structure of the JSON payload expected by the application.
-   **No prior privileges:** The vulnerability can be exploited by any authenticated user, no special privileges are required.

**Additional details:**

- The vulnerability was identified using the CodeQL query "Uncontrolled data used in path expression".
- The fix involves ensuring that the final path resolved by `filepath.Join` stays within the intended directory.

**Summary**

CVE-2024-45388 is a path traversal vulnerability in Hoverfly that allows an attacker to read arbitrary files on the server by manipulating the file path provided in a POST request to the `/api/v2/simulation` endpoint. The vulnerability arises from insufficient path validation, specifically the lack of proper handling of ".." sequences, and it could lead to information disclosure.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | sparse | 0.693 |
| 2 | 73 | External Control of File Name or Path | Base | Allowed | sparse | 0.641 |
| 3 | 59 | Improper Link Resolution Before File Access ('Link Following') | Base | Allowed | sparse | 0.639 |
| 4 | 1333 | Inefficient Regular Expression Complexity | Base | Allowed | sparse | 0.626 |
| 5 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.625 |
| 6 | 23 | Relative Path Traversal | Base | Allowed | sparse | 0.622 |
| 7 | 427 | Uncontrolled Search Path Element | Base | Allowed | sparse | 0.617 |
| 8 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 0.612 |
| 9 | 444 | Inconsistent Interpretation of HTTP Requests ('HTTP Request/Response Smuggling') | Base | Allowed | dense | 0.414 |
| 10 | 434 | Unrestricted Upload of File with Dangerous Type | Base | Allowed | graph | 0.002 |

