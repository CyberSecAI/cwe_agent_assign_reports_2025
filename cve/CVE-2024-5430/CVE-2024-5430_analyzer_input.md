# Vulnerability Information: CVE-2024-5430

## Vulnerability Description
An issue was discovered in GitLab CE/EE affecting all versions starting from 16.10 prior to 16.11.5, starting from 17.0 prior to 17.0.3, and starting from 17.1 prior to 17.1.1, which allows a project maintainer can delete the merge request approval policy via graphQL.

### Vulnerability Description Key Phrases
- **impact:** delete the merge request approval policy via graphQL
- **attacker:** project maintainer
- **product:** GitLab CE/EE
- **version:** all versions starting from 16.10 prior to 16.11.5 and starting from 17.0 prior to 17.0.3 and starting from 17.1 prior to 17.1.1

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root Cause of Vulnerability:**
The vulnerability lies in the fact that project maintainers can delete approval rules associated with security policies, even though these policies are intended to prevent such modifications. This occurs because the `ApprovalProjectRuleDelete` mutation and the underlying `ProjectRuleDestroyService` did not properly check if an approval rule was associated with a security policy before allowing its deletion.

**Weaknesses/Vulnerabilities Present:**
- **Inadequate Access Control:** Project maintainers, who should be restricted by group-level security policies, can bypass these policies by deleting the associated approval rules.
- **Missing Authorization Check:** The code lacks a proper check to verify if an approval rule is tied to a security policy before allowing its deletion.
- **GraphQL Mutation Vulnerability:** The `approvalProjectRuleDelete` mutation was not properly restricted, allowing unauthorized users to delete critical rules.

**Impact of Exploitation:**
- **Bypass of Security Policy:** Project maintainers can circumvent the `block_branch_modification` setting in group-level security policies.
- **Unapproved Code Merges:** Attackers can push unapproved code directly to protected branches, undermining the intended security measures.
- **Potential CI/CD Variable Disclosure:** By merging malicious code, attackers could potentially disclose sensitive CI/CD variables.

**Attack Vectors:**
- **GraphQL API:** The vulnerability is exploited via the `approvalProjectRuleDelete` GraphQL mutation.
- **Project Maintainer Role:** The attacker needs to be a project maintainer within the affected group.

**Required Attacker Capabilities/Position:**
- The attacker must be a project maintainer within the affected group. They do not need group owner privileges.
- The attacker needs to be able to use the GitLab GraphQL API.
- The attacker must know the ID of the approval rule they wish to delete, which can be retrieved using a GraphQL query.

**More Details than CVE:**
The provided content contains significantly more detail than a typical CVE description, including:
- A detailed step-by-step guide to reproduce the vulnerability.
- The exact GraphQL queries and mutations needed for exploitation.
- A patch for the vulnerability in the form of a `diff`.
- A video proof of concept.
- Specific information regarding the impacted GitLab.com instance.
- An explanation of the vulnerable code and how it's fixed.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 696 | Incorrect Behavior Order | Class | Allowed-with-Review | sparse | 0.122 |
| 2 | 285 | Improper Authorization | Class | Discouraged | sparse | 0.117 |
| 3 | 400 | Uncontrolled Resource Consumption | Class | Discouraged | sparse | 0.116 |
| 4 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.114 |
| 5 | 1286 | Improper Validation of Syntactic Correctness of Input | Base | Allowed | sparse | 0.103 |
| 6 | 639 | Authorization Bypass Through User-Controlled Key | Base | Allowed | sparse | 0.101 |
| 7 | 1333 | Inefficient Regular Expression Complexity | Base | Allowed | sparse | 0.099 |
| 8 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.098 |
| 9 | 267 | Privilege Defined With Unsafe Actions | Base | Allowed | dense | 0.461 |
| 10 | 410 | Insufficient Resource Pool | Base | Allowed | graph | 0.002 |

