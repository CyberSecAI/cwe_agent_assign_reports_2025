## Vulnerability Description
authentik is an open-source identity provider. A vulnerability that exists in versions prior to 2024.8.3 and 2024.6.5 allows bypassing password login by adding X-Forwarded-For header with an unparsable IP address, e.g. `a`. This results in a possibility of logging into any account with a known login or email address. The vulnerability requires the authentik instance to trust X-Forwarded-For header provided by the attacker, thus it is not reproducible from external hosts on a properly configured environment. The issue occurs due to the password stage having a policy bound to it, which skips the password stage if the Identification stage is setup to also contain a password stage. Due to the invalid X-Forwarded-For header, which does not get validated to be an IP Address early enough, the exception happens later and the policy fails. The default blueprint doesnt correctly set `failure_result` to `True` on the policy binding meaning that due to this exception the policy returns false and the password stage is skipped. Versions 2024.8.3 and 2024.6.5 fix this issue.

### Vulnerability Description Key Phrases
- **rootcause:** **improper validation of X-Forwarded-For header**
- **impact:** bypass password login
- **vector:** adding X-Forwarded-For header with unparsable IP address
- **product:** authentik
- **version:** prior to 2024.8.3 and 2024.6.5
- **component:** password stage

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability described in CVE-2024-47070:

**Root Cause:**

The vulnerability stems from the way the `ClientIPMiddleware` in `authentik` handles the `X-Forwarded-For` HTTP header. It attempts to extract the client's IP address from this header, but it doesn't properly validate the format of the provided IP address. Specifically, if an invalid IP address string (e.g., "a") is provided in the header, the parsing fails, and the middleware returns a default IP address. Due to this, policies that check the client IP address can be bypassed.

**Weaknesses/Vulnerabilities:**

- **Insufficient Input Validation:** The `_get_client_ip_from_meta` function does not correctly validate the IP address format obtained from the `X-Forwarded-For` header. It attempts to parse it as an IP address but defaults to a default IP on failure.
- **Policy Bypass:** The vulnerability allows for bypassing policies which rely on client IP addresses for authorization decisions due to the middleware returning a default IP on invalid input. This is particularly relevant in authentication flows where password stages may be skipped.

**Impact of Exploitation:**

- **Authentication Bypass:** An attacker can bypass password authentication by providing an invalid IP address in the `X-Forwarded-For` header. This is because the default authentication flow uses a policy to enable the password stage only when there is no password stage selected on the Identification stage. This vulnerability allows skipping this policy, leading to authentication without password prompt.
- **Unauthorized Access:** By bypassing authentication, an attacker can gain unauthorized access to any account if they have a valid login or email address.

**Attack Vectors:**

- **HTTP Header Manipulation:** The attack vector is the manipulation of the `X-Forwarded-For` HTTP header.

**Required Attacker Capabilities/Position:**

- **Network Access:** The attacker needs network access to the `authentik` instance.
- **Header Manipulation:** The attacker needs to be able to send HTTP requests with the ability to modify headers, specifically including the `X-Forwarded-For` header.
- **Knowledge of Login/Email:** The attacker needs to know a valid login or email address to target an account after the password bypass.
- **Specific configurations:**
    - Access to `authentik` without a correctly configured reverse proxy or proper `AUTHENTIK_LISTEN__TRUSTED_PROXY_CIDRS` setting.
    - Reverse proxy not correctly overwriting `X-Forwarded-For`.
    - Policies are bound to authentication/authorization flows

**Additional Notes:**
- The vulnerability is present in `authentik` versions <= 2024.8.2 and <= 2024.6.4.
- It is fixed in versions 2024.8.3 and 2024.6.5.
- A workaround is to ensure the `X-Forwarded-For` header is always set by the reverse proxy with a correct IP, and also to configure policy bindings to "Pass" on failure.
- The vulnerability is rated as Critical with a CVSS score of 9.1

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 1390 | Weak Authentication | Class | Allowed-with-Review | sparse | 1.136 |
| 2 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 1.081 |
| 3 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 1.081 |
| 4 | 287 | Improper Authentication | Class | Discouraged | sparse | 1.044 |
| 5 | 306 | Missing Authentication for Critical Function | Base | Allowed | sparse | 1.038 |
| 6 | 923 | Improper Restriction of Communication Channel to Intended Endpoints | Class | Allowed-with-Review | sparse | 1.034 |
| 7 | 74 | Improper Neutralization of Special Elements in Output Used by a Downstream Component ('Injection') | Class | Discouraged | sparse | 1.031 |
| 8 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 1.028 |
| 9 | 289 | Authentication Bypass by Alternate Name | Base | Allowed | dense | 0.551 |
| 10 | 178 | Improper Handling of Case Sensitivity | Base | Allowed | graph | 0.002 |



# Complete CWE Specifications

CWE-1390: Weak Authentication

CWE-201: Insertion of Sensitive Information Into Sent Data

CWE-863: Incorrect Authorization

CWE-287: Improper Authentication

CWE-306: Missing Authentication for Critical Function

CWE-923: Improper Restriction of Communication Channel to Intended Endpoints

CWE-74: Improper Neutralization of Special Elements in Output Used by a Downstream Component ('Injection')

CWE-1284: Improper Validation of Specified Quantity in Input

CWE-289: Authentication Bypass by Alternate Name

CWE-178: Improper Handling of Case Sensitivity