{
  "cve_id": "CVE-2025-37854",
  "description": "In the Linux kernel, the following vulnerability has been resolved drm/amdkfd Fix mode1 reset crash issue If HW scheduler hangs and mode1 reset is used to recover GPU, KFD signal user space to abort the processes. After process abort exit, user queues still use the GPU to access system memory before h/w is reset while KFD cleanup worker free system memory and free VRAM. There is **use-after-free race** bug that KFD allocate and reuse the freed system memory, and user queue write to the same system memory to corrupt the data structure and cause driver crash. To fix this race, KFD cleanup worker terminate user queues, then flush reset_domain wq to wait for any GPU ongoing reset complete, and then free outstanding BOs.",
  "key_phrases": {
    "component": "drm/amdkfd",
    "rootcause": "use-after-free race",
    "vector": "write to the same system memory",
    "weakness": "",
    "product": "Linux kernel",
    "impact": "driver crash, GPU system memory access before reset",
    "attacker": "",
    "version": ""
  },
  "reference_content": null,
  "similar_info": {
    "cwe_distribution": {},
    "cwe_consensus": "",
    "similarity_stats": {
      "thresholds": [],
      "total_samples_by_threshold": {},
      "top_cwes_by_threshold": {}
    }
  },
  "similarity_summary": {
    "consensus_cwe": "",
    "top_cwes": [],
    "confidence_levels": {},
    "total_samples": 0
  },
  "analysis": "# Summary\n| CWE ID | CWE Name | Confidence | CWE Abstraction Level | CWE Vulnerability Mapping Label | CWE-Vulnerability Mapping Notes |\n|---|---|---|---|---|---|\n| CWE-416 | Use After Free | 1.0 | Variant |  Primary CWE | Allowed |\n| CWE-362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | 0.9 | Class | Secondary Candidate CWE | Allowed-with-Review |\n\n## Evidence and Confidence\n\n*   **Confidence Score:** 0.95\n*   **Evidence Strength:** HIGH\n\n## Relationship Analysis\nThe primary weakness is CWE-416 Use After Free, which occurs due to a race condition, CWE-362. CWE-416 is a variant, while CWE-362 is a class. This relationship highlights the specific nature of the memory corruption issue (use-after-free) arising from a broader concurrency problem (race condition).\n\n```mermaid\ngraph TD\n    cwe416[\"CWE-416: Use After Free\"]\n    cwe362[\"CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')\"]\n    \n    cwe416 -- CANFOLLOW --> cwe362\n    \n    classDef primary fill:#f96,stroke:#333,stroke-width:2px\n    classDef secondary fill:#69f,stroke:#333\n    class cwe416 primary\n    class cwe362 secondary\n```\n\n## Vulnerability Chain\nThe vulnerability chain starts with a **use-after-free race** condition (CWE-416) where memory is accessed after it has been freed. This occurs because of concurrent execution (CWE-362) during GPU reset. The user queues continue to access system memory after the process aborts but before the hardware reset, leading to data corruption and a driver crash.\n\n## Summary of Analysis\nThe primary vulnerability is a **use-after-free race** condition (CWE-416). The vulnerability description explicitly states this. The \"Retriever Results\" also lists CWE-416 as the top candidate. The concurrent execution is a contributing factor, hence the inclusion of CWE-362.\n\n*   \"After process abort exit, user queues still use the GPU to access system memory before h/w is reset while KFD cleanup worker free system memory and free VRAM. There is **use-after-free race** bug that KFD allocate and reuse the freed system memory, and user queue write to the same system memory to corrupt the data structure and cause driver crash.\"\n\nThe selection of CWE-416 and CWE-362 provides a comprehensive view of the vulnerability, covering both the memory corruption aspect and the concurrency issue that leads to it.\n\nRelevant CWE Information:\n\n# Enhanced Context (25 CWEs)\nThe following CWEs were identified as potentially relevant to this vulnerability:\n\n## CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')\n**Abstraction Level**: Class\n**Similarity Score**: 0.73\n**Source**: dense\n\n**Description**:\nThe product contains a concurrent code sequence that requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code sequence operating concurrently.\n\n**Mapping Guidance**:\n- Usage: Allowed-with-Review\n- Rationale: This CWE entry is a Class and might have Base-level children that would be more appropriate\n\n## CWE-416: Use After Free\n**Abstraction Level**: Variant\n**Similarity Score**: 0.69\n**Source**: dense\n\n**Description**:\nThe product reuses or references memory after it has been freed. At some point afterward, the memory may be allocated again and saved in another pointer, while the original pointer references a location somewhere within the new allocation. Any operations using the original pointer are no longer valid because the memory \"belongs\" to the code that operates on the new pointer.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This CWE entry is at the Variant level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.\n\n## CWE-416: Use After Free\n**Abstraction Level**: Variant\n**Similarity Score**: 2.61\n**Source**: graph\n\n**Description**:\nThe product reuses or references memory after it has been freed. At some point afterward, the memory may be allocated again and saved in another pointer, while the original pointer references a location somewhere within the new allocation. Any operations using the original pointer are no longer valid because the memory \"belongs\" to the code that operates on the new pointer.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This CWE entry is at the Variant level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.\n\n**Relationships**:\n- CANFOLLOW -> CWE-754\n- CANFOLLOW -> CWE-364\n- CANFOLLOW -> CWE-362\n- CANFOLLOW -> CWE-1265\n- CANPRECEDE -> CWE-123\n\n## CWE-416 Use After Free\n*Technical Explanation:* The vulnerability occurs because the KFD cleanup worker frees system memory, but user queues still use the GPU to access the same memory before the hardware is reset. This means the memory is accessed after it has been freed, leading to corruption.\n\n*Security Implications:* This can lead to a driver crash and potentially arbitrary code execution.\n\n*Parent-Child Relationships:* CWE-416 is a variant of more general memory corruption issues.\n\n*Why Primary:* The vulnerability description explicitly mentions **use-after-free**.\n\n*MITRE Mapping Guidance:* The usage is ALLOWED.\n\n*Confidence:* 1.0\n\n## CWE-362 Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')\n*Technical Explanation:* The **use-after-free** occurs due to a race condition between the KFD cleanup worker freeing memory and the user queues accessing it.\n\n*Security Implications:* This allows for a **use-after-free** vulnerability.\n\n*Parent-Child Relationships:* CWE-362 is a class of concurrency issues.\n\n*Why Secondary:* The **use-after-free** is the direct vulnerability, and the race condition is the condition that allows it.\n\n*MITRE Mapping Guidance:* The usage is Allowed-with-Review\n\n*Confidence:* 0.9\n\n## Other CWEs Considered But Not Used:\n\n*   CWE-415 Double Free: While double free is a memory corruption issue, the description clearly indicates a **use-after-free**, not a double free.\n*   CWE-667 Improper Locking: Although locking issues can lead to race conditions, the description focuses on the **use-after-free** resulting from the race, not the locking mechanism itself.\n*   CWE-367 Time-of-check Time-of-use (TOCTOU) Race Condition: While TOCTOU is a type of race condition, the described vulnerability doesn't fit the TOCTOU pattern specifically.\n*   CWE-123 Write-what-where Condition: This is a consequence of the **use-after-free** but not the root cause.",
  "analysis_with_relationships": "# Summary\n| CWE ID | CWE Name | Confidence | CWE Abstraction Level | CWE Vulnerability Mapping Label | CWE-Vulnerability Mapping Notes |\n|---|---|---|---|---|---|\n| CWE-416 | Use After Free | 1.0 | Variant |  Primary CWE | Allowed |\n| CWE-362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | 0.9 | Class | Secondary Candidate CWE | Allowed-with-Review |\n\n## Evidence and Confidence\n\n*   **Confidence Score:** 0.95\n*   **Evidence Strength:** HIGH\n\n## Relationship Analysis\nThe primary weakness is CWE-416 Use After Free, which occurs due to a race condition, CWE-362. CWE-416 is a variant, while CWE-362 is a class. This relationship highlights the specific nature of the memory corruption issue (use-after-free) arising from a broader concurrency problem (race condition).\n\n```mermaid\ngraph TD\n    cwe416[\"CWE-416: Use After Free\"]\n    cwe362[\"CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')\"]\n    \n    cwe416 -- CANFOLLOW --> cwe362\n    \n    classDef primary fill:#f96,stroke:#333,stroke-width:2px\n    classDef secondary fill:#69f,stroke:#333\n    class cwe416 primary\n    class cwe362 secondary\n```\n\n## Vulnerability Chain\nThe vulnerability chain starts with a **use-after-free race** condition (CWE-416) where memory is accessed after it has been freed. This occurs because of concurrent execution (CWE-362) during GPU reset. The user queues continue to access system memory after the process aborts but before the hardware reset, leading to data corruption and a driver crash.\n\n## Summary of Analysis\nThe primary vulnerability is a **use-after-free race** condition (CWE-416). The vulnerability description explicitly states this. The \"Retriever Results\" also lists CWE-416 as the top candidate. The concurrent execution is a contributing factor, hence the inclusion of CWE-362.\n\n*   \"After process abort exit, user queues still use the GPU to access system memory before h/w is reset while KFD cleanup worker free system memory and free VRAM. There is **use-after-free race** bug that KFD allocate and reuse the freed system memory, and user queue write to the same system memory to corrupt the data structure and cause driver crash.\"\n\nThe selection of CWE-416 and CWE-362 provides a comprehensive view of the vulnerability, covering both the memory corruption aspect and the concurrency issue that leads to it.\n\nRelevant CWE Information:\n\n# Enhanced Context (25 CWEs)\nThe following CWEs were identified as potentially relevant to this vulnerability:\n\n## CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')\n**Abstraction Level**: Class\n**Similarity Score**: 0.73\n**Source**: dense\n\n**Description**:\nThe product contains a concurrent code sequence that requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code sequence operating concurrently.\n\n**Mapping Guidance**:\n- Usage: Allowed-with-Review\n- Rationale: This CWE entry is a Class and might have Base-level children that would be more appropriate\n\n## CWE-416: Use After Free\n**Abstraction Level**: Variant\n**Similarity Score**: 0.69\n**Source**: dense\n\n**Description**:\nThe product reuses or references memory after it has been freed. At some point afterward, the memory may be allocated again and saved in another pointer, while the original pointer references a location somewhere within the new allocation. Any operations using the original pointer are no longer valid because the memory \"belongs\" to the code that operates on the new pointer.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This CWE entry is at the Variant level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.\n\n## CWE-416: Use After Free\n**Abstraction Level**: Variant\n**Similarity Score**: 2.61\n**Source**: graph\n\n**Description**:\nThe product reuses or references memory after it has been freed. At some point afterward, the memory may be allocated again and saved in another pointer, while the original pointer references a location somewhere within the new allocation. Any operations using the original pointer are no longer valid because the memory \"belongs\" to the code that operates on the new pointer.\n\n**Mapping Guidance**:\n- Usage: Allowed\n- Rationale: This CWE entry is at the Variant level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.\n\n**Relationships**:\n- CANFOLLOW -> CWE-754\n- CANFOLLOW -> CWE-364\n- CANFOLLOW -> CWE-362\n- CANFOLLOW -> CWE-1265\n- CANPRECEDE -> CWE-123\n\n## CWE-416 Use After Free\n*Technical Explanation:* The vulnerability occurs because the KFD cleanup worker frees system memory, but user queues still use the GPU to access the same memory before the hardware is reset. This means the memory is accessed after it has been freed, leading to corruption.\n\n*Security Implications:* This can lead to a driver crash and potentially arbitrary code execution.\n\n*Parent-Child Relationships:* CWE-416 is a variant of more general memory corruption issues.\n\n*Why Primary:* The vulnerability description explicitly mentions **use-after-free**.\n\n*MITRE Mapping Guidance:* The usage is ALLOWED.\n\n*Confidence:* 1.0\n\n## CWE-362 Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')\n*Technical Explanation:* The **use-after-free** occurs due to a race condition between the KFD cleanup worker freeing memory and the user queues accessing it.\n\n*Security Implications:* This allows for a **use-after-free** vulnerability.\n\n*Parent-Child Relationships:* CWE-362 is a class of concurrency issues.\n\n*Why Secondary:* The **use-after-free** is the direct vulnerability, and the race condition is the condition that allows it.\n\n*MITRE Mapping Guidance:* The usage is Allowed-with-Review\n\n*Confidence:* 0.9\n\n## Other CWEs Considered But Not Used:\n\n*   CWE-415 Double Free: While double free is a memory corruption issue, the description clearly indicates a **use-after-free**, not a double free.\n*   CWE-667 Improper Locking: Although locking issues can lead to race conditions, the description focuses on the **use-after-free** resulting from the race, not the locking mechanism itself.\n*   CWE-367 Time-of-check Time-of-use (TOCTOU) Race Condition: While TOCTOU is a type of race condition, the described vulnerability doesn't fit the TOCTOU pattern specifically.\n*   CWE-123 Write-what-where Condition: This is a consequence of the **use-after-free** but not the root cause.\n\n\n## CWE Relationship Analysis\n\nCurrent CWEs represent these abstraction levels: .\n\n\n### Vulnerability Chain Analysis\n\n**Chain starting from CWE-123:**\n- 123 (Write-what-where Condition) - ROOT\n\n\n**Chain starting from CWE-416:**\n- 416 (Use After Free) - ROOT\n\n\n\n### CWE Relationship Diagram\n\n```mermaid\ngraph TD\n    classDef primary fill:#f96,stroke:#333,stroke-width:2px\n    classDef secondary fill:#69f,stroke:#333\n    classDef tertiary fill:#9e9,stroke:#333\n```",
  "criticism": "",
  "resolution": "",
  "relevant_cwes": [
    {
      "metadata": {
        "doc_id": "416",
        "name": "Use After Free",
        "source": "alternate_terms",
        "original_matched_text": "AlternateTerms: Use-After-Free",
        "match_reason": "term_in_phrase_whole_phrase"
      },
      "similarity": 800.0,
      "alternate_term_match": true
    },
    {
      "metadata": {
        "doc_id": "362",
        "name": "Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')",
        "source": "sparse"
      },
      "similarity": 669.7493481633542
    },
    {
      "metadata": {
        "doc_id": "667",
        "name": "Improper Locking",
        "source": "sparse"
      },
      "similarity": 659.5688563582578
    },
    {
      "metadata": {
        "doc_id": "415",
        "name": "Double Free",
        "source": "sparse"
      },
      "similarity": 643.6585328812232
    },
    {
      "metadata": {
        "doc_id": "364",
        "name": "Signal Handler Race Condition",
        "source": "sparse"
      },
      "similarity": 602.0768456390009
    },
    {
      "metadata": {
        "doc_id": "367",
        "name": "Time-of-check Time-of-use (TOCTOU) Race Condition",
        "source": "sparse"
      },
      "similarity": 580.7867695430015
    },
    {
      "metadata": {
        "doc_id": "459",
        "name": "Incomplete Cleanup",
        "source": "sparse"
      },
      "similarity": 577.0031300250729
    },
    {
      "metadata": {
        "doc_id": "911",
        "name": "Improper Update of Reference Count",
        "source": "sparse"
      },
      "similarity": 555.3324725390488
    },
    {
      "metadata": {
        "doc_id": "1285",
        "name": "Improper Validation of Specified Index, Position, or Offset in Input",
        "type": "Base",
        "original_content": "The product receives input that is expected to specify an index, position, or offset into an indexable resource such as a buffer or file, but it does not validate or incorrectly validates that the specified index/position/offset has the required properties.",
        "keyphrase_source": "rootcause:use-after-free race",
        "source": "dense",
        "mapping_notes": {
          "usage": "Allowed",
          "rationale": "This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.",
          "comments": "Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.",
          "reasons": [
            "Acceptable-Use"
          ]
        },
        "score_info": {
          "retrievers": [
            "dense"
          ],
          "retriever_count": 1,
          "normalized_scores": {
            "dense": 0.46055493578897244
          }
        }
      },
      "similarity": 0.46055493578897244
    },
    {
      "doc_id": "123",
      "text": "CWE-123: Write-what-where Condition",
      "score": 2.9120000000000004,
      "metadata": {
        "doc_id": "123",
        "name": "Write-what-where Condition",
        "type": "base",
        "original_content": "CWE-123: Write-what-where Condition",
        "relationships": [
          {
            "source_id": "123",
            "target_id": "590",
            "label": "CANFOLLOW",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "123",
            "target_id": "479",
            "label": "CANFOLLOW",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "123",
            "target_id": "416",
            "label": "CANFOLLOW",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "123",
            "target_id": "364",
            "label": "CANFOLLOW",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "123",
            "target_id": "134",
            "label": "CANFOLLOW",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "123",
            "target_id": "120",
            "label": "CANFOLLOW",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "123",
            "target_id": "119",
            "label": "CHILDOF",
            "properties": {
              "ordinal": "Primary",
              "view_id": "1340"
            }
          },
          {
            "source_id": "123",
            "target_id": "119",
            "label": "CHILDOF",
            "properties": {
              "ordinal": "Primary",
              "view_id": "1305"
            }
          },
          {
            "source_id": "123",
            "target_id": "787",
            "label": "CHILDOF",
            "properties": {
              "ordinal": "Primary",
              "view_id": "1000"
            }
          },
          {
            "source_id": "787",
            "target_id": "123",
            "label": "PARENTOF",
            "properties": {
              "ordinal": "Primary",
              "view_id": "1000"
            }
          },
          {
            "source_id": "590",
            "target_id": "123",
            "label": "CANPRECEDE",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "479",
            "target_id": "123",
            "label": "CANPRECEDE",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "416",
            "target_id": "123",
            "label": "CANPRECEDE",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "415",
            "target_id": "123",
            "label": "PEEROF",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "364",
            "target_id": "123",
            "label": "CANPRECEDE",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "134",
            "target_id": "123",
            "label": "CANPRECEDE",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "120",
            "target_id": "123",
            "label": "CANPRECEDE",
            "properties": {
              "view_id": "1000"
            }
          },
          {
            "source_id": "119",
            "target_id": "123",
            "label": "PARENTOF",
            "properties": {
              "ordinal": "Primary",
              "view_id": "1305"
            }
          }
        ],
        "score_components": {
          "relationship_chain": 1.0,
          "sequence_path": 1.0,
          "peer_group": 0.9
        },
        "abstraction_factor": 1.3,
        "graph_path_info": {
          "path_types": [
            "relationship_chain",
            "vulnerability_sequence_forward",
            "peer_relationship"
          ],
          "best_paths": {
            "relationship_chain": {
              "path": [
                [
                  "416",
                  "123",
                  "CANPRECEDE"
                ]
              ],
              "score": 1.0,
              "type": "relationship_chain",
              "source": "416"
            },
            "vulnerability_sequence_forward": {
              "path": [
                [
                  "416",
                  "123",
                  "CANPRECEDE"
                ]
              ],
              "score": 1.0,
              "type": "vulnerability_sequence_forward",
              "source": "416"
            },
            "peer_relationship": {
              "path": [
                [
                  "415",
                  "123",
                  "PEEROF"
                ]
              ],
              "score": 0.9,
              "type": "peer_relationship",
              "source": "415"
            }
          }
        },
        "position": "after",
        "sources": [
          "graph"
        ],
        "source": "graph",
        "mapping_notes": {
          "usage": "Allowed",
          "rationale": "This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.",
          "comments": "Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.",
          "reasons": [
            "Acceptable-Use"
          ]
        },
        "score_info": {
          "retrievers": [
            "graph"
          ],
          "retriever_count": 1,
          "normalized_scores": {
            "graph": 2.9120000000000004
          }
        }
      },
      "similarity": 2.9120000000000004
    }
  ],
  "identified_cwes": {
    "analyzer": [
      "CWE-123",
      "CWE-416",
      "CWE-1265",
      "CWE-667",
      "CWE-364",
      "CWE-362",
      "CWE-367",
      "CWE-415",
      "CWE-754"
    ],
    "critic_additional": []
  },
  "keyphrase_cwe_mapping": {}
}