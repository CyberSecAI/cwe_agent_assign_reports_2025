# Vulnerability Information: CVE-2024-52520

## Vulnerability Description
Nextcloud Server is a self hosted personal cloud system. Due to a pre-flighted HEAD request, the link reference provider could be tricked into downloading bigger websites than intended, to find open-graph data. It is recommended that the Nextcloud Server is upgraded to 28.0.10 or 29.0.7 and Nextcloud Enterprise Server is upgraded to 27.1.11.8, 28.0.10 or 29.0.7.

### Vulnerability Description Key Phrases
- **product:** Nextcloud Server
- **component:** link reference provider

## CVE Reference Links Content Summary
Based on the provided information, here's a breakdown of the vulnerability:

**CVE ID:** CVE-2024-52520

**Root Cause of Vulnerability:**
The vulnerability lies in the `LinkReferenceProvider` of Nextcloud. It relies on a HEAD request to determine the size of a linked resource before downloading it to extract open graph data. However, the HEAD request can be manipulated to report a small size, while the subsequent GET request returns a much larger file. This allows the provider to be tricked into downloading files larger than the intended limit.

**Weaknesses/Vulnerabilities Present:**
- Inadequate size check: The `LinkReferenceProvider` relies on the `Content-Length` header from a HEAD request which is not reliable.
- Lack of proper stream handling: The initial size check was done only on the HEAD request, not on the body of the GET request.

**Impact of Exploitation:**
- Denial of Service (DoS): An attacker can cause the Nextcloud server to download large files, potentially consuming excessive bandwidth and resources, leading to a denial-of-service condition.

**Attack Vectors:**
- Network: The attack is carried out over the network by providing manipulated links to the Nextcloud instance.
- The vulnerability is triggered when Nextcloud attempts to resolve a link for Open Graph data.

**Required Attacker Capabilities/Position:**
- The attacker needs to be able to provide or control links that a Nextcloud user will interact with.
- The attacker needs to be able to host files on a server.
- The attacker needs a basic understanding of HTTP requests and headers.
- The attacker needs to provide a manipulated response to a HEAD request so that the GET request is initiated.

**Additional Details:**
- The fix implemented reads the response body as a stream and checks the size during the reading process to ensure that the limit isn't exceeded, rather than relying on the HEAD request.
- The fix also includes a timeout for the get request.
- The vulnerability has been assigned a "Moderate" severity with a CVSS score of 5.7
- The vulnerability is addressed in Nextcloud Server versions 28.0.10, 29.0.7 and Nextcloud Enterprise Server versions 27.1.11.8, 28.0.10, and 29.0.7.
- A workaround is to disable the `'reference_opengraph'` setting in the `config.php` file.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 209 | Generation of Error Message Containing Sensitive Information | Base | Allowed | sparse | 0.137 |
| 2 | 532 | Insertion of Sensitive Information into Log File | Base | Allowed | sparse | 0.127 |
| 3 | 93 | Improper Neutralization of CRLF Sequences ('CRLF Injection') | Base | Allowed | sparse | 0.121 |
| 4 | 639 | Authorization Bypass Through User-Controlled Key | Base | Allowed | sparse | 0.118 |
| 5 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 0.117 |
| 6 | 23 | Relative Path Traversal | Base | Allowed | sparse | 0.116 |
| 7 | 295 | Improper Certificate Validation | Base | Allowed | sparse | 0.116 |
| 8 | 94 | Improper Control of Generation of Code ('Code Injection') | Base | Allowed-with-Review | sparse | 0.116 |
| 9 | 525 | Use of Web Browser Cache Containing Sensitive Information | Variant | Allowed | dense | 0.431 |
| 10 | 117 | Improper Output Neutralization for Logs | Base | Allowed | graph | 0.002 |

