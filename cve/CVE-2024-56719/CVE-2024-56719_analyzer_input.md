# Vulnerability Information: CVE-2024-56719

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved net stmmac fix TSO DMA API usage causing oops Commit 66600fac7a98 (net stmmac TSO Fix unbalanced DMA map/unmap for non-paged SKB data) moved the assignment of tx_skbuff_dma[]s members to be later in stmmac_tso_xmit(). The buf (dma cookie) and len stored in this structure are passed to dma_unmap_single() by stmmac_tx_clean(). The DMA API requires that the dma cookie passed to dma_unmap_single() is the same as the value returned from dma_map_single(). However, by moving the assignment later, this is not the case when priv->dma_cap.addr64 > 32 as des is offset by proto_hdr_len. This causes problems such as dwc-eth-dwmac 2490000.ethernet eth0 Tx DMA map failed and with DMA_API_DEBUG enabled DMA-API dwc-eth-dwmac 2490000.ethernet device driver tries to +free DMA memory it has not allocated [device address=0x000000ffffcf65c0] [size=66 bytes] Fix this by maintaining des as the original DMA cookie, and use tso_des to pass the offset DMA cookie to stmmac_tso_allocator(). Full details of the crashes can be found at https//lore.kernel.org/all/d8112193-0386-4e14-b516-37c2d838171a@nvidia.com/ https//lore.kernel.org/all/klkzp5yn5kq5efgtrow6wbvnc46bcqfxs65nz3qy77ujr5turc@bwwhelz2l4dw/

### Vulnerability Description Key Phrases
- **component:** net stmmac
- **rootcause:** **Fix unbalanced DMA map/unmap for non-paged SKB data, incorrect DMA cookie assignment**
- **product:** Linux kernel
- **impact:** oops

## CVE Reference Links Content Summary
Based on the provided information, this content relates to the following vulnerability:

**Root cause of vulnerability:**
- A previous commit (66600fac7a98) moved the assignment of `tx_skbuff_dma[]` members to be later in `stmmac_tso_xmit()`.
- The DMA API requires the dma cookie passed to `dma_unmap_single()` to be the same value returned by `dma_map_single()`.
- Moving the assignment of the DMA address, results in `dma_unmap_single()` being called with an incorrect DMA cookie (offset by `proto_hdr_len` when `priv->dma_cap.addr64 > 32`). The original DMA cookie was modified by an offset.

**Weaknesses/vulnerabilities present:**
- Incorrect DMA mapping and unmapping due to modified DMA cookie.
- Usage of an offset DMA cookie instead of the original one which is passed into `dma_unmap_single()`.

**Impact of exploitation:**
- DMA mapping failures can occur.
- The system can try to free DMA memory it has not allocated, leading to a kernel panic.
- The `dwc-eth-dwmac` driver will report errors like "Tx DMA map failed".

**Attack vectors:**
- Triggering the TSO (TCP Segmentation Offload) functionality in the `stmmac` driver with a network packet requiring segmentation.

**Required attacker capabilities/position:**
- Ability to send network packets to a system using the affected `stmmac` Ethernet driver and having TSO enabled, where `priv->dma_cap.addr64 > 32`.

**More detail than CVE description:**
- The provided content includes the specific code changes, the root cause analysis of the bug, and the consequences of the bug including kernel oops. It also includes links to discussions on the kernel mailing list which provide additional context. The content also highlights the specific commit that introduced the bug and the commit that fixed the bug.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | sparse | 0.973 |
| 2 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.850 |
| 3 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.850 |
| 4 | 674 | Uncontrolled Recursion | Class | Allowed-with-Review | sparse | 0.814 |
| 5 | 787 | Out-of-bounds Write | Base | Allowed | sparse | 0.812 |
| 6 | 1285 | Improper Validation of Specified Index, Position, or Offset in Input | Base | Allowed | sparse | 0.811 |
| 7 | 835 | Loop with Unreachable Exit Condition ('Infinite Loop') | Base | Allowed | sparse | 0.810 |
| 8 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 0.777 |
| 9 | 1190 | DMA Device Enabled Too Early in Boot Phase | Base | Allowed | dense | 0.535 |
| 10 | 123 | Write-what-where Condition | Base | Allowed | graph | 0.002 |

