## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved i40e Fix macvlan leak by synchronizing access to mac_filter_hash This patch addresses a macvlan leak issue in the i40e driver caused by **concurrent access to vsi->mac_filter_hash**. The leak occurs when multiple threads attempt to modify the mac_filter_hash simultaneously, leading to inconsistent state and potential memory leaks. To fix this, we now wrap the calls to i40e_del_mac_filter() and zeroing vf->default_lan_addr.addr with spin_lock/unlock_bh(&vsi->mac_filter_hash_lock), ensuring atomic operations and preventing concurrent access. Additionally, we add lockdep_assert_held(&vsi->mac_filter_hash_lock) in i40e_add_mac_filter() to help catch similar issues in the future. Reproduction steps 1. Spawn VFs and configure port vlan on them. 2. Trigger concurrent macvlan operations (e.g., adding and deleting portvlan and/or mac filters). 3. Observe the potential memory leak and inconsistent state in the mac_filter_hash. This synchronization ensures the integrity of the mac_filter_hash and prevents the described leak.

### Vulnerability Description Key Phrases
- **rootcause:** **concurrent access to vsi->mac_filter_hash**
- **impact:** inconsistent state and integrity and memory leak
- **vector:** multiple threads modifying mac_filter_hash simultaneously
- **product:** Linux kernel
- **component:** i40e driver

## CVE Reference Links Content Summary
- **Root cause of vulnerability:** Concurrent access to `vsi->mac_filter_hash` in the i40e driver. Multiple threads modifying the hash simultaneously leads to inconsistent state and memory leaks.
- **Weaknesses/vulnerabilities present:** Race condition due to lack of synchronization when accessing and modifying the `mac_filter_hash`.
- **Impact of exploitation:** Memory leaks and inconsistent state within the `mac_filter_hash` structure, potentially leading to system instability or unexpected behavior.
- **Attack vectors:** Triggering concurrent macvlan operations, such as adding and deleting port VLANs or MAC filters, on Virtual Functions (VFs).
- **Required attacker capabilities/position:** The attacker needs to be able to spawn VFs and configure port VLANs on them, and trigger concurrent macvlan operations. This likely requires some level of administrative or privileged access to the system or hypervisor.

The provided content gives more details than a simple CVE description by specifying the exact code locations of the issue and describing the steps to reproduce the vulnerability.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.765 |
| 2 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.761 |
| 3 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.705 |
| 4 | 125 | Out-of-bounds Read | Base | Allowed | sparse | 0.698 |
| 5 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 0.690 |
| 6 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.689 |
| 7 | 203 | Observable Discrepancy | Base | Allowed | sparse | 0.680 |
| 8 | 909 | Missing Initialization of Resource | Class | Allowed-with-Review | sparse | 0.676 |
| 9 | 1331 | Improper Isolation of Shared Resources in Network On Chip (NoC) | Base | Allowed | dense | 0.483 |
| 10 | 609 | Double-Checked Locking | Base | Allowed | graph | 0.003 |



# Complete CWE Specifications

CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')

CWE-667: Improper Locking

CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition

CWE-125: Out-of-bounds Read

CWE-201: Insertion of Sensitive Information Into Sent Data

CWE-401: Missing Release of Memory after Effective Lifetime

CWE-203: Observable Discrepancy

CWE-909: Missing Initialization of Resource

CWE-1331: Improper Isolation of Shared Resources in Network On Chip (NoC)

CWE-609: Double-Checked Locking