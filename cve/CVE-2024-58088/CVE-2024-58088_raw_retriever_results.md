# Raw Retriever Results for CVE-2024-58088

# Raw Retriever Results for CVE-2024-58088
## Query
In the Linux kernel, the following vulnerability has been resolved bpf Fix deadlock when freeing cgroup storage The following commit bc235cdb423a (bpf Prevent deadlock from recursive bpf_task_storage_[get|delete]) first introduced deadlock prevention for fentry/fexit programs attaching on bpf_task_storage helpers. That commit also employed the logic in map free path in its v6 version. Later bpf_cgrp_storage was first introduced in c4bcfb38a95e (bpf Implement cgroup storage available to non-cgroup-attached bpf progs) which faces the same issue as bpf_task_storage, instead of its busy counter, NULL was passed to bpf_local_storage_map_free() which opened a window to cause deadlock (acquiring local_storage->lock) _raw_spin_lock_irqsave+0x3d/0x50 bpf_local_storage_update+0xd1/0x460 bpf_cgrp_storage_get+0x109/0x130 bpf_prog_a4d4a370ba857314_cgrp_ptr+0x139/0x170 ? __bpf_prog_enter_recur+0x16/0x80 bpf_trampoline_6442485186+0x43/0xa4 cgroup_storage_ptr+0x9/0x20 (holding local_storage->lock) bpf_selem_unlink_storage_nolock.constprop.0+0x135/0x160 bpf_selem_unlink_storage+0x6f/0x110 bpf_local_storage_map_free+0xa2/0x110 bpf_map_free_deferred+0x5b/0x90 process_one_work+0x17c/0x390 worker_thread+0x251/0x360 kthread+0xd2/0x100 ret_from_fork+0x34/0x50 ret_from_fork_asm+0x1a/0x30 Progs - A SEC(fentry/cgroup_storage_ptr) - cgid (BPF_MAP_TYPE_HASH) Record the id of the cgroup the current task belonging to in this hash map, using the address of the cgroup as the map key. - cgrpa (BPF_MAP_TYPE_CGRP_STORAGE) If current task is a kworker, lookup the above hash map using function parameter @owner as the key to get its corresponding cgroup id which is then used to get a trusted pointer to the cgroup through bpf_cgroup_from_id(). This trusted pointer can then be passed to bpf_cgrp_storage_get() to finally trigger the deadlock issue. - B SEC(tp_btf/sys_enter) - cgrpb (BPF_MAP_TYPE_CGRP_STORAGE) The only purpose of this prog is to fill Prog As hash map by calling bpf_cgrp_storage_get() for as many userspace tasks as possible. Steps to reproduce - Run A - while (true) { Run B Destroy B } Fix this issue by passing its busy counter to the free procedure so it can be properly incremented before storage/smap locking.

## Keyphrases
- **rootcause**: 'null pointer dereference'

## Score Statistics
| Retriever | Min | Max | Mean | Median | Count |
|-----------|-----|-----|------|--------|-------|
| Dense | 0.4249 | 0.5189 | 0.4539 | 0.4504 | 20 |
| Sparse | 334.6421 | 1194.7053 | 933.5263 | 1015.1345 | 12 |
| Graph | 1.2081 | 2.8652 | 1.6712 | 1.5627 | 20 |

## Graph Retriever Results (20)
| # | CWE ID | Name | Abstraction | Score | Mapping Usage |
|---|--------|------|-------------|-------|---------------|
| 1 | 609 | Double-Checked Locking | base | 2.8652 | Allowed |
| 2 | 386 | Symbolic Name not Mapping to Correct Object | base | 2.3764 | Allowed |
| 3 | 390 | Detection of Error Condition Without Action | base | 2.2100 | Allowed |
| 4 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | 2.0177 | Allowed |
| 5 | 120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | base | 1.7680 | Allowed-with-Review |
| 6 | 123 | Write-what-where Condition | base | 1.7680 | Allowed |
| 7 | 364 | Signal Handler Race Condition | base | 1.7550 | Allowed |
| 8 | 833 | Deadlock | Base | 1.6958 | Allowed |
| 9 | 1265 | Unintended Reentrant Invocation of Non-reentrant Code Via Nested Calls | base | 1.6848 | Allowed |
| 10 | 61 | UNIX Symbolic Link (Symlink) Following | compound | 1.6100 | Allowed |
| 11 | 456 | Missing Initialization of a Variable | variant | 1.5154 | Allowed |
| 12 | 476 | NULL Pointer Dereference | Base | 1.5114 | Allowed |
| 13 | 908 | Use of Uninitialized Resource | Base | 1.5072 | Allowed |
| 14 | 416 | Use After Free | Variant | 1.4135 | Allowed |
| 15 | 363 | Race Condition Enabling Link Following | base | 1.3572 | Allowed |

## Dense Retriever Results (20)
| # | CWE ID | Name | Abstraction | Score | Original Score | Mapping Usage |
|---|--------|------|-------------|-------|----------------|---------------|
| 1 | 667 | Improper Locking | Class | 0.5189 | 0.5189 | Allowed-with-Review |
| 2 | 833 | Deadlock | Base | 0.5032 | 0.5032 | Allowed |
| 3 | 909 | Missing Initialization of Resource | Class | 0.4857 | 0.4857 | Allowed-with-Review |
| 4 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | 0.4694 | 0.4694 | Allowed-with-Review |
| 5 | 401 | Missing Release of Memory after Effective Lifetime | Variant | 0.4659 | 0.4659 | Allowed |
| 6 | 1325 | Improperly Controlled Sequential Memory Allocation | Base | 0.4651 | 0.4651 | Allowed |
| 7 | 763 | Release of Invalid Pointer or Reference | Base | 0.4649 | 0.4649 | Allowed |
| 8 | 404 | Improper Resource Shutdown or Release | Class | 0.4632 | 0.4632 | Allowed-with-Review |
| 9 | 413 | Improper Resource Locking | Base | 0.4606 | 0.4606 | Allowed |
| 10 | 911 | Improper Update of Reference Count | Base | 0.4590 | 0.4590 | Allowed |
| 11 | 416 | Use After Free | Variant | 0.4417 | 0.4417 | Allowed |
| 12 | 832 | Unlock of a Resource that is not Locked | Base | 0.4376 | 0.4376 | Allowed |
| 13 | 366 | Race Condition within a Thread | Base | 0.4342 | 0.4342 | Allowed |
| 14 | 789 | Memory Allocation with Excessive Size Value | Variant | 0.4335 | 0.4335 | Allowed |
| 15 | 126 | Buffer Over-read | Variant | 0.4327 | 0.4327 | Allowed |

## Sparse Retriever Results (12)
| # | CWE ID | Name | Score | Original Score | Mapping Usage |
|---|--------|------|-------|---------------|---------------|
| 1 | 667 | Improper Locking | 1194.7053 | 1194.7053 | Allowed-with-Review |
| 2 | 833 | Deadlock | 1135.5140 | 1135.5140 | Allowed |
| 3 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | 1082.6039 | 1082.6039 | Allowed-with-Review |
| 4 | 674 | Uncontrolled Recursion | 1035.2781 | 1035.2781 | Allowed-with-Review |
| 5 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | 1027.3798 | 1027.3798 | Allowed |
| 6 | 639 | Authorization Bypass Through User-Controlled Key | 1015.7502 | 1015.7502 | Allowed |
| 7 | 335 | Incorrect Usage of Seeds in Pseudo-Random Number Generator (PRNG) | 1014.5188 | 1014.5188 | Allowed |
| 8 | 909 | Missing Initialization of Resource | 1012.4054 | 1012.4054 | Allowed-with-Review |
| 9 | 863 | Incorrect Authorization | 1008.7321 | 1008.7321 | Allowed-with-Review |
| 10 | 824 | Access of Uninitialized Pointer | 1005.9070 | 1005.9070 | Allowed |
| 11 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | 334.8794 | 334.8794 | Allowed |
| 12 | 197 | Numeric Truncation Error | 334.6421 | 334.6421 | Allowed |
