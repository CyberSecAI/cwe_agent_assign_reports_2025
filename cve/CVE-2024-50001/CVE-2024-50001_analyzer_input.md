# Vulnerability Information: CVE-2024-50001

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved net/mlx5 Fix error path in multi-packet WQE transmit Remove the **erroneous unmap in case no DMA mapping was established** The multi-packet WQE transmit code attempts to obtain a DMA mapping for the skb. This could fail, e.g. under memory pressure, when the IOMMU driver just cant allocate more memory for page tables. While the code tries to handle this in the path below the err_unmap label it erroneously unmaps one entry from the sqs FIFO list of active mappings. Since the current map attempt failed this unmap is removing some random DMA mapping that might still be required. If the PCI function now presents that IOVA, the IOMMU may assumes a rogue DMA access and e.g. on s390 puts the PCI function in error state. The erroneous behavior was seen in a stress-test environment that created memory pressure.

### Vulnerability Description Key Phrases
- **rootcause:** **erroneous unmap in case no DMA mapping was established**
- **impact:** PCI function in error state
- **product:** Linux kernel
- **component:** net/mlx5 multi-packet WQE transmit

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root cause of vulnerability:**
The root cause is an error in the multi-packet WQE transmit code within the Mellanox mlx5 driver. Specifically, when a DMA mapping for an skb fails (e.g., due to memory pressure), the error handling path incorrectly unmaps an entry from the Send Queue's (sq) FIFO list of active DMA mappings.

**Weaknesses/vulnerabilities present:**
The vulnerability is a double-free like condition. The incorrect unmapping of a DMA mapping leads to a scenario where a valid DMA mapping can be prematurely removed, and the associated IOVA (I/O Virtual Address) can potentially be reused by another process, while the original PCI function might still be using it.

**Impact of exploitation:**
If the PCI function then attempts to use the original IOVA, the IOMMU might identify it as a rogue DMA access. On s390 systems, this leads to the PCI function being put into an error state. The system can become unstable or even crash in such a scenario.

**Attack vectors:**
The attack vector is indirect and triggered by memory pressure leading to DMA mapping failures during multi-packet WQE transmissions. This memory pressure can be a consequence of a user-level process consuming all available memory.

**Required attacker capabilities/position:**
An attacker needs the ability to create memory pressure and trigger a DMA mapping failure during the execution of the multi-packet WQE transmit function, likely by utilizing network functionalities or by allocating large amounts of memory.

**Additional Notes:**
* The provided commits address this issue by removing the erroneous unmap from the error handling path, preventing the premature removal of DMA mappings.
* This vulnerability was found in a stress test environment simulating memory pressure.
* The vulnerable code is in the `mlx5e_sq_xmit_mpwqe` function within `drivers/net/ethernet/mellanox/mlx5/core/en_tx.c`.
* The fix involves removing `mlx5e_dma_unmap_wqe_err(sq, 1);` line from the `err_unmap` label.
* This vulnerability impacts systems using the Mellanox mlx5 driver for network interfaces with IOMMU enabled, especially in environments with high memory usage.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | sparse | 0.785 |
| 2 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.776 |
| 3 | 404 | Improper Resource Shutdown or Release | Class | Allowed-with-Review | sparse | 0.736 |
| 4 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.696 |
| 5 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.689 |
| 6 | 1250 | Improper Preservation of Consistency Between Independent Representations of Shared State | Base | Allowed | sparse | 0.682 |
| 7 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 0.674 |
| 8 | 909 | Missing Initialization of Resource | Class | Allowed-with-Review | sparse | 0.674 |
| 9 | 1285 | Improper Validation of Specified Index, Position, or Offset in Input | Base | Allowed | dense | 0.518 |
| 10 | 386 | Symbolic Name not Mapping to Correct Object | Base | Allowed | graph | 0.002 |

