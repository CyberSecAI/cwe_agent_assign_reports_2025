# Vulnerability Description

    In the Linux kernel, the following vulnerability has been resolved vhost-scsi Fix handling of multiple calls to vhost_scsi_set_endpoint If vhost_scsi_set_endpoint is called multiple times without a vhost_scsi_clear_endpoint between them, we can hit multiple bugs found by Haoran Zhang 1. **Use-after-free** when no tpgs are found This fixes a **use after free** that occurs when vhost_scsi_set_endpoint is called more than once and calls after the first call do not find any tpgs to add to the vs_tpg. When vhost_scsi_set_endpoint first finds tpgs to add to the vs_tpg array match=true, so we will do vhost_vq_set_backend(vq, vs_tpg) ... kfree(vs->vs_tpg) vs->vs_tpg = vs_tpg If vhost_scsi_set_endpoint is called again and no tpgs are found match=false so we skip the vhost_vq_set_backend call leaving the pointer to the vs_tpg we then free via kfree(vs->vs_tpg) vs->vs_tpg = vs_tpg If a scsi request is then sent we do vhost_scsi_handle_vq -> vhost_scsi_get_req -> vhost_vq_get_backend which sees the vs_tpg we just did a kfree on. 2. **Tpg dir removal hang** This patch fixes an issue where we cannot remove a LIO/target layer tpg (and structs above it like the target) dir due to the refcount dropping to -1. The problem is that if vhost_scsi_set_endpoint detects a tpg is already in the vs->vs_tpg array or if the tpg has been removed so target_depend_item fails, the undepend goto handler will do target_undepend_item on all tpgs in the vs_tpg array dropping their refcount to 0. At this time vs_tpg contains both the tpgs we have added in the current vhost_scsi_set_endpoint call as well as tpgs we added in previous calls which are also in vs->vs_tpg. Later, when vhost_scsi_clear_endpoint runs it will do target_undepend_item on all the tpgs in the vs->vs_tpg which will drop their refcount to -1. Userspace will then not be able to remove the tpg and will hang when it tries to do rmdir on the tpg dir. 3. **Tpg leak** This fixes a bug where we can leak tpgs and cause them to be un-removable because the target name is overwritten when vhost_scsi_set_endpoint is called multiple times but with different target names. The bug occurs if a user has called VHOST_SCSI_SET_ENDPOINT and setup a vhost-scsi device to target/tpg mapping, then calls VHOST_SCSI_SET_ENDPOINT again with a new target name that has tpgs we havent seen before (target1 has tpg1 but target2 has tpg2). When this happens we dont teardown the old target tpg mapping and just overwrite the target name and the vs->vs_tpg array. Later when we do vhost_scsi_clear_endpoint, we are passed in either target1 or target2s name and we will only match that targets tpgs when we loop over the vs->vs_tpg. We will then return from the function without doing target_undepend_item on the tpgs. Because of all these bugs, it looks like being able to call vhost_scsi_set_endpoint multiple times was never supported. The major user, QEMU, already has checks to prevent this use case. So to fix the issues, this patch prevents vhost_scsi_set_endpoint from being called if its already successfully added tpgs. To add, remove or change the tpg config or target name, you must do a vhost_scsi_clear_endpoint first.

    # Keyphrase-Specific CWE Analysis
    This vulnerability contains multiple keyphrases that may map to different CWEs. 
    Please analyze each keyphrase separately and determine the most appropriate CWE(s) for each.

    ## ROOTCAUSE: 'Tpg dir removal hang'

Relevant CWEs for this ROOTCAUSE:

### 1. CWE-212: Improper Removal of Sensitive Information Before Storage or Transfer (Score: 2225.69)

The product stores, transfers, or shares a resource that contains sensitive information, but it does not properly remove that information before the product makes the resource available to unauthorized actors....

### 2. CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') (Score: 2201.39)

The product contains a concurrent code sequence that requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code sequence operating concurrently....

### 3. CWE-415: Double Free (Score: 2200.93)

The product calls free() twice on the same memory address, potentially leading to modification of unexpected memory locations....

### 4. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 2181.39)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 5. CWE-863: Incorrect Authorization (Score: 2163.23)

The product performs an authorization check when an actor attempts to access a resource or perform an action, but it does not correctly perform the check....

## ROOTCAUSE: 'use after free'

Relevant CWEs for this ROOTCAUSE:

### 1. CWE-212: Improper Removal of Sensitive Information Before Storage or Transfer (Score: 2225.69)

The product stores, transfers, or shares a resource that contains sensitive information, but it does not properly remove that information before the product makes the resource available to unauthorized actors....

### 2. CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') (Score: 2201.39)

The product contains a concurrent code sequence that requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code sequence operating concurrently....

### 3. CWE-415: Double Free (Score: 2200.93)

The product calls free() twice on the same memory address, potentially leading to modification of unexpected memory locations....

### 4. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 2181.39)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 5. CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition (Score: 2178.45)

The product checks the state of a resource before using that resource, but the resource's state can change between the check and the use in a way that invalidates the results of the check. This can cause the product to perform invalid actions when the resource is in an unexpected state....

## ROOTCAUSE: 'Use-after-free'

Relevant CWEs for this ROOTCAUSE:

### 1. CWE-212: Improper Removal of Sensitive Information Before Storage or Transfer (Score: 2225.69)

The product stores, transfers, or shares a resource that contains sensitive information, but it does not properly remove that information before the product makes the resource available to unauthorized actors....

### 2. CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') (Score: 2201.39)

The product contains a concurrent code sequence that requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code sequence operating concurrently....

### 3. CWE-415: Double Free (Score: 2200.93)

The product calls free() twice on the same memory address, potentially leading to modification of unexpected memory locations....

### 4. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 2181.39)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 5. CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition (Score: 2178.45)

The product checks the state of a resource before using that resource, but the resource's state can change between the check and the use in a way that invalidates the results of the check. This can cause the product to perform invalid actions when the resource is in an unexpected state....

## ROOTCAUSE: 'Tpg leak'

Relevant CWEs for this ROOTCAUSE:

### 1. CWE-212: Improper Removal of Sensitive Information Before Storage or Transfer (Score: 2225.69)

The product stores, transfers, or shares a resource that contains sensitive information, but it does not properly remove that information before the product makes the resource available to unauthorized actors....

### 2. CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') (Score: 2201.39)

The product contains a concurrent code sequence that requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code sequence operating concurrently....

### 3. CWE-415: Double Free (Score: 2200.93)

The product calls free() twice on the same memory address, potentially leading to modification of unexpected memory locations....

### 4. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 2181.39)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 5. CWE-61: UNIX Symbolic Link (Symlink) Following (Score: 2162.18)

The product, when opening a file or directory, does not sufficiently account for when the file is a symbolic link that resolves to a target outside of the intended control sphere. This could allow an attacker to cause the product to operate on unauthorized files....

## WEAKNESS: 'use-after-free'

Relevant CWEs for this WEAKNESS:

### 1. CWE-212: Improper Removal of Sensitive Information Before Storage or Transfer (Score: 2225.69)

The product stores, transfers, or shares a resource that contains sensitive information, but it does not properly remove that information before the product makes the resource available to unauthorized actors....

### 2. CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') (Score: 2201.39)

The product contains a concurrent code sequence that requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code sequence operating concurrently....

### 3. CWE-415: Double Free (Score: 2200.93)

The product calls free() twice on the same memory address, potentially leading to modification of unexpected memory locations....

### 4. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 2181.39)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 5. CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition (Score: 2178.45)

The product checks the state of a resource before using that resource, but the resource's state can change between the check and the use in a way that invalidates the results of the check. This can cause the product to perform invalid actions when the resource is in an unexpected state....

## PRODUCT: 'Linux kernel'

Relevant CWEs for this PRODUCT:

### 1. CWE-212: Improper Removal of Sensitive Information Before Storage or Transfer (Score: 2225.69)

The product stores, transfers, or shares a resource that contains sensitive information, but it does not properly remove that information before the product makes the resource available to unauthorized actors....

### 2. CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') (Score: 2201.39)

The product contains a concurrent code sequence that requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code sequence operating concurrently....

### 3. CWE-415: Double Free (Score: 2200.93)

The product calls free() twice on the same memory address, potentially leading to modification of unexpected memory locations....

### 4. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 2181.39)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 5. CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition (Score: 2178.45)

The product checks the state of a resource before using that resource, but the resource's state can change between the check and the use in a way that invalidates the results of the check. This can cause the product to perform invalid actions when the resource is in an unexpected state....

## COMPONENT: 'vhost-scsi'

Relevant CWEs for this COMPONENT:

### 1. CWE-212: Improper Removal of Sensitive Information Before Storage or Transfer (Score: 2225.69)

The product stores, transfers, or shares a resource that contains sensitive information, but it does not properly remove that information before the product makes the resource available to unauthorized actors....

### 2. CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') (Score: 2201.39)

The product contains a concurrent code sequence that requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code sequence operating concurrently....

### 3. CWE-415: Double Free (Score: 2200.93)

The product calls free() twice on the same memory address, potentially leading to modification of unexpected memory locations....

### 4. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 2181.39)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 5. CWE-61: UNIX Symbolic Link (Symlink) Following (Score: 2162.18)

The product, when opening a file or directory, does not sufficiently account for when the file is a symbolic link that resolves to a target outside of the intended control sphere. This could allow an attacker to cause the product to operate on unauthorized files....


    # Analysis Instructions
    1. For each keyphrase, identify the most appropriate CWE(s) that represent the weakness.
    2. Consider how the different keyphrases might relate to each other in the vulnerability chain.
    3. Provide a final determination of primary CWE(s) and any secondary CWEs.
    4. Format your response using the standard analysis template.

    Please analyze how these different weaknesses interact and provide a comprehensive CWE classification.
    

# Complete CWE Specifications

CWE-212: Improper Removal of Sensitive Information Before Storage or Transfer

CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')

CWE-415: Double Free

CWE-1284: Improper Validation of Specified Quantity in Input

CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition

CWE-863: Incorrect Authorization

CWE-61: UNIX Symbolic Link (Symlink) Following