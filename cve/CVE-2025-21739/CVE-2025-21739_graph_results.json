{
  "query": "In the Linux kernel, the following vulnerability has been resolved scsi ufs core Fix use-after free in init error and remove paths devm_blk_crypto_profile_init() registers a cleanup handler to run when the associated (platform-) device is being released. For UFS, the crypto private data and pointers are stored as part of the ufs_hbas data structure struct ufs_hbacrypto_profile. This structure is allocated as part of the underlying ufshcd and therefore Scsi_host allocation. During driver release or during error handling in ufshcd_pltfrm_init(), this structure is released as part of ufshcd_dealloc_host() before the (platform-) device associated with the crypto call above is released. Once this device is released, the crypto cleanup code will run, using the just-released struct ufs_hbacrypto_profile. This causes a use-after-free situation Call trace kfree+0x60/0x2d8 (P) kvfree+0x44/0x60 blk_crypto_profile_destroy_callback+0x28/0x70 devm_action_release+0x1c/0x30 release_nodes+0x6c/0x108 devres_release_all+0x98/0x100 device_unbind_cleanup+0x20/0x70 really_probe+0x218/0x2d0 In other words, the initialisation code flow is platform-device probe ufshcd_pltfrm_init() ufshcd_alloc_host() scsi_host_alloc() allocation of struct ufs_hba creation of scsi-host devices devm_blk_crypto_profile_init() devm registration of cleanup handler using platform-device and during error handling of ufshcd_pltfrm_init() or during driver removal ufshcd_dealloc_host() scsi_host_put() put_device(scsi-host) release of struct ufs_hba put_device(platform-device) crypto cleanup handler To fix this use-after free, change ufshcd_alloc_host() to register a devres action to automatically cleanup the underlying SCSI device on ufshcd destruction, without requiring explicit calls to ufshcd_dealloc_host(). This way * the crypto profile and all other ufs_hba-owned resources are destroyed before SCSI (as theyve been registered after) * a memleak is plugged in tc-dwc-g210-pci.c remove() as a side-effect * EXPORT_SYMBOL_GPL(ufshcd_dealloc_host) can be removed fully as its not needed anymore * no future drivers using ufshcd_alloc_host() could ever forget adding the cleanup",
  "count": 20,
  "results": [
    {
      "cwe_id": "123",
      "name": "Write-what-where Condition",
      "abstraction": "base",
      "score": 2.9120000000000004,
      "original_score": 2.9120000000000004,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "364",
      "name": "Signal Handler Race Condition",
      "abstraction": "base",
      "score": 2.8651999999999997,
      "original_score": 2.8651999999999997,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "908",
      "name": "Use of Uninitialized Resource",
      "abstraction": "Base",
      "score": 2.804293283071735,
      "original_score": 2.804293283071735,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "416",
      "name": "Use After Free",
      "abstraction": "Variant",
      "score": 2.5411803761171057,
      "original_score": 2.5411803761171057,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "415",
      "name": "Double Free",
      "abstraction": "Variant",
      "score": 2.2207979962004973,
      "original_score": 2.2207979962004973,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "1265",
      "name": "Unintended Reentrant Invocation of Non-reentrant Code Via Nested Calls",
      "abstraction": "base",
      "score": 2.2100000000000004,
      "original_score": 2.2100000000000004,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "120",
      "name": "Buffer Copy without Checking Size of Input ('Classic Buffer Overflow')",
      "abstraction": "base",
      "score": 2.2100000000000004,
      "original_score": 2.2100000000000004,
      "mapping_usage": "Allowed-with-Review"
    },
    {
      "cwe_id": "201",
      "name": "Insertion of Sensitive Information Into Sent Data",
      "abstraction": "base",
      "score": 2.2100000000000004,
      "original_score": 2.2100000000000004,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "390",
      "name": "Detection of Error Condition Without Action",
      "abstraction": "base",
      "score": 2.2100000000000004,
      "original_score": 2.2100000000000004,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "456",
      "name": "Missing Initialization of a Variable",
      "abstraction": "variant",
      "score": 2.1936,
      "original_score": 2.1936,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "909",
      "name": "Missing Initialization of Resource",
      "abstraction": "Class",
      "score": 1.7397669322084441,
      "original_score": 1.7397669322084441,
      "mapping_usage": "Allowed-with-Review"
    },
    {
      "cwe_id": "362",
      "name": "Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')",
      "abstraction": "Class",
      "score": 1.7352502030409085,
      "original_score": 1.7352502030409085,
      "mapping_usage": "Allowed-with-Review"
    },
    {
      "cwe_id": "134",
      "name": "Use of Externally-Controlled Format String",
      "abstraction": "base",
      "score": 1.6848000000000003,
      "original_score": 1.6848000000000003,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "170",
      "name": "Improper Null Termination",
      "abstraction": "base",
      "score": 1.6848000000000003,
      "original_score": 1.6848000000000003,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "1325",
      "name": "Improperly Controlled Sequential Memory Allocation",
      "abstraction": "base",
      "score": 1.6848000000000003,
      "original_score": 1.6848000000000003,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "226",
      "name": "Sensitive Information in Resource Not Removed Before Reuse",
      "abstraction": "Base",
      "score": 1.6777116929098712,
      "original_score": 1.6777116929098712,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "459",
      "name": "Incomplete Cleanup",
      "abstraction": "Base",
      "score": 1.6755707345408888,
      "original_score": 1.6755707345408888,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "386",
      "name": "Symbolic Name not Mapping to Correct Object",
      "abstraction": "base",
      "score": 1.6744000000000003,
      "original_score": 1.6744000000000003,
      "mapping_usage": "Allowed"
    },
    {
      "cwe_id": "662",
      "name": "Improper Synchronization",
      "abstraction": "class",
      "score": 1.6736000000000002,
      "original_score": 1.6736000000000002,
      "mapping_usage": "Discouraged"
    },
    {
      "cwe_id": "833",
      "name": "Deadlock",
      "abstraction": "Base",
      "score": 1.6306739755787658,
      "original_score": 1.6306739755787658,
      "mapping_usage": "Allowed"
    }
  ],
  "statistics": {
    "min": 1.6306739755787658,
    "max": 2.9120000000000004,
    "mean": 2.061922259683411,
    "median": 1.966683466104222,
    "count": 20
  }
}