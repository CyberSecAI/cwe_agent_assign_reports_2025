# Vulnerability Information: CVE-2024-47220

## Vulnerability Description
An issue was discovered in the WEBrick toolkit through 1.8.1 for Ruby. It **allows HTTP request smuggling** by providing both a Content-Length header and a Transfer-Encoding header, e.g., GET /admin HTTP/1.1\r\n inside of a POST /user HTTP/1.1\r\n request. NOTE the suppliers position is Webrick should not be used in production.

### Vulnerability Description Key Phrases
- **rootcause:** **allows HTTP request smuggling**
- **weakness:** **HTTP smuggling**
- **product:** WEBrick toolkit
- **version:** through 1.8.1

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**
The vulnerability stems from WEBrick's improper handling of HTTP requests that include both `Content-Length` and `Transfer-Encoding` headers. According to RFC 7230, section 3.3.3.3, a server can reject such requests with a 400 error, but WEBrick wasn't doing this.

**Weaknesses/Vulnerabilities:**
- **HTTP Request Smuggling:** By including both headers, an attacker can manipulate how the server parses request boundaries, effectively "smuggling" a second, malicious request within the body of the first.

**Impact of Exploitation:**
- **Unauthorized Access:** The smuggled request can target restricted resources, such as `/admin`, which are not intended for access by unauthorized users. An attacker could potentially bypass access controls.
- **Data Manipulation:** An attacker might use a smuggled request to alter data, potentially leading to application logic issues or even data corruption depending on the application using WEBrick.

**Attack Vectors:**
- The attacker crafts a malicious HTTP request that contains both `Content-Length` and `Transfer-Encoding` headers. This is sent to the server. The server's flawed parsing logic then allows a second, smuggled request within the body of the first to be processed as a separate valid request.

**Required Attacker Capabilities/Position:**
- The attacker needs the ability to send HTTP requests to the vulnerable WEBrick server.
- No special privileges or authentication is required for the basic attack to succeed.

**Technical Details:**
The initial proof of concept exploit was:
```
POST /user HTTP/1.1
Host: 127.0.0.1:8000
Content-Length: 50
Transfer-Encoding: chunked

0

GET /admin HTTP/1.1
Host: 127.0.0.1:8000
```

The fix implemented in pull request #146 and commit `d88321da45dcd230ac2b4585cad4833d6d5e8841` was to raise a `WEBrick::HTTPStatus::BadRequest` error when a request contained both `Content-Length` and `Transfer-Encoding` headers, effectively preventing the request smuggling attack. The fix is in the `lib/webrick/httprequest.rb` file. A corresponding test case `test_content_length_and_transfer_encoding_headers_smuggling` was added to `test/webrick/test_httprequest.rb`.

**Additional Notes:**
- The maintainers of Webrick have stated that it "should not be used in production." This is because it has been removed from Ruby core and they only maintain it because it's used by gems mainly for testing. The project has changed its maintenance policy.
- The maintainers initially resisted having this issue listed as a CVE due to the policy change, however a CVE was eventually assigned as CVE-2024-47220.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 444 | Inconsistent Interpretation of HTTP Requests ('HTTP Request/Response Smuggling') | Base | Allowed | alternate_terms | 0.800 |
| 2 | 93 | Improper Neutralization of CRLF Sequences ('CRLF Injection') | Base | Allowed | sparse | 0.352 |
| 3 | 113 | Improper Neutralization of CRLF Sequences in HTTP Headers ('HTTP Request/Response Splitting') | Variant | Allowed | sparse | 0.350 |
| 4 | 138 | Improper Neutralization of Special Elements | Class | Discouraged | sparse | 0.349 |
| 5 | 1333 | Inefficient Regular Expression Complexity | Base | Allowed | sparse | 0.329 |
| 6 | 130 | Improper Handling of Length Parameter Inconsistency | Base | Allowed | sparse | 0.324 |
| 7 | 22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | sparse | 0.317 |
| 8 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 0.311 |
| 9 | 650 | Trusting HTTP Permission Methods on the Server Side | Variant | Allowed | dense | 0.493 |
| 10 | 117 | Improper Output Neutralization for Logs | Base | Allowed | graph | 0.002 |

