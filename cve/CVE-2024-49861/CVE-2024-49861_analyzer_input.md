# Vulnerability Information: CVE-2024-49861

# Vulnerability Description

    In the Linux kernel, the following vulnerability has been resolved bpf Fix helper writes to read-only maps Lonial found an issue that despite user- and BPF-side frozen BPF map (like in case of .rodata), it was still possible to write into it from a BPF program side through specific helpers having ARG_PTR_TO_{LONG,INT} as arguments. In check_func_arg() when the argument is as mentioned, the meta->raw_mode is never set. Later, check_helper_mem_access(), under the case of PTR_TO_MAP_VALUE as register base type, it assumes BPF_READ for the subsequent call to check_map_access_type() and given the BPF map is read-only it succeeds. The helpers really need to be annotated as ARG_PTR_TO_{LONG,INT} | MEM_UNINIT when results are written into them as opposed to read out of them. The latter indicates that its okay to pass a pointer to **uninitialized memory** as the memory is written to anyway. However, ARG_PTR_TO_{LONG,INT} is a special case of ARG_PTR_TO_FIXED_SIZE_MEM just with additional alignment requirement. So it is better to just get rid of the ARG_PTR_TO_{LONG,INT} special cases altogether and reuse the fixed size memory types. For this, add MEM_ALIGNED to additionally ensure alignment given these helpers write directly into the args via * = val. The .arg*_size has been initialized reflecting the actual sizeof(*). MEM_ALIGNED can only be used in combination with MEM_FIXED_SIZE annotated argument types, since in !MEM_FIXED_SIZE cases the verifier does not know the b

    # Keyphrase-Specific CWE Analysis
    This vulnerability contains multiple keyphrases that may map to different CWEs. 
    Please analyze each keyphrase separately and determine the most appropriate CWE(s) for each.

    ## ROOTCAUSE: 'BPF map being incorrectly annotated in the Linux kernel'

Relevant CWEs for this ROOTCAUSE:

### 1. CWE-197: Numeric Truncation Error (Score: 1175.82)

Truncation errors occur when a primitive is cast to a primitive of a smaller size and data is lost in the conversion....

### 2. CWE-789: Memory Allocation with Excessive Size Value (Score: 1144.62)

The product allocates memory based on an untrusted, large size value, but it does not ensure that the size is within expected limits, allowing arbitrary amounts of memory to be allocated....

### 3. CWE-909: Missing Initialization of Resource (Score: 1130.68)

The product does not initialize a critical resource....

### 4. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 1128.57)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 5. CWE-667: Improper Locking (Score: 1125.09)

The product does not properly acquire or release a lock on a resource, leading to unexpected resource state changes and behaviors....

## WEAKNESS: 'improper map annotation'

Relevant CWEs for this WEAKNESS:

### 1. CWE-197: Numeric Truncation Error (Score: 1175.82)

Truncation errors occur when a primitive is cast to a primitive of a smaller size and data is lost in the conversion....

### 2. CWE-789: Memory Allocation with Excessive Size Value (Score: 1144.62)

The product allocates memory based on an untrusted, large size value, but it does not ensure that the size is within expected limits, allowing arbitrary amounts of memory to be allocated....

### 3. CWE-909: Missing Initialization of Resource (Score: 1130.68)

The product does not initialize a critical resource....

### 4. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 1128.57)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 5. CWE-407: Inefficient Algorithmic Complexity (Score: 1059.66)

An algorithm in a product has an inefficient worst-case computational complexity that may be detrimental to system performance and can be triggered by an attacker, typically using crafted manipulations that ensure that the worst case is being reached....

## IMPACT: 'write into read-only maps'

Relevant CWEs for this IMPACT:

### 1. CWE-197: Numeric Truncation Error (Score: 1175.82)

Truncation errors occur when a primitive is cast to a primitive of a smaller size and data is lost in the conversion....

### 2. CWE-789: Memory Allocation with Excessive Size Value (Score: 1144.62)

The product allocates memory based on an untrusted, large size value, but it does not ensure that the size is within expected limits, allowing arbitrary amounts of memory to be allocated....

### 3. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 1128.57)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 4. CWE-476: NULL Pointer Dereference (Score: 1071.31)

The product dereferences a pointer that it expects to be valid but is NULL....

### 5. CWE-407: Inefficient Algorithmic Complexity (Score: 1059.66)

An algorithm in a product has an inefficient worst-case computational complexity that may be detrimental to system performance and can be triggered by an attacker, typically using crafted manipulations that ensure that the worst case is being reached....

## PRODUCT: 'Linux kernel'

Relevant CWEs for this PRODUCT:

### 1. CWE-197: Numeric Truncation Error (Score: 1175.82)

Truncation errors occur when a primitive is cast to a primitive of a smaller size and data is lost in the conversion....

### 2. CWE-789: Memory Allocation with Excessive Size Value (Score: 1144.62)

The product allocates memory based on an untrusted, large size value, but it does not ensure that the size is within expected limits, allowing arbitrary amounts of memory to be allocated....

### 3. CWE-909: Missing Initialization of Resource (Score: 1130.68)

The product does not initialize a critical resource....

### 4. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 1128.57)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 5. CWE-476: NULL Pointer Dereference (Score: 1071.31)

The product dereferences a pointer that it expects to be valid but is NULL....

## COMPONENT: 'bpf'

Relevant CWEs for this COMPONENT:

### 1. CWE-197: Numeric Truncation Error (Score: 1175.82)

Truncation errors occur when a primitive is cast to a primitive of a smaller size and data is lost in the conversion....

### 2. CWE-789: Memory Allocation with Excessive Size Value (Score: 1144.62)

The product allocates memory based on an untrusted, large size value, but it does not ensure that the size is within expected limits, allowing arbitrary amounts of memory to be allocated....

### 3. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 1128.57)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 4. CWE-407: Inefficient Algorithmic Complexity (Score: 1059.66)

An algorithm in a product has an inefficient worst-case computational complexity that may be detrimental to system performance and can be triggered by an attacker, typically using crafted manipulations that ensure that the worst case is being reached....

### 5. CWE-843: Access of Resource Using Incompatible Type ('Type Confusion') (Score: 347.72)

The product allocates or initializes a resource such as a pointer, object, or variable using one type, but it later accesses that resource using a type that is incompatible with the original type....

## ROOTCAUSE: 'uninitialized memory'

Relevant CWEs for this ROOTCAUSE:

### 1. CWE-789: Memory Allocation with Excessive Size Value (Score: 1144.62)

The product allocates memory based on an untrusted, large size value, but it does not ensure that the size is within expected limits, allowing arbitrary amounts of memory to be allocated....

### 2. CWE-909: Missing Initialization of Resource (Score: 1130.68)

The product does not initialize a critical resource....

### 3. CWE-1284: Improper Validation of Specified Quantity in Input (Score: 1128.57)

The product receives input that is expected to specify a quantity (such as size or length), but it does not validate or incorrectly validates that the quantity has the required properties....

### 4. CWE-476: NULL Pointer Dereference (Score: 1071.31)

The product dereferences a pointer that it expects to be valid but is NULL....

### 5. CWE-407: Inefficient Algorithmic Complexity (Score: 1059.66)

An algorithm in a product has an inefficient worst-case computational complexity that may be detrimental to system performance and can be triggered by an attacker, typically using crafted manipulations that ensure that the worst case is being reached....


    # Analysis Instructions
    1. For each keyphrase, identify the most appropriate CWE(s) that represent the weakness.
    2. Consider how the different keyphrases might relate to each other in the vulnerability chain.
    3. Provide a final determination of primary CWE(s) and any secondary CWEs.
    4. Format your response using the standard analysis template.

    Please analyze how these different weaknesses interact and provide a comprehensive CWE classification.
    