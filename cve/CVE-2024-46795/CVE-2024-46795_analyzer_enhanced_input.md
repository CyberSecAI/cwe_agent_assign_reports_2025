## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved ksmbd unset the binding mark of a reused connection Steve French reported **null pointer dereference** error from sha256 lib. cifs.ko can send session setup requests on reused connection. If reused connection is used for binding session, conn->binding can still remain true and generate_preauth_hash() will not set sess->Preauth_HashValue and it will be NULL. It is used as a material to create an encryption key in ksmbd_gen_smb311_encryptionkey. ->Preauth_HashValue cause **null pointer dereference** error from crypto_shash_update(). BUG kernel NULL pointer dereference, address 0000000000000000 #PF supervisor read access in kernel mode #PF error_code(0x0000) - not-present page PGD 0 P4D 0 Oops 0000 [#1] PREEMPT SMP PTI CPU 8 PID 429254 Comm kworker/839 Hardware name LENOVO 20MAS08500/20MAS08500, BIOS N2CET69W (1.52 ) Workqueue ksmbd-io handle_ksmbd_work [ksmbd] RIP 0010lib_sha256_base_do_update.isra.0+0x11e/0x1d0 [sha256_ssse3] ? show_regs+0x6d/0x80 ? __die+0x24/0x80 ? page_fault_oops+0x99/0x1b0 ? do_user_addr_fault+0x2ee/0x6b0 ? exc_page_fault+0x83/0x1b0 ? asm_exc_page_fault+0x27/0x30 ? __pfx_sha256_transform_rorx+0x10/0x10 [sha256_ssse3] ? lib_sha256_base_do_update.isra.0+0x11e/0x1d0 [sha256_ssse3] ? __pfx_sha256_transform_rorx+0x10/0x10 [sha256_ssse3] ? __pfx_sha256_transform_rorx+0x10/0x10 [sha256_ssse3] _sha256_update+0x77/0xa0 [sha256_ssse3] sha256_avx2_update+0x15/0x30 [sha256_ssse3] crypt

### Vulnerability Description Key Phrases
- **rootcause:** **null pointer dereference**
- **impact:** Oops and denial of service and read access
- **vector:** session setup requests on reused connection
- **product:** Linux kernel
- **component:** cifs.ko

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**

The vulnerability stems from a logic error in the ksmbd (kernel SMB server) module related to handling reused connections in the context of SMB3 multichannel setups. Specifically, when a connection is reused for a binding session, the `conn->binding` flag might not be reset correctly.

**Weaknesses/Vulnerabilities:**

- **Incorrect `conn->binding` Flag Management:** When a connection is reused, especially for a binding session, the `conn->binding` flag may remain set. This prevents `generate_preauth_hash()` from setting `sess->Preauth_HashValue`, resulting in it being NULL.
- **Null Pointer Dereference:** The NULL `sess->Preauth_HashValue` is then used as input to `crypto_shash_update()` within `ksmbd_gen_smb311_encryptionkey()`, which leads to a null pointer dereference and a kernel crash.

**Impact of Exploitation:**

- **Kernel Panic/Crash:** The primary impact is a kernel panic and crash due to a null pointer dereference, leading to a denial-of-service condition.
- **System Instability:** This crash will disrupt the normal operation of the system hosting the ksmbd server.

**Attack Vectors:**

- **SMB Session Setup:** The vulnerability is triggered during the SMB session setup process (`smb2_sess_setup`).
- **Reused Connections:** The specific scenario requires that an existing connection is reused for a session setup. This can occur in environments where connections are frequently established and torn down, or if clients attempt to optimize connection usage.
- **SMB3 Multichannel:** The issue is explicitly tied to SMB3 multichannel configurations, indicating that this feature needs to be enabled in the ksmbd server.

**Required Attacker Capabilities/Position:**

- **Network Access:** The attacker needs network access to the machine hosting the vulnerable ksmbd server.
- **SMB Client:** The attacker needs to be capable of sending SMB session setup requests.
- **Trigger Reused Connections:** The attacker needs to trigger the conditions where a connection is reused, especially in the context of a binding session. This might require some control over client behavior.

**Additional Technical Details:**

- The crash occurs in the `lib_sha256_base_do_update.isra.0` function, which is part of the SHA256 cryptographic hashing library, indicating a problem when trying to perform a hash operation with invalid input.
- The provided call trace clearly identifies the sequence of function calls leading to the crash: `smb2_sess_setup` -> `ntlm_authenticate` -> `ksmbd_gen_smb311_encryptionkey` -> `generate_key` -> `crypto_shash_update` -> `lib_sha256_base_do_update.isra.0`.
- The fix involves ensuring that `conn->binding` is reset to `false` after the session registration, preventing the problematic code path from being executed on reused connections.

The provided information is sufficient to understand the vulnerability and its impact, which is a kernel-level denial of service. The fix is straightforward and has been applied.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 476 | NULL Pointer Dereference | Base | Allowed | sparse | 0.649 |
| 2 | 824 | Access of Uninitialized Pointer | Base | Allowed | sparse | 0.570 |
| 3 | 822 | Untrusted Pointer Dereference | Base | Allowed | sparse | 0.561 |
| 4 | 252 | Unchecked Return Value | Base | Allowed | sparse | 0.547 |
| 5 | 665 | Improper Initialization | Class | Discouraged | sparse | 0.533 |
| 6 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.525 |
| 7 | 908 | Use of Uninitialized Resource | Base | Allowed | sparse | 0.519 |
| 8 | 787 | Out-of-bounds Write | Base | Allowed | sparse | 0.512 |
| 9 | 1285 | Improper Validation of Specified Index, Position, or Offset in Input | Base | Allowed | dense | 0.607 |
| 10 | 1325 | Improperly Controlled Sequential Memory Allocation | Base | Allowed | graph | 0.003 |



# Complete CWE Specifications

CWE-476: NULL Pointer Dereference

CWE-824: Access of Uninitialized Pointer

CWE-822: Untrusted Pointer Dereference

CWE-252: Unchecked Return Value

CWE-665: Improper Initialization

CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')

CWE-908: Use of Uninitialized Resource

CWE-787: Out-of-bounds Write

CWE-1285: Improper Validation of Specified Index, Position, or Offset in Input

CWE-1325: Improperly Controlled Sequential Memory Allocation