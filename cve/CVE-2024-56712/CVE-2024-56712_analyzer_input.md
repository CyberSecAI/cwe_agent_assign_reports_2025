# Vulnerability Information: CVE-2024-56712

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved udmabuf fix **memory leak** on last export_udmabuf() error path In export_udmabuf(), if dma_buf_fd() fails because the FD table is full, a dma_buf owning the udmabuf has already been created but the error handling in udmabuf_create() will tear down the udmabuf without doing anything about the containing dma_buf. This leaves a dma_buf in memory that contains a dangling pointer though that doesnt seem to lead to anything bad except a **memory leak**. Fix it by moving the dma_buf_fd() call out of export_udmabuf() so that we can give it different error handling. Note that the shape of this code changed a lot in commit 5e72b2b41a21 (udmabuf convert udmabuf driver to use folios) but the **memory leak** seems to have existed since the introduction of udmabuf.

### Vulnerability Description Key Phrases
- **weakness:** **memory leak**
- **product:** Linux kernel
- **component:** udmabuf

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root Cause:**
- The vulnerability is a memory leak in the `udmabuf` driver.
- The issue occurs within the `export_udmabuf()` function where a `dma_buf` is created, but if the subsequent `dma_buf_fd()` call fails (e.g., due to a full FD table), the `dma_buf` is not properly cleaned up, leading to a memory leak.
- The error handling in `udmabuf_create()` only cleans up the `udmabuf` struct without deallocating the underlying `dma_buf`.

**Weaknesses/Vulnerabilities Present:**
- **Memory Leak:** A `dma_buf` is allocated but not freed when `dma_buf_fd()` fails.
- **Dangling Pointer:** The leaked `dma_buf` contains a dangling pointer, although this is not directly exploited in this scenario, it could potentially lead to issues if the memory is reused improperly.

**Impact of Exploitation:**
- **Resource Exhaustion:** Repeatedly triggering the vulnerable code path can lead to memory exhaustion, potentially impacting the system's stability and performance, and ultimately leading to a denial-of-service.

**Attack Vectors:**
- **FD Table Exhaustion:** The vulnerability can be triggered by attempting to create a `udmabuf` when the FD table is full.

**Required Attacker Capabilities/Position:**
- The attacker needs to be able to create `udmabuf` instances. This requires a specific user with the permissions to interact with the `udmabuf` driver.
- The attacker needs to have the ability to manipulate the system to cause FD table exhaustion or some other scenario where `dma_buf_fd()` fails.
- The attacker can be a local user with enough privileges or another user that can manipulate the system.

**Additional Details:**
- The fix involves moving the `dma_buf_fd()` call outside of `export_udmabuf()` to ensure proper error handling and freeing of the underlying `dma_buf`.
- This memory leak has been present since the introduction of the `udmabuf` driver.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | alternate_terms | 1.000 |
| 2 | 909 | Missing Initialization of Resource | Class | Allowed-with-Review | sparse | 0.591 |
| 3 | 125 | Out-of-bounds Read | Base | Allowed | sparse | 0.591 |
| 4 | 415 | Double Free | Variant | Allowed | sparse | 0.583 |
| 5 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.581 |
| 6 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.568 |
| 7 | 476 | NULL Pointer Dereference | Base | Allowed | sparse | 0.566 |
| 8 | 787 | Out-of-bounds Write | Base | Allowed | sparse | 0.559 |
| 9 | 403 | Exposure of File Descriptor to Unintended Control Sphere ('File Descriptor Leak') | Base | Allowed | dense | 0.450 |
| 10 | 364 | Signal Handler Race Condition | Base | Allowed | graph | 0.003 |

