# Vulnerability Information: CVE-2024-45522

## Vulnerability Description
Linen before cd37c3e does not verify that the domain is linen.dev or www.linen.dev when resetting a password. This occurs in create in apps/web/pages/api/forgot-password/index.ts.

### Vulnerability Description Key Phrases
- **product:** Linen
- **version:** before cd37c3e
- **component:** create in apps/web/pages/api/forgot-password/index.ts

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability addressed by the commit:

**Root Cause of Vulnerability:**

The vulnerability lies in the password reset functionality of the application. Previously, the application was not validating the host/domain from which the password reset request originated. This allowed attackers to potentially trigger password reset emails with arbitrary hostnames, leading to phishing or other malicious activities.

**Weaknesses/Vulnerabilities Present:**

*   **Insecure Password Reset Process:** The core vulnerability is the lack of proper validation of the origin of the password reset request. Specifically, the `forgot-password` API endpoint did not check whether the `host` or `origin` provided in the request was a valid domain associated with the application.
*   **Reliance on User-Provided Data:** The application was directly using the `origin` value from the request body, which can be controlled by the attacker, without proper validation. If not provided, it uses the value from request headers `getHostFromHeaders`, which can also be spoofed.

**Impact of Exploitation:**

*   **Phishing Attacks:** An attacker could initiate password reset requests, specifying a malicious domain in the `host` or `origin`, included in the reset email. The victim might then click on the provided link, believing it is legitimate, and enter their credentials on the attacker-controlled page.
*   **Account Takeover:** By directing the password reset to a malicious page, an attacker could potentially capture the user's new password, leading to account compromise.
*   **Reputational Damage:** Successful exploitation could harm the application's reputation due to users falling victim to these attacks.

**Attack Vectors:**

*   **Direct API Manipulation:** An attacker can directly send a POST request to the `/api/forgot-password` endpoint with a crafted body containing a malicious `origin` or spoofed headers containing malicious host information.
*   **Cross-Site Scripting (XSS) (Potential, not directly evident):** While not directly mentioned, the lack of validation of the `origin` value *could* potentially be exploited if the `origin` value was also displayed to the user elsewhere, allowing a stored XSS attack. However, this isn't specifically addressed in the commit, just the context of the password reset link.

**Required Attacker Capabilities/Position:**

*   **Network Access:** The attacker needs to be able to make HTTP requests to the application's API endpoint, `/api/forgot-password`.
*   **Knowledge of the API:** The attacker needs to know the structure of the API request (i.e., the request body and headers including email and origin/host values)
*   **Ability to Host a Phishing Site:**  The attacker needs to set up a fake website to redirect the victim to, which could capture user credentials.

**Mitigation (From Commit):**

The commit introduces a function called `checkDomain` that checks if the provided host is valid.
This `checkDomain` function performs the following:
    * In a development environment, it returns true
    * For production environments, it checks the host against a hardcoded list of valid domains ('linen.dev' and 'www.linen.dev')
    * It checks the provided domain against `redirectDomain` values in the `accounts` database table

The request processing has been updated to first validate the domain before sending the email.

**Additional Notes:**

The commit message "check for valid host when reseting password" clearly indicates the purpose of the changes. The diff shows that a function called `checkDomain` has been implemented that checks for valid domains to prevent arbitrary domain usage when resetting the password.

The original vulnerability description does not have any details. The analysis above is based on the provided commit.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 283 | Unverified Ownership | Base | Allowed | sparse | 0.060 |
| 2 | 319 | Cleartext Transmission of Sensitive Information | Base | Allowed | sparse | 0.057 |
| 3 | 306 | Missing Authentication for Critical Function | Base | Allowed | sparse | 0.054 |
| 4 | 425 | Direct Request ('Forced Browsing') | Base | Allowed | sparse | 0.053 |
| 5 | 352 | Cross-Site Request Forgery (CSRF) | Compound | Allowed | sparse | 0.051 |
| 6 | 346 | Origin Validation Error | Class | Allowed-with-Review | sparse | 0.051 |
| 7 | 287 | Improper Authentication | Class | Discouraged | sparse | 0.051 |
| 8 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.050 |
| 9 | 620 | Unverified Password Change | Base | Allowed | dense | 0.377 |
| 10 | 471 | Modification of Assumed-Immutable Data (MAID) | Base | Allowed | graph | 0.002 |

