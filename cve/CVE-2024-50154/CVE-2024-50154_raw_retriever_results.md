# Raw Retriever Results for CVE-2024-50154

# Raw Retriever Results for CVE-2024-50154
## Query
In the Linux kernel, the following vulnerability has been resolved tcp/dccp Dont use timer_pending() in reqsk_queue_unlink(). Martin KaFai Lau reported use-after-free [0] in reqsk_timer_handler(). We are seeing a use-after-free from a bpf prog attached to trace_tcp_retransmit_synack. The program passes the req->sk to the bpf_sk_storage_get_tracing kernel helper which does check for null before using it. The commit 83fccfc3940c (inet fix potential deadlock in reqsk_queue_unlink()) added timer_pending() in reqsk_queue_unlink() not to call del_timer_sync() from reqsk_timer_handler(), but it introduced a small race window. Before the timer is called, expire_timers() calls detach_timer(timer, true) to clear timer->entry.pprev and marks it as not pending. If reqsk_queue_unlink() checks timer_pending() just after expire_timers() calls detach_timer(), TCP will miss del_timer_sync() the reqsk timer will continue running and send multiple SYN+ACKs until it expires. The reported UAF could happen if req->sk is close()d earlier than the timer expiration, which is 63s by default. The scenario would be 1. inet_csk_complete_hashdance() calls inet_csk_reqsk_queue_drop(), but del_timer_sync() is missed 2. reqsk timer is executed and scheduled again 3. req->sk is accept()ed and reqsk_put() decrements rsk_refcnt, but reqsk timer still has another one, and inet_csk_accept() does not clear req->sk for non-TFO sockets 4. sk is close()d 5. reqsk timer is executed again, and BPF touches req->sk Lets not use timer_pending() by passing the caller context to __inet_csk_reqsk_queue_drop(). Note that reqsk timer is pinned, so the issue does not happen in most use cases. [1] [0] BUG KFENCE use-after-free read in bpf_sk_storage_get_tracing+0x2e/0x1b0 Use-after-free read at 0x00000000a891fb3a (in kfence-#1) bpf_sk_storage_get_tracing+0x2e/0x1b0 bpf_prog_5ea3e95db6da0438_tcp_retransmit_synack+0x1d20/0x1dda bpf_trace_run2+0x4c/0xc0 tcp_rtx_synack+0xf9/0x100 reqsk_timer_handler+0xda/0x3d0 run_timer_softirq+0x292/0x8a0 irq_exit_rcu+0xf5/0x320 sysvec_apic_timer_interrupt+0x6d/0x80 asm_sysvec_apic_timer_interrupt+0x16/0x20 intel_idle_irq+0x5a/0xa0 cpuidle_enter_state+0x94/0x273 cpu_startup_entry+0x15e/0x260 start_secondary+0x8a/0x90 secondary_startup_64_no_verify+0xfa/0xfb kfence-#1 0x00000000a72cc7b6-0x00000000d97616d9, size=2376, cache=TCPv6 allocated by task 0 on cpu 9 at 260507.901592s sk_prot_alloc+0x35/0x140 sk_clone_lock+0x1f/0x3f0 inet_csk_clone_lock+0x15/0x160 tcp_create_openreq_child+0x1f/0x410 tcp_v6_syn_recv_sock+0x1da/0x700 tcp_check_req+0x1fb/0x510 tcp_v6_rcv+0x98b/0x1420 ipv6_list_rcv+0x2258/0x26e0 napi_complete_done+0x5b1/0x2990 mlx5e_napi_poll+0x2ae/0x8d0 net_rx_action+0x13e/0x590 irq_exit_rcu+0xf5/0x320 common_interrupt+0x80/0x90 asm_common_interrupt+0x22/0x40 cpuidle_enter_state+0xfb/0x273 cpu_startup_entry+0x15e/0x260 start_secondary+0x8a/0x90 secondary_startup_64_no_verify+0xfa/0xfb freed by task 0 on cpu 9 at 260507.927527s rcu_core_si+0x4ff/0xf10 irq_exit_rcu+0xf5/0x320 sysvec_apic_timer_interrupt+0x6d/0x80 asm_sysvec_apic_timer_interrupt+0x16/0x20 cpuidle_enter_state+0xfb/0x273 cpu_startup_entry+0x15e/0x260 start_secondary+0x8a/0x90 secondary_startup_64_no_verify+0xfa/0xfb

## Keyphrases
- **rootcause**: 'The commit 83fccfc3940c introduced a race condition by using timer_pending() in reqsk_queue_unlink()', 'which could lead to missing del_timer_sync() calls', 'subsequently', 'a use-after-free.'
- **weakness**: 'Race condition in timer handling within reqsk_queue_unlink(). The check for timer_pending() can return an incorrect value if it happens immediately after detach_timer()', 'leading to the timer not being properly cancelled. The use of a bpf prog attached to trace_tcp_retransmit_synack triggers the bug.'

## Score Statistics
| Retriever | Min | Max | Mean | Median | Count |
|-----------|-----|-----|------|--------|-------|
| Dense | 0.4997 | 0.5832 | 0.5335 | 0.5333 | 20 |
| Sparse | 800.0000 | 1212.6722 | 1078.2251 | 1081.9618 | 13 |
| Graph | 1.3572 | 2.8652 | 1.7893 | 1.6848 | 20 |

## Graph Retriever Results (20)
| # | CWE ID | Name | Abstraction | Score | Mapping Usage |
|---|--------|------|-------------|-------|---------------|
| 1 | 609 | Double-Checked Locking | base | 2.8652 | Allowed |
| 2 | 386 | Symbolic Name not Mapping to Correct Object | base | 2.3764 | Allowed |
| 3 | 390 | Detection of Error Condition Without Action | base | 2.2100 | Allowed |
| 4 | 1322 | Use of Blocking Code in Single-threaded, Non-blocking Context | base | 2.2100 | Allowed |
| 5 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | 2.0585 | Allowed |
| 6 | 120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | base | 1.7680 | Allowed-with-Review |
| 7 | 123 | Write-what-where Condition | base | 1.7680 | Allowed |
| 8 | 364 | Signal Handler Race Condition | base | 1.7550 | Allowed |
| 9 | 366 | Race Condition within a Thread | Base | 1.7122 | Allowed |
| 10 | 1265 | Unintended Reentrant Invocation of Non-reentrant Code Via Nested Calls | base | 1.6848 | Allowed |
| 11 | 1325 | Improperly Controlled Sequential Memory Allocation | base | 1.6848 | Allowed |
| 12 | 662 | Improper Synchronization | class | 1.6736 | Discouraged |
| 13 | 61 | UNIX Symbolic Link (Symlink) Following | compound | 1.6100 | Allowed |
| 14 | 476 | NULL Pointer Dereference | Base | 1.5517 | Allowed |
| 15 | 908 | Use of Uninitialized Resource | Base | 1.5511 | Allowed |

## Dense Retriever Results (20)
| # | CWE ID | Name | Abstraction | Score | Original Score | Mapping Usage |
|---|--------|------|-------------|-------|----------------|---------------|
| 1 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | 0.5832 | 0.5832 | Allowed-with-Review |
| 2 | 401 | Missing Release of Memory after Effective Lifetime | Variant | 0.5772 | 0.5772 | Allowed |
| 3 | 909 | Missing Initialization of Resource | Class | 0.5649 | 0.5649 | Allowed-with-Review |
| 4 | 366 | Race Condition within a Thread | Base | 0.5580 | 0.5580 | Allowed |
| 5 | 835 | Loop with Unreachable Exit Condition ('Infinite Loop') | Base | 0.5570 | 0.5570 | Allowed |
| 6 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | 0.5509 | 0.5509 | Allowed |
| 7 | 416 | Use After Free | Variant | 0.5487 | 0.5487 | Allowed |
| 8 | 191 | Integer Underflow (Wrap or Wraparound) | Base | 0.5474 | 0.5474 | Allowed |
| 9 | 606 | Unchecked Input for Loop Condition | Base | 0.5446 | 0.5446 | Allowed |
| 10 | 1285 | Improper Validation of Specified Index, Position, or Offset in Input | Base | 0.5428 | 0.5428 | Allowed |
| 11 | 667 | Improper Locking | Class | 0.5237 | 0.5237 | Allowed-with-Review |
| 12 | 400 | Uncontrolled Resource Consumption | Class | 0.5212 | 0.5212 | Discouraged |
| 13 | 770 | Allocation of Resources Without Limits or Throttling | Base | 0.5206 | 0.5206 | Allowed |
| 14 | 121 | Stack-based Buffer Overflow | Variant | 0.5106 | 0.5106 | Allowed |
| 15 | 908 | Use of Uninitialized Resource | Base | 0.5048 | 0.5048 | Allowed |

## Sparse Retriever Results (13)
| # | CWE ID | Name | Score | Original Score | Mapping Usage |
|---|--------|------|-------|---------------|---------------|
| 1 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | 1212.6722 | 1212.6722 | Allowed-with-Review |
| 2 | 667 | Improper Locking | 1178.9778 | 1178.9778 | Allowed-with-Review |
| 3 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | 1154.2316 | 1154.2316 | Allowed |
| 4 | 401 | Missing Release of Memory after Effective Lifetime | 1147.7931 | 1147.7931 | Allowed |
| 5 | 863 | Incorrect Authorization | 1099.6586 | 1099.6586 | Allowed-with-Review |
| 6 | 364 | Signal Handler Race Condition | 1085.5807 | 1085.5807 | Allowed |
| 7 | 1284 | Improper Validation of Specified Quantity in Input | 1081.9618 | 1081.9618 | Allowed |
| 8 | 476 | NULL Pointer Dereference | 1067.0160 | 1067.0160 | Allowed |
| 9 | 789 | Memory Allocation with Excessive Size Value | 1065.1828 | 1065.1828 | Allowed |
| 10 | 833 | Deadlock | 1060.0993 | 1060.0993 | Allowed |
| 11 | 306 | Missing Authentication for Critical Function | 1033.1734 | 1033.1734 | Allowed |
| 12 | 415 | Double Free | 1030.5790 | 1030.5790 | Allowed |
| 13 | 416 | Use After Free | 800.0000 | 800.0000 | Allowed |
