# Vulnerability Information: CVE-2024-39305

## Vulnerability Description
Envoy is a cloud-native, open source edge and service proxy. Prior to versions 1.30.4, 1.29.7, 1.28.5, and 1.27.7. Envoy references already freed memory when route hash policy is configured with cookie attributes. Note that this vulnerability has been fixed in the open as the effect would be immediately apparent if it was configured. Memory allocated for holding attribute values is freed after configuration was parsed. During request processing Envoy will attempt to copy content of de-allocated memory into request cookie header. This can lead to arbitrary content of Envoys memory to be sent to the upstream service or abnormal process termination. This vulnerability is fixed in Envoy versions v1.30.4, v1.29.7, v1.28.5, and v1.27.7. As a workaround, do not use cookie attributes in route action hash policy.

### Vulnerability Description Key Phrases
- **rootcause:** **use after free**
- **impact:** arbitrary content of Envoys memory to be sent to the upstream service or abnormal process termination
- **product:** Envoy
- **version:** prior to 1.30.4, 1.29.7, 1.28.5, and 1.27.7

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2024-39305:

**Root cause of vulnerability:**
- The vulnerability is a use-after-free. Memory allocated to hold cookie attribute values is freed after the configuration parsing phase. During request processing, Envoy attempts to copy the content of this de-allocated memory into the request cookie header.

**Weaknesses/vulnerabilities present:**
- Use-after-free vulnerability (CWE-416). This occurs when the program attempts to access memory that has already been freed.

**Impact of exploitation:**
- **Information Disclosure:** Arbitrary content from Envoy's memory can be sent to the upstream service via the cookie header.
- **Denial of Service:** The process may terminate abnormally, leading to a denial of service.

**Attack vectors:**
- A request from an untrusted peer. An attacker can trigger this vulnerability by sending a crafted request to a vulnerable Envoy instance.

**Required attacker capabilities/position:**
- The attacker needs to be able to send HTTP requests to the Envoy instance. No specific privileges are required.

**Additional Details:**
- The vulnerability is triggered when the route hash policy is configured with cookie attributes.
- The fix was developed in the open due to its easily noticeable impact.
- The affected Envoy versions are v1.30.3, v1.29.6, v1.28.4, and v1.27.6.
- Patched versions are v1.30.4, v1.29.7, v1.28.5, and v1.27.7.
- A workaround involves not using cookie attributes in the route action hash policy.
- Detection can be done by observing unexpected characters in the cookie header at the upstream service or via abnormal process termination with route hash policy methods in the stack trace.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 674 | Uncontrolled Recursion | Class | Allowed-with-Review | sparse | 0.734 |
| 2 | 287 | Improper Authentication | Class | Discouraged | sparse | 0.717 |
| 3 | 190 | Integer Overflow or Wraparound | Base | Allowed | sparse | 0.710 |
| 4 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.702 |
| 5 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 0.681 |
| 6 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.681 |
| 7 | 1390 | Weak Authentication | Class | Allowed-with-Review | sparse | 0.677 |
| 8 | 327 | Use of a Broken or Risky Cryptographic Algorithm | Class | Allowed-with-Review | sparse | 0.675 |
| 9 | 784 | Reliance on Cookies without Validation and Integrity Checking in a Security Decision | Variant | Allowed | dense | 0.471 |
| 10 | 128 | Wrap-around Error | Base | Allowed | graph | 0.002 |

