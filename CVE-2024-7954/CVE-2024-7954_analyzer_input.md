# Vulnerability Information: CVE-2024-7954

## Vulnerability Description
The porte_plume plugin used by SPIP before 4.30-alpha2, 4.2.13, and 4.1.16 is vulnerable to an arbitrary code execution vulnerability. A remote and unauthenticated attacker can execute arbitrary PHP as the SPIP user by sending a crafted HTTP request.

### Vulnerability Description Key Phrases
- **impact:** arbitrary code execution
- **vector:** crafted HTTP request
- **attacker:** remote and unauthenticated attacker
- **product:** SPIP
- **version:** before 4.30-alpha2, 4.2.13, and 4.1.16
- **component:** porte_plume plugin

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root Cause:**

The vulnerability stems from a combination of issues within the `porte_plume` plugin of the SPIP CMS, specifically how it handles previsualization of content, and how links and templating are processed.  The core issue is that user-controlled input is eventually passed to an `eval()` statement, allowing for arbitrary code execution.

**Weaknesses/Vulnerabilities Present:**

1.  **Unauthenticated Previsualization Feature:** The `porte_plume` plugin's previsualization feature is accessible without authentication. This allows an attacker to send crafted requests to trigger the vulnerable code paths.
2.  **IDOR (Indirect Object Reference) in Document Resolution:** The previsualization feature allows resolving document and image IDs to full URLs. While not the primary vulnerability, this can be abused to dump the site content by obtaining file paths if the files lack ACL or extra protection.
3.  **Insecure Template Processing:** The system processes links and formatting, and the way it handles links within the previsualization feature is flawed. Specifically, the `include_modele` function does not sanitize the `href` and `class` attributes of the `<a>` tag. This allows an attacker to inject arbitrary code into these attributes.
4.  **`eval()` Usage:** The core vulnerability exists because the application uses `eval()` on user-controlled data when processing certain template tags, specifically when the `_PROTEGE_PHP_MODELES` constant is defined. This occurs in the `traitements_previsu` and `traitements_previsu_php_modeles_eval` functions.
5.  **Insufficient Sanitization:**  The sanitization of user input is insufficient, and can be bypassed using template syntax and specific filtering, allowing the injection of PHP code for evaluation. The vulnerability is triggered due to the way URLs are formatted and resolved in the previsualization, using the templating system.

**Impact of Exploitation:**

Successful exploitation allows an attacker to achieve:
*   **Remote Code Execution (RCE):** Arbitrary PHP code can be executed on the server, potentially leading to complete system compromise.
*   **Information Disclosure:** The IDOR vulnerability can be used to expose sensitive files on the server.
*   **Full System Compromise:** The RCE can give the attacker the ability to read files, write files, and execute arbitrary shell commands on the underlying server and pivot into the internal network.

**Attack Vectors:**

*   **HTTP POST Request:** The primary attack vector involves sending a specially crafted HTTP POST request to the `/index.php?action=porte_plume_previsu` endpoint. The `data` parameter contains the malicious payload.
*   **Abuse of Template Syntax:** The attacker leverages specific template syntax like `[<model>->url]` or `<a href="X" class="Y"><model|a|b></a>` to inject the payload.
*   **Image/Document ID Resolution Abuse:** Though not a direct vulnerability for RCE, the IDOR vulnerability can be exploited to enumerate site files using the previsualization endpoint.

**Required Attacker Capabilities/Position:**

*   **Network Access:** The attacker needs network access to the vulnerable SPIP instance.
*   **No Authentication Required:** The attack can be carried out without any authentication, making it a highly critical vulnerability.
*   **Knowledge of SPIP Template Syntax:** The attacker needs some knowledge of the SPIP template system to craft the required payloads.

**More Details than the CVE Description:**

The provided content offers considerably more detail than a typical CVE description would, including:
*   Specific vulnerable code snippets and functions (`traitements_previsu`, `traitements_previsu_php_modeles_eval`, `echappe_retour`, `include_modele`).
*   Details on how the vulnerability was discovered (automated diffing of code changes).
*   Exploit payloads and steps to reproduce the vulnerability.
*   Explanation of the Spip templating engine and how it contributes to the vulnerability
*   Multiple different exploit paths.
*   Analysis of the patch.
*   Traces of the code execution using xdebug.
*   Write-ups from multiple researchers who solved a challenge based on this vulnerability.
*   A Nuclei template for detection.

The content also highlights the patch, which includes sanitizing URLs via the `attribut_url()` filter, and restricting access to the previsualization feature in the `porte_plume` plugin to administrators in the public area.

The content goes beyond the basic description of the CVE and provides a thorough understanding of the vulnerability and its exploitation.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 138 | Improper Neutralization of Special Elements | Class | Discouraged | sparse | 0.088 |
| 2 | 352 | Cross-Site Request Forgery (CSRF) | Compound | Allowed | sparse | 0.087 |
| 3 | 116 | Improper Encoding or Escaping of Output | Class | Allowed-with-Review | sparse | 0.087 |
| 4 | 502 | Deserialization of Untrusted Data | Base | Allowed | sparse | 0.085 |
| 5 | 74 | Improper Neutralization of Special Elements in Output Used by a Downstream Component ('Injection') | Class | Discouraged | sparse | 0.085 |
| 6 | 22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | sparse | 0.085 |
| 7 | 78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | sparse | 0.085 |
| 8 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | sparse | 0.084 |
| 9 | 96 | Improper Neutralization of Directives in Statically Saved Code ('Static Code Injection') | Base | Allowed | dense | 0.526 |
| 10 | 494 | Download of Code Without Integrity Check | Base | Allowed | graph | 0.002 |

