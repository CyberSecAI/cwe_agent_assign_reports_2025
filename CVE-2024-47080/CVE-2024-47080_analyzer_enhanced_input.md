## Vulnerability Description
matrix-js-sdk is the Matrix Client-Server SDK for JavaScript and TypeScript. In matrix-js-sdk versions versions 9.11.0 through 34.7.0, the method `MatrixClient.sendSharedHistoryKeys` is vulnerable to interception by malicious homeservers. The method was introduced by MSC3061) and is commonly used to share historical message keys with newly invited users, granting them access to past messages in the room. However, it unconditionally sends these shared keys to all of the invited users devices, regardless of whether the users cryptographic identity is verified or whether the users devices are signed by that identity. This allows the attacker to potentially inject its own devices to receive sensitive historical keys without proper security checks. Note that this only affects clients running the SDK with the legacy crypto stack. Clients using the new Rust cryptography stack (i.e. those that call `MatrixClient.initRustCrypto()` instead of `MatrixClient.initCrypto()`) are unaffected by this vulnerability, because `MatrixClient.sendSharedHistoryKeys()` raises an exception in such environments. The vulnerability was fixed in matrix-js-sdk 34.8.0 by removing the vulnerable functionality. As a workaround, remove use of affected functionality from clients.

### Vulnerability Description Key Phrases
- **rootcause:** **improper security checks**
- **impact:** receive sensitive historical keys
- **attacker:** malicious homeservers
- **product:** matrix-js-sdk
- **version:** 9.11.0 through 34.7.0
- **component:** MatrixClient.sendSharedHistoryKeys

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2024-47080:

**Root Cause of Vulnerability:**

The vulnerability stems from the `MatrixClient.sendSharedHistoryKeys` method in the `matrix-js-sdk`. This method, intended to share historical message keys with newly invited users, was implemented insecurely. It unconditionally sent these keys to *all* of the invited user's devices, regardless of whether those devices were verified or signed by the user's identity.

**Weaknesses/Vulnerabilities Present:**

*   **Lack of Device Verification:** The primary weakness is the absence of proper checks to verify the authenticity and trustworthiness of the recipient devices before sharing encryption keys. This allows malicious actors to potentially intercept keys by injecting their own devices to receive the shared keys.
*   **Unconditional Key Sharing:** The method sends keys to all devices without any validation of device ownership, making the process inherently insecure.

**Impact of Exploitation:**

*   **Interception of Encrypted Messages:** A malicious homeserver or an attacker with control over an unverified device can intercept the shared historical message keys. This enables the attacker to decrypt and read the past messages in the room, thus bypassing the end-to-end encryption.
*   **Breach of Privacy:** Unauthorized access to past messages compromises user privacy.

**Attack Vectors:**

*   **Malicious Homeserver:** A malicious homeserver could inject its own devices into the recipient's device list, enabling it to receive the shared keys.
*   **Compromised Devices:** An attacker who has compromised one of the recipient's devices can gain access to past encrypted messages if the keys are shared with the compromised device.

**Required Attacker Capabilities/Position:**

*   **Control over a Homeserver (or ability to manipulate device lists):** An attacker needs to be able to manipulate the device list of a user to inject their own devices. This can be done via a malicious homeserver or by compromising a homeserver.
*   **Ability to receive shared keys:** The attacker needs a device on the target user's account, or the ability to add a device to it.

**Additional Notes:**

*   The vulnerability affects clients using the legacy crypto stack of the `matrix-js-sdk`.
*   Clients using the newer Rust crypto stack are not affected, as `MatrixClient.sendSharedHistoryKeys()` raises an exception in those environments.
*   The vulnerable functionality was removed in `matrix-js-sdk` version 34.8.0, which is the recommended fix.
*   The vulnerability is related to MSC3061, which is a proposal for sharing room keys for past messages. This MSC was ultimately reverted due to the security concerns highlighted by this vulnerability.

The provided content contains more details than the standard CVE description would typically contain, offering insights into the specific implementation issues and the surrounding context of the vulnerability.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 290 | Authentication Bypass by Spoofing | Base | Allowed | sparse | 1.058 |
| 2 | 327 | Use of a Broken or Risky Cryptographic Algorithm | Class | Allowed-with-Review | sparse | 0.930 |
| 3 | 770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | sparse | 0.930 |
| 4 | 347 | Improper Verification of Cryptographic Signature | Base | Allowed | sparse | 0.929 |
| 5 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.913 |
| 6 | 306 | Missing Authentication for Critical Function | Base | Allowed | sparse | 0.878 |
| 7 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.877 |
| 8 | 522 | Insufficiently Protected Credentials | Class | Allowed-with-Review | sparse | 0.870 |
| 9 | 322 | Key Exchange without Entity Authentication | Base | Allowed | dense | 0.449 |
| 10 | 208 | Observable Timing Discrepancy | Base | Allowed | graph | 0.002 |



# Complete CWE Specifications

CWE-290: Authentication Bypass by Spoofing

CWE-327: Use of a Broken or Risky Cryptographic Algorithm

CWE-770: Allocation of Resources Without Limits or Throttling

CWE-347: Improper Verification of Cryptographic Signature

CWE-863: Incorrect Authorization

CWE-306: Missing Authentication for Critical Function

CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition

CWE-522: Insufficiently Protected Credentials

CWE-322: Key Exchange without Entity Authentication

CWE-208: Observable Timing Discrepancy