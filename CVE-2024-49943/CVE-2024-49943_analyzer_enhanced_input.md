## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved drm/xe/guc_submit add **missing locking** in wedged_fini Any non-wedged queue can have a zero refcount here and can be running concurrently with an async queue destroy, therefore dereferencing the queue ptr to check wedge status after the lookup can trigger UAF if queue is not wedged. Fix this by keeping the submission_state lock held around the check to postpone the free and make the check safe, before dropping again around the put() to avoid the deadlock. (cherry picked from commit d28af0b6b9580b9f90c265a7da0315b0ad20bbfd)

### Vulnerability Description Key Phrases
- **rootcause:** **missing locking**
- **weakness:** **use-after-free**
- **impact:** UAF
- **product:** Linux kernel
- **component:** drm/xe/guc_submit

## CVE Reference Links Content Summary
The provided content relates to a fix for a use-after-free (UAF) vulnerability in the Linux kernel's `xe_guc_submit.c` driver.

**Root cause of vulnerability:**
- A race condition exists in `guc_submit_wedged_fini` where a non-wedged queue can have a zero reference count and be concurrently destroyed asynchronously.
- Dereferencing the queue pointer to check its wedge status after the lookup can lead to a UAF if the queue is not actually wedged.

**Weaknesses/vulnerabilities present:**
- Use-after-free (UAF) vulnerability in `guc_submit_wedged_fini`.
- Race condition between queue destruction and accessing the queue's wedged status.
- Missing locking mechanism protecting queue data during access.

**Impact of exploitation:**
- A successful exploitation could lead to a system crash or potentially allow for arbitrary code execution due to the UAF vulnerability.

**Attack vectors:**
- Triggering the conditions that lead to the race condition during GPU operations, which leads to the async queue destroy.
- Triggering the execution of guc_submit_wedged_fini via GPU hang scenario.

**Required attacker capabilities/position:**
- Ability to trigger GPU hangs or other scenarios that lead to `guc_submit_wedged_fini` execution.
- No specific position is mentioned, but local access to the system is required to interact with the GPU drivers.

**Additional details:**
- The fix introduces a mutex lock to protect access to the queue and its wedged status.
- The lock is held during the check and released before the call to `xe_exec_queue_put()` to prevent deadlocks.
- The fix was backported to stable kernel branches.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 416 | Use After Free | Variant | Allowed | alternate_terms | 1.000 |
| 2 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.497 |
| 3 | 833 | Deadlock | Base | Allowed | sparse | 0.486 |
| 4 | 606 | Unchecked Input for Loop Condition | Base | Allowed | sparse | 0.458 |
| 5 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.455 |
| 6 | 770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | sparse | 0.450 |
| 7 | 1285 | Improper Validation of Specified Index, Position, or Offset in Input | Base | Allowed | sparse | 0.447 |
| 8 | 190 | Integer Overflow or Wraparound | Base | Allowed | sparse | 0.422 |
| 9 | 413 | Improper Resource Locking | Base | Allowed | dense | 0.535 |
| 10 | 364 | Signal Handler Race Condition | Base | Allowed | graph | 0.003 |



# Complete CWE Specifications

CWE-416: Use After Free

CWE-667: Improper Locking

CWE-833: Deadlock

CWE-606: Unchecked Input for Loop Condition

CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')

CWE-770: Allocation of Resources Without Limits or Throttling

CWE-1285: Improper Validation of Specified Index, Position, or Offset in Input

CWE-190: Integer Overflow or Wraparound

CWE-413: Improper Resource Locking

CWE-364: Signal Handler Race Condition