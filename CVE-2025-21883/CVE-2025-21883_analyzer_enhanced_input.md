## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved ice Fix deinitializing VF in error path If ice_ena_vfs() fails after calling ice_create_vf_entries(), it frees all VFs without removing them from snapshot PF-VF mailbox list, leading to list corruption. Reproducer devlink dev eswitch set $PF1_PCI mode switchdev ip l s $PF1 up ip l s $PF1 promisc on sleep 1 echo 1 > /sys/class/net/$PF1/device/sriov_numvfs sleep 1 echo 1 > /sys/class/net/$PF1/device/sriov_numvfs Trace (minimized) list_add corruption. next->prev should be prev (ffff8882e241c6f0), but was 0000000000000000. (next=ffff888455da1330). kernel BUG at lib/list_debug.c29! RIP 0010__list_add_valid_or_report+0xa6/0x100 ice_mbx_init_vf_info+0xa7/0x180 [ice] ice_initialize_vf_entry+0x1fa/0x250 [ice] ice_sriov_configure+0x8d7/0x1520 [ice] ? __percpu_ref_switch_mode+0x1b1/0x5d0 ? __pfx_ice_sriov_configure+0x10/0x10 [ice] Sometimes a KASAN report can be seen instead with a similar stack trace BUG KASAN **use-after-free** in __list_add_valid_or_report+0xf1/0x100 VFs are added to this list in ice_mbx_init_vf_info(), but only removed in ice_free_vfs(). Move the removing to ice_free_vf_entries(), which is also being called in other places where VFs are being removed (including ice_free_vfs() itself).

### Vulnerability Description Key Phrases
- **rootcause:** **use-after-free**
- **impact:** list corruption and kernel BUG
- **product:** Linux kernel
- **component:** ice

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 416 | Use After Free | Variant | Allowed | alternate_terms | 1.000 |
| 2 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.554 |
| 3 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.552 |
| 4 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.516 |
| 5 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.510 |
| 6 | 226 | Sensitive Information in Resource Not Removed Before Reuse | Base | Allowed | sparse | 0.498 |
| 7 | 415 | Double Free | Variant | Allowed | sparse | 0.497 |
| 8 | 909 | Missing Initialization of Resource | Class | Allowed-with-Review | sparse | 0.497 |
| 9 | 1285 | Improper Validation of Specified Index, Position, or Offset in Input | Base | Allowed | dense | 0.522 |
| 10 | 364 | Signal Handler Race Condition | Base | Allowed | graph | 0.003 |



# Complete CWE Specifications

CWE-416: Use After Free

CWE-667: Improper Locking

CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')

CWE-401: Missing Release of Memory after Effective Lifetime

CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition

CWE-226: Sensitive Information in Resource Not Removed Before Reuse

CWE-415: Double Free

CWE-909: Missing Initialization of Resource

CWE-1285: Improper Validation of Specified Index, Position, or Offset in Input

CWE-364: Signal Handler Race Condition