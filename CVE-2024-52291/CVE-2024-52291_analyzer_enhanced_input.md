## Vulnerability Description
Craft is a content management system (CMS). A vulnerability in CraftCMS allows an attacker to bypass local file system validation by utilizing a **double file// scheme** (e.g., file//file////). This enables the attacker to specify sensitive folders as the file system, leading to potential file overwriting through malicious uploads, unauthorized access to sensitive files, and, under certain conditions, remote code execution (RCE) via **Server-Side Template Injection** (SSTI) payloads. Note that this will only work if you have an authenticated administrator account with allowAdminChanges enabled. This is fixed in 5.4.6 and 4.12.5.

### Vulnerability Description Key Phrases
- **rootcause:** **double file// scheme**
- **weakness:** **Server-Side Template Injection**
- **impact:** ['file overwriting through malicious uploads' and 'unauthorized access to sensitive files' and 'remote code execution (RCE)']
- **vector:** malicious uploads
- **attacker:** attacker
- **product:** CraftCMS
- **version:** prior to 5.4.6 and 4.12.5

## CVE Reference Links Content Summary
- **Root cause of vulnerability:** The vulnerability stems from insufficient sanitization of the file path in `cms/src/helpers/FileHelper.php`. The function `normalizePath` removes only one `file://` prefix from the input path. By providing a path with two `file://` prefixes (e.g., `file://file:////path`), an attacker can bypass the sanitization.

- **Weaknesses/vulnerabilities present:**
    - **Local File System Validation Bypass:** The double `file://` prefix bypasses the intended path validation, allowing the attacker to specify arbitrary local file system locations.
    - **File Overwrite:** Attackers can upload files to the server that can overwrite existing files within the validated, or exploited, path.
    - **Sensitive File Access:** By specifying the base path to a sensitive location and enabling public URLs, attackers can retrieve files they are otherwise not permitted to access.
    - **Potential Code Execution:** While not fully proven, attackers may achieve Remote Code Execution (RCE) via Server-Side Template Injection (SSTI) by uploading malicious files (e.g., into the `/templates` directory), as the system's SSTI input sanitization can be bypassed.

- **Impact of exploitation:**
    - Overwriting critical application files, leading to application malfunctions or compromise.
    - Unauthorized access to sensitive information stored in server files, including configuration files.
    - Potential remote code execution, enabling complete server control by the attacker.

- **Attack vectors:**
    - Network-based attack, where an attacker exploits the vulnerability through a web interface.
    - The attacker needs to be an authenticated administrator of the CraftCMS instance.
    - The CraftCMS installation must have the `allowAdminChanges` config setting set to true.
    - Attacker crafts a malicious file path using a double `file://` prefix when creating a new asset volume.

- **Required attacker capabilities/position:**
    - The attacker must have administrative access to a vulnerable CraftCMS instance and the config setting `allowAdminChanges` must be enabled.
    - Ability to navigate to the "Settings -> Assets" section of the admin panel
    - Ability to upload files.
    - Knowledge of the vulnerable double `file://` prefix to bypass sanitization

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 1007 | Insufficient Visual Distinction of Homoglyphs Presented to User | Base | Allowed | alternate_terms | 0.700 |
| 2 | 1021 | Improper Restriction of Rendered UI Layers or Frames | Base | Allowed | alternate_terms | 0.700 |
| 3 | 1022 | Use of Web Link to Untrusted Target with window.opener Access | Variant | Allowed | alternate_terms | 0.700 |
| 4 | 1336 | Improper Neutralization of Special Elements Used in a Template Engine | Base | Allowed | sparse | 1.000 |
| 5 | 22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | sparse | 0.496 |
| 6 | 434 | Unrestricted Upload of File with Dangerous Type | Base | Allowed | sparse | 0.488 |
| 7 | 285 | Improper Authorization | Class | Discouraged | sparse | 0.481 |
| 8 | 23 | Relative Path Traversal | Base | Allowed | sparse | 0.477 |
| 9 | 352 | Cross-Site Request Forgery (CSRF) | Compound | Allowed | dense | 0.603 |
| 10 | 183 | Permissive List of Allowed Inputs | Base | Allowed | graph | 0.002 |



# Complete CWE Specifications

CWE-1007: Insufficient Visual Distinction of Homoglyphs Presented to User

CWE-1021: Improper Restriction of Rendered UI Layers or Frames

CWE-1022: Use of Web Link to Untrusted Target with window.opener Access

CWE-1336: Improper Neutralization of Special Elements Used in a Template Engine

CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')

CWE-434: Unrestricted Upload of File with Dangerous Type

CWE-285: Improper Authorization

CWE-23: Relative Path Traversal

CWE-352: Cross-Site Request Forgery (CSRF)

CWE-183: Permissive List of Allowed Inputs