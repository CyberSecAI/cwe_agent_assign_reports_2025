# Vulnerability Information: CVE-2024-52803

## Vulnerability Description
LLama Factory enables fine-tuning of large language models. A critical remote **OS command injection** vulnerability has been identified in the LLama Factory training process. This vulnerability arises from **improper handling of user input**, allowing malicious actors to execute arbitrary OS commands on the host system. The issue is caused by insecure usage of the `Popen` function with `shell=True`, coupled with unsanitized user input. Immediate remediation is required to mitigate the risk. This vulnerability is fixed in 0.9.1.

### Vulnerability Description Key Phrases
- **rootcause:** **improper handling of user input**
- **weakness:** **OS command injection**
- **impact:** execute arbitrary OS commands
- **attacker:** malicious actors
- **product:** LLama Factory
- **version:** prior to 0.9.1
- **component:** training process

## CVE Reference Links Content Summary
Based on the provided information, here's an analysis of CVE-2024-52803:

**Root Cause of Vulnerability:**

The vulnerability stems from the insecure use of the `Popen` function in the Llama Factory training process. Specifically, the `shell=True` option is used, which allows the execution of shell commands.  User-provided input, specifically the `output_dir` value, is directly inserted into the command string passed to `Popen` without sanitization. This allows an attacker to inject arbitrary OS commands.

**Weaknesses/Vulnerabilities Present:**

*   **Remote OS Command Injection:** The primary vulnerability is that an attacker can inject malicious OS commands via the `output_dir` parameter by crafting a specific input.
*   **Unsafe `Popen` Usage:** Using `shell=True` with user-controlled input is a known security risk. It bypasses the usual restrictions on arguments passed to `Popen` and can be leveraged for command injection.
*   **Lack of Input Sanitization:** The application does not sanitize the user-supplied `output_dir` before passing it to the `Popen` function, allowing for injection of malicious commands.

**Impact of Exploitation:**

*   **Arbitrary OS Command Execution:** An attacker can execute arbitrary commands on the server hosting Llama Factory.
*   **Sensitive Data Compromise:** Attackers can gain access to sensitive data stored on the server.
*   **Privilege Escalation:** The ability to execute arbitrary code can potentially lead to privilege escalation, allowing the attacker to gain full control over the system.
*   **Malware Deployment:** The attacker could deploy malware, including backdoors, on the affected system.
*   **Operational Disruption:** Attackers could cause system malfunctions or disruptions.

**Attack Vectors:**

*   **Network-Based:** The vulnerability is exploitable remotely over the network by sending a crafted HTTP request to the vulnerable endpoint of the Llama Factory web application.

**Required Attacker Capabilities/Position:**

*   **Network Access:** The attacker must have network access to the Llama Factory instance.
*   **HTTP Request Knowledge:** The attacker needs to be able to send HTTP POST requests to the `/queue/join` endpoint with a crafted payload.
*   **No Authentication Required**: The vulnerability does not require any prior authentication, making it easier to exploit.

**Additional Details:**

*   **Proof of Concept:** A Python script is provided that demonstrates how to exploit this vulnerability by injecting a command via the `output_dir` parameter.
*   **Affected Versions:** Llama Factory versions 0.9.0 and earlier are vulnerable.
*   **Patch Information:** The vulnerability is patched in version 0.9.1 by avoiding the usage of `shell=True` in `Popen` and passing the command and arguments as a list instead.
*   **CVSS Score:** The vulnerability has a CVSS score of 8.6, indicating a high severity.
*   **CWE:** The vulnerability is categorized as CWE-78: Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection').

**Summary:**

This vulnerability is a critical remote OS command injection flaw in Llama Factory, exploitable by sending crafted HTTP requests. The lack of input sanitization and use of `shell=True` in the `Popen` function are the root causes. Exploitation leads to arbitrary OS command execution, data breaches, and potential system compromise. The vulnerability is patched in version 0.9.1, which should be applied to mitigate this issue.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | alternate_terms | 1.000 |
| 2 | 77 | Improper Neutralization of Special Elements used in a Command ('Command Injection') | Class | Allowed-with-Review | alternate_terms | 0.800 |
| 3 | 138 | Improper Neutralization of Special Elements | Class | Discouraged | sparse | 0.415 |
| 4 | 88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | sparse | 0.407 |
| 5 | 20 | Improper Input Validation | Class | Discouraged | sparse | 0.404 |
| 6 | 22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | sparse | 0.397 |
| 7 | 184 | Incomplete List of Disallowed Inputs | Base | Allowed | sparse | 0.388 |
| 8 | 94 | Improper Control of Generation of Code ('Code Injection') | Base | Allowed-with-Review | sparse | 0.382 |
| 9 | 1427 | Improper Neutralization of Input Used for LLM Prompting | Base | Allowed | dense | 0.609 |
| 10 | 41 | Improper Resolution of Path Equivalence | Base | Allowed | graph | 0.002 |

