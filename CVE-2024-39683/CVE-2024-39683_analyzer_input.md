# Vulnerability Information: CVE-2024-39683

## Vulnerability Description
ZITADEL is an open-source identity infrastructure tool. ZITADEL provides users the ability to list all user sessions of the current user agent (browser). Starting in version 2.53.0 and prior to versions 2.53.8, 2.54.5, and 2.55.1, due to a **missing check**, user sessions without that information (e.g. when created though the session service) were incorrectly listed exposing potentially other users sessions. Versions 2.55.1, 2.54.5, and 2.53.8 contain a fix for the issue. There is no workaround since a patch is already available.

### Vulnerability Description Key Phrases
- **rootcause:** **missing check**
- **impact:** expose other users sessions
- **product:** ZITADEL
- **version:** 2.53.0 to 2.53.8, 2.54.5, and 2.55.1

## CVE Reference Links Content Summary
Based on the provided information, here's a breakdown of the vulnerability described in CVE-2024-39683:

**Root Cause of Vulnerability:**

- The vulnerability stems from an incorrect implementation in how user sessions were being listed, specifically when retrieving user sessions through the `ListMyUserSessions` API.
- When the system switched to V2 tokens, the user agent was not correctly set for sessions created through the login UI.
- Additionally, the `ListMyUserSessions` endpoint was not correctly filtering sessions, and would list any session, even those without a fingerprint ID (e.g., sessions created through the session API).

**Weaknesses/Vulnerabilities Present:**

- **Information Leakage:** The primary vulnerability was the exposure of user session data beyond the intended scope, potentially revealing other user's sessions when calling the `ListMyUserSessions` API. This allowed an authenticated user to see sessions that did not belong to their current user agent.
- **Incorrect User Agent Handling:** The user agent information was not correctly set when creating sessions through the login UI after switching to V2 tokens.

**Impact of Exploitation:**

- **Confidentiality Breach:** An authenticated user could potentially view session information of other users if those sessions were created without a user agent ID or through the session API and were active within the same instance.
- This could expose potentially sensitive data about other user sessions.
- It is important to note that this vulnerability did not allow for session takeover.

**Attack Vectors:**

- **Network:** The vulnerability can be exploited remotely over the network by making API calls.

**Required Attacker Capabilities/Position:**

- **Authentication:** An attacker needs to be an authenticated user in the Zitadel instance.
- **API Access:** An attacker needs the ability to call the `ListMyUserSessions` API endpoint.
- **User interaction:** Required by the user to log in to exploit the vulnerability

**Additional details:**

- The vulnerability was triggered after a switch to V2 tokens.
- The issue was present in versions 2.55.0, 2.54.0-2.54.4, and 2.53.0-2.53.7 of Zitadel.
- Patched versions include 2.55.1, 2.54.5, and 2.53.8.

The fix involved:
- Ensuring the correct user agent ID (fingerprint) is used when creating sessions, particularly via the login UI.
- Ignoring user sessions with empty user agent IDs when listing sessions, thus filtering out sessions that don't belong to the current user agent.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.485 |
| 2 | 1390 | Weak Authentication | Class | Allowed-with-Review | sparse | 0.480 |
| 3 | 912 | Hidden Functionality | Class | Allowed-with-Review | sparse | 0.453 |
| 4 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 0.450 |
| 5 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 0.449 |
| 6 | 20 | Improper Input Validation | Class | Discouraged | sparse | 0.446 |
| 7 | 287 | Improper Authentication | Class | Discouraged | sparse | 0.445 |
| 8 | 1286 | Improper Validation of Syntactic Correctness of Input | Base | Allowed | sparse | 0.438 |
| 9 | 384 | Session Fixation | Compound | Allowed | dense | 0.436 |
| 10 | 613 | Insufficient Session Expiration | Base | Allowed | graph | 0.002 |

