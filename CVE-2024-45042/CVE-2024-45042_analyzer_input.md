# Vulnerability Information: CVE-2024-45042

## Vulnerability Description
Ory Kratos is an identity, user management and authentication system for cloud services. Prior to version 1.3.0, given a number of preconditions, the `highest_available` setting will incorrectly assume that the identitys highest available AAL is `aal1` even though it really is `aal2`. This means that the `highest_available` configuration will act as if the user has only one factor set up, for that particular user. This means that they can call the settings and whoami endpoint without a `aal2` session, even though that should be disallowed. An attacker would need to steal or guess a valid login OTP of a user who has only OTP for login enabled and who has an incorrect `available_aal` value stored, to exploit this vulnerability. All other aspects of the session (e.g. the sessions aal) are not impacted by this issue. On the Ory Network, only 0.00066% of registered users were affected by this issue, and most of those users appeared to be test users. Their respective AAL values have since been updated and they are no longer vulnerable to this attack. Version 1.3.0 is not affected by this issue. As a workaround, those who require MFA should disable the passwordless code login method. If that is not possible, check the sessions `aal` to identify if the user has `aal1` or `aal2`.

### Vulnerability Description Key Phrases
- **weakness:** **improper access control**
- **impact:** access Ory Kratos endpoints without MFA
- **attacker:** attacker
- **product:** Ory Kratos
- **version:** prior to 1.3.0
- **component:** highest_available setting and whoami endpoint

## CVE Reference Links Content Summary
```
{
  "Root cause of vulnerability": "The `highest_available` setting incorrectly assumes the identity's highest available AAL is `aal1` when it should be `aal2` due to an incorrect `available_aal` value stored in the database. This occurs when a user only uses the `code` login method (with passwordless enabled) along with a 2FA method and has not completed the 2FA challenge, leading to incorrect session authentication levels.",
  "Weaknesses/vulnerabilities present": "Incorrect evaluation of the highest available Authentication Assurance Level (AAL). Specifically, the system fails to properly recognize that a user with passwordless 'code' login and 2FA enabled should have `aal2` when `highest_available` is set.",
  "Impact of exploitation": "An attacker could bypass the `aal2` requirement and access settings and whoami endpoints that should be protected by 2FA by stealing or guessing a valid login OTP. This would allow access to sensitive information or actions that should require a higher level of authentication.",
  "Attack vectors": "Network-based. An attacker needs to steal or guess a valid login OTP of a user with only OTP for login enabled.",
  "Required attacker capabilities/position": "The attacker must be able to obtain a valid login OTP (one-time password) for a user who has only the 'code' method for login and has 2FA enabled and an incorrectly stored available_aal in the database."
}
```

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 1.120 |
| 2 | 1390 | Weak Authentication | Class | Allowed-with-Review | sparse | 1.100 |
| 3 | 287 | Improper Authentication | Class | Discouraged | sparse | 1.078 |
| 4 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 1.074 |
| 5 | 923 | Improper Restriction of Communication Channel to Intended Endpoints | Class | Allowed-with-Review | sparse | 1.060 |
| 6 | 306 | Missing Authentication for Critical Function | Base | Allowed | sparse | 1.058 |
| 7 | 347 | Improper Verification of Cryptographic Signature | Base | Allowed | sparse | 1.040 |
| 8 | 285 | Improper Authorization | Class | Discouraged | sparse | 1.014 |
| 9 | 307 | Improper Restriction of Excessive Authentication Attempts | Base | Allowed | dense | 0.527 |
| 10 | 322 | Key Exchange without Entity Authentication | Base | Allowed | graph | 0.003 |


---

## CWE Classification Guidance

The following guidance has been automatically included because relevant keywords were detected in the vulnerability description:

### Authentication vs Authorization vs Access Control Guidance

## ===Guidance===

### Level Set – Authentication vs Authorization vs Access Control

**Authentication**:
Determines *who* the actor is (identity validation). This is typically the *first step* in access control.

* Example phrases: "user must log in", "lack of login check", "bypasses login"
* CWE relevance: authentication is usually mapped to CWE-306 or its children.

  * **CWE-306**: *Missing Authentication for Critical Function* – used when no identity validation is enforced for sensitive functionality (e.g., password reset, user deletion).

**Authorization**:
Determines *what* an authenticated actor is allowed to do. It decides access *after* identity is verified.

* Example phrases: "unauthorized access", "regular user can access admin panel", "role checks are missing"
* CWE relevance: use CWEs like 862, 863, 285 for authorization errors:

  * **CWE-862**: *Missing Authorization* – the application doesn't check whether the user is authorized at all.
  * **CWE-863**: *Incorrect Authorization* – the application checks authorization, but does it incorrectly (e.g., flawed logic).
  * **CWE-285**: *Improper Authorization* – general category for any flawed authorization logic or design.

**Access Control**:
A broader term that includes both authentication and authorization. Governs how resources are protected and who can access them under what conditions.

* CWE relevance:

  * **CWE-284**: *Improper Access Control* – top-level category used when access control failure exists but root cause is unclear.
  * This should be avoided **if** a more specific child CWE like 285, 862, 863, or 306 is appropriate.

---

## Mapping Discussion – Common Misclassification Patterns

### 1. **CWE-306 vs CWE-862**:

* **306** is about lack of **authentication** (e.g., *no login required at all*).
* **862** is about lack of **authorization** *after* authentication (e.g., *admin check missing*).
* ✅ Example CWE-306: *“An unauthenticated attacker can invoke the password reset API.”*
* ✅ Example CWE-862: *“An authenticated user without admin privileges can delete any user account.”*

### 2. **CWE-285 vs CWE-284**:

* **285** is specific to authorization flaws – it's a better choice than 284 **if** the issue involves *improper or missing role checks*.
* **284** should be reserved for general access control issues when it’s unclear whether the issue lies in authn or authz.

---

## Technical Impact vs Root Cause Clarification

**Phrase like "unauthorized access" is not enough.**

* If you **cannot determine whether identity was checked**, assume it’s **authorization** and consider 862 or 863.
* If you **know no login happened**, lean toward **authentication** → CWE-306.
* If the **access control policy is unclear or inconsistently enforced**, but it's not due to missing checks, consider **CWE-284**.

---

## Good Mapping Examples

* ✅ **CWE-306**: “The endpoint `/admin/deleteUser` does not require any authentication.”
* ✅ **CWE-862**: “Any logged-in user can change any other user's email without being an admin.”
* ✅ **CWE-863**: “An admin check exists but incorrectly grants access to non-admin users.”
* ✅ **CWE-285**: “Application uses a static role check that fails when roles change dynamically.”
* ✅ **CWE-284**: “Inconsistent enforcement of access rules across services with unclear policy source.”

---

## Summary – Quick LLM Rules of Thumb

| **Indicator**                                              | **Likely CWE** |
| ---------------------------------------------------------- | -------------- |
| No identity check (no login)                               | CWE-306        |
| No role/privilege check after login                        | CWE-862        |
| Role check is present but flawed                           | CWE-863        |
| General or ambiguous authorization failure                 | CWE-285        |
| High-level access control problem with no clear root cause | CWE-284        |


