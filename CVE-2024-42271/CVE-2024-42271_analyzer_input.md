# Vulnerability Information: CVE-2024-42271

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved net/iucv fix **use after free** in iucv_sock_close() iucv_sever_path() is called from process context and from bh context. iucv->path is used as indicator whether somebody else is taking care of severing the path (or it is already removed / never existed). This needs to be done with atomic compare and swap, otherwise there is a small window where iucv_sock_close() will try to work with a path that has already been severed and freed by iucv_callback_connrej() called by iucv_tasklet_fn(). Example [452744.123844] Call Trace [452744.123845] ([] 0x1e87f03880) [452744.123966] [] iucv_path_sever+0x96/0x138 [452744.124330] [] iucv_sever_path+0xc2/0xd0 [af_iucv] [452744.124336] [] iucv_sock_close+0xa6/0x310 [af_iucv] [452744.124341] [] iucv_sock_release+0x3c/0xd0 [af_iucv] [452744.124345] [] __sock_release+0x5e/0xe8 [452744.124815] [] sock_close+0x34/0x48 [452744.124820] [] __fput+0xba/0x268 [452744.124826] [] task_work_run+0xbc/0xf0 [452744.124832] [] do_notify_resume+0x88/0x90 [452744.124841] [] system_call+0xe2/0x2c8 [452744.125319] Last Breaking-Event-Address [452744.125321] [] iucv_path_sever+0x90/0x138 [452744.125324] [452744.125325] Kernel panic - not syncing Fatal exception in interr

### Vulnerability Description Key Phrases
- **rootcause:** **use after free**
- **impact:** Kernel panic
- **product:** Linux kernel

## CVE Reference Links Content Summary
```
{
  "vulnerability": {
    "root_cause": "A race condition exists in the iucv_sever_path function when called from both process and bottom half (bh) contexts. The iucv->path field is used as an indicator of whether the path is being severed. Without proper synchronization, iucv_sock_close() can attempt to use the path after it has been freed by iucv_callback_connrej() due to the tasklet context.",
    "weaknesses": [
      "Use-after-free",
      "Race condition",
      "Inadequate synchronization"
     ],
    "impact": "The vulnerability leads to a use-after-free condition, potentially resulting in a kernel panic or other undefined behavior.  The provided call trace shows a kernel panic as a result of the race condition.",
    "attack_vectors": "The vulnerability can be triggered by closing an IUCV socket while a connection rejection callback is being handled by the tasklet. This can be caused by a process closing the socket and the tasklet freeing the path nearly simultaneously.",
    "required_capabilities": "An attacker needs the ability to trigger the socket closing and a connection rejection event to occur in close proximity, exploiting the small timing window.",
   "details": "The code uses `iucv->path` as an indicator for whether another process is severing the path or not. The fix involves replacing `iucv->path = NULL` with `xchg(&iucv->path, NULL)`, which performs an atomic compare-and-swap operation to guarantee that only one context frees the path and avoids the race condition."
  }
}
```

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.513 |
| 2 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.511 |
| 3 | 364 | Signal Handler Race Condition | Base | Allowed | sparse | 0.502 |
| 4 | 415 | Double Free | Variant | Allowed | sparse | 0.481 |
| 5 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.470 |
| 6 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.457 |
| 7 | 59 | Improper Link Resolution Before File Access ('Link Following') | Base | Allowed | sparse | 0.450 |
| 8 | 639 | Authorization Bypass Through User-Controlled Key | Base | Allowed | sparse | 0.448 |
| 9 | 775 | Missing Release of File Descriptor or Handle after Effective Lifetime | Variant | Allowed | dense | 0.532 |
| 10 | 123 | Write-what-where Condition | Base | Allowed | graph | 0.003 |

