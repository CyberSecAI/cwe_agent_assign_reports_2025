## Vulnerability Description
Versions of the package spatie/browsershot before 5.0.3 are vulnerable to **Improper Input Validation** due to improper URL validation through the setUrl method. An attacker can exploit this vulnerability by utilizing view-sourcefile//, which allows for arbitrary file reading on a local file. **Note** This is a bypass of the fix for [CVE-2024-21544](https//security.snyk.io/vuln/SNYK-PHP-SPATIEBROWSERSHOT-8496745).

### Vulnerability Description Key Phrases
- **rootcause:** **Improper Input Validation**
- **impact:** arbitrary file reading
- **vector:** view-sourcefile//
- **attacker:** attacker
- **product:** spatie/browsershot
- **version:** before 5.0.3
- **component:** setUrl method

## CVE Reference Links Content Summary
Based on the provided information, here's an analysis of CVE-2024-21549:

**Root Cause of Vulnerability:**

The vulnerability stems from insufficient input validation within the `setUrl` method of the `spatie/browsershot` library. Specifically, the library attempts to block file access by checking for the presence of protocols like `file://`, `file:/`, `file:\\`, and `file:\\\`. However, it fails to account for the `view-source:` protocol which, combined with the `file://` scheme, can be used to bypass the checks and read arbitrary local files.

**Weaknesses/Vulnerabilities Present:**

*   **Improper Input Validation:** The core weakness is the incomplete sanitization of the URL provided to the `setUrl` method. While some file protocols were blocked, `view-source:` was overlooked. This allows attackers to bypass the intended restrictions.

**Impact of Exploitation:**

*   **Arbitrary File Read:** Successful exploitation allows an attacker to read any file on the local system accessible to the process running the vulnerable code. This could lead to the disclosure of sensitive information such as configuration files, credentials, or source code.

**Attack Vectors:**

*   **Network:** The vulnerability can be triggered through network requests that influence the URL passed to the vulnerable function.

**Required Attacker Capabilities/Position:**

*   The attacker needs to control the URL passed to the `Browsershot::url()` method. This could occur in a web application or any other context where user-supplied or attacker-controlled input is used to generate screenshots or PDFs with the library.
*   No special privileges are required. The vulnerability is exploitable without requiring any user interaction.

**Technical Details:**

The vulnerable code snippet is present in the `setUrl` function of `src/Browsershot.php`.

```php
public function setUrl(string $url): static
{
    $url = trim($url);

    $unsupportedProtocols = ['file://', 'file:/', 'file:\\', 'file:\\\\'];

    foreach ($unsupportedProtocols as $unsupportedProtocol) {
        if (str_starts_with(strtolower($url), $unsupportedProtocol)) {
            throw FileUrlNotAllowed::make();
        }
    }

    $this->url = $url;
    $this->html = '';

    return $this;
}
```

The vulnerability is triggered by providing a URL such as `view-source:file:///etc/passwd` which bypasses the checks.

**Patch:**

The fix was implemented in commit `f791ce0ae8dd99367dbfa30588ee31e1196e1728` which added `view-source` to the list of unsupported protocols. The fixed code looks like this:

```php
    $unsupportedProtocols = [
        'file://',
        'file:/',
        'file:\\',
        'file:\\\\',
        'view-source',
    ];
```
And a new test case was added to check this fix.

**Additional Notes:**

*   This vulnerability is a bypass for a previous fix for CVE-2024-21544, demonstrating that initial fix was insufficient.
*   The Snyk vulnerability report assigned a severity score of 8.7 (High) using CVSS v3.1.
*   The fix was included in `spatie/browsershot` version 5.0.3.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | sparse | 0.395 |
| 2 | 78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | sparse | 0.374 |
| 3 | 20 | Improper Input Validation | Class | Discouraged | sparse | 0.363 |
| 4 | 22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | sparse | 0.362 |
| 5 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 0.356 |
| 6 | 1321 | Improperly Controlled Modification of Object Prototype Attributes ('Prototype Pollution') | Variant | Allowed | sparse | 0.353 |
| 7 | 138 | Improper Neutralization of Special Elements | Class | Discouraged | sparse | 0.353 |
| 8 | 1333 | Inefficient Regular Expression Complexity | Base | Allowed | sparse | 0.343 |
| 9 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | dense | 0.581 |
| 10 | 73 | External Control of File Name or Path | Base | Allowed | graph | 0.003 |



# Complete CWE Specifications

CWE-88: Improper Neutralization of Argument Delimiters in a Command ('Argument Injection')

CWE-78: Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')

CWE-20: Improper Input Validation

CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')

CWE-1284: Improper Validation of Specified Quantity in Input

CWE-1321: Improperly Controlled Modification of Object Prototype Attributes ('Prototype Pollution')

CWE-138: Improper Neutralization of Special Elements

CWE-1333: Inefficient Regular Expression Complexity

CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')

CWE-73: External Control of File Name or Path