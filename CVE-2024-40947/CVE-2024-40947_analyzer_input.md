# Vulnerability Information: CVE-2024-40947

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved ima Avoid blocking in RCU read-side critical section A panic happens in ima_match_policy BUG unable to handle kernel **NULL pointer dereference** at 0000000000000010 PGD 42f873067 P4D 0 Oops 0000 [#1] SMP NOPTI CPU 5 PID 1286325 Comm kubeletmonit.sh Kdump loaded Tainted P Hardware name QEMU Standard PC (i440FX + PIIX, 1996), BIOS 0.0.0 02/06/2015 RIP 0010ima_match_policy+0x84/0x450 Code 49 89 fc 41 89 cf 31 ed 89 44 24 14 eb 1c 44 39 7b 18 74 26 41 83 ff 05 74 20 48 8b 1b 48 3b 1d f2 b9 f4 00 0f 84 9c 01 00 00 85 73 10 74 ea 44 8b 6b 14 41 f6 c5 01 75 d4 41 f6 c5 02 74 0f RSP 0018ff71570009e07a80 EFLAGS 00010207 RAX 0000000000000000 RBX 0000000000000000 RCX 0000000000000200 RDX ffffffffad8dc7c0 RSI 0000000024924925 RDI ff3e27850dea2000 RBP 0000000000000000 R08 0000000000000000 R09 ffffffffabfce739 R10 ff3e27810cc42400 R11 0000000000000000 R12 ff3e2781825ef970 R13 00000000ff3e2785 R14 000000000000000c R15 0000000000000001 FS 00007f5195b51740(0000) GSff3e278b12d40000(0000) knlGS0000000000000000 CS 0010 DS 0000 ES 0000 CR0 0000000080050033 CR2 0000000000000010 CR3 0000000626d24002 CR4 0000000000361ee0 DR0 0000000000000000 DR1 0000000000000000 DR2 0000000000000000 DR3 0000000000000000 DR6 00000000fffe0ff0 DR7 0000000000000400 Call Trace ima_get_action+0x22/0x30 process_measurement+0xb0/0x830 ? page_add_file_rmap+0x15/0x170

### Vulnerability Description Key Phrases
- **rootcause:** **NULL pointer dereference**
- **impact:** Oops and panic
- **vector:** kernel BUG
- **product:** Linux kernel
- **component:** ima

## CVE Reference Links Content Summary
```
{
  "cveId": "CVE-2024-40947",
  "related": true,
  "content": "Root cause:\nA use-after-free (UAF) vulnerability exists in the Linux kernel's Integrity Measurement Architecture (IMA) module. Specifically, the `ima_lsm_copy_rule` function was called within an RCU read-side critical section, and it used `kmalloc` with `GFP_KERNEL`. This can lead to the function potentially sleeping, violating the limitations of RCU read-side critical sections on non-PREEMPT systems.\n\nWeaknesses/vulnerabilities:\nThe vulnerability stems from the usage of `kmalloc(GFP_KERNEL)` within an RCU read-side critical section. This can result in the function sleeping, which is not allowed within RCU read-side critical sections, especially on non-PREEMPT kernels.\n\nImpact of exploitation:\nIf a thread sleeping occurs inside a RCU read-side critical section, `synchronize_rcu()` might return early. This can break RCU protection, leading to a UAF condition. A thread could then free memory while another thread is still accessing it, which can lead to a crash.\n\nAttack vectors:\nAn attacker can trigger the vulnerability by calling `ima_lsm_update_rule`. This function, in some situations, can call `ima_lsm_copy_rule` which contains kmalloc with GFP_KERNEL within a RCU read-side critical section.\n\nRequired attacker capabilities/position:\nThe attacker needs to be able to trigger the execution of code that leads to the vulnerable kmalloc call within RCU read-side critical section. This likely requires a user-space process interacting with the kernel in a specific manner related to IMA rules and measurements.\n\nAdditional Details:\nThe fix replaces kmalloc with `GFP_KERNEL` with kmalloc with `GFP_ATOMIC` within RCU read-side critical sections in IMA policy. This prevents the function from sleeping within the critical section and avoids UAF scenarios. The vulnerability was introduced in commit c7423dbdbc9e.\n"
}
```

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 912 | Hidden Functionality | Class | Allowed-with-Review | sparse | 0.378 |
| 2 | 822 | Untrusted Pointer Dereference | Base | Allowed | sparse | 0.342 |
| 3 | 787 | Out-of-bounds Write | Base | Allowed | sparse | 0.319 |
| 4 | 400 | Uncontrolled Resource Consumption | Class | Discouraged | sparse | 0.316 |
| 5 | 121 | Stack-based Buffer Overflow | Variant | Allowed | sparse | 0.313 |
| 6 | 476 | NULL Pointer Dereference | Base | Allowed | sparse | 0.309 |
| 7 | 288 | Authentication Bypass Using an Alternate Path or Channel | Base | Allowed | sparse | 0.308 |
| 8 | 22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | sparse | 0.305 |
| 9 | 909 | Missing Initialization of Resource | Class | Allowed-with-Review | dense | 0.586 |
| 10 | 781 | Improper Address Validation in IOCTL with METHOD_NEITHER I/O Control Code | Variant | Allowed | graph | 0.003 |

