# Vulnerability Information: CVE-2024-39914

## Vulnerability Description
FOG is a cloning/imaging/rescue suite/inventory management system. Prior to 1.5.10.34, packages/web/lib/fog/reportmaker.class.php in FOG was affected by a **command injection** via the filename parameter to /fog/management/export.php. This vulnerability is fixed in 1.5.10.34.

### Vulnerability Description Key Phrases
- **weakness:** **command injection**
- **product:** FOG
- **version:** Prior to 1.5.10.34
- **component:** packages/web/lib/fog/reportmaker.class.php

## CVE Reference Links Content Summary
Based on the provided information, here's an analysis of CVE-2024-39914:

**Root cause of vulnerability:**
The vulnerability lies in the `reportmaker.class.php` file where the filename parameter, intended for the exported report, is not properly sanitized before being used in a shell command. Specifically when the `nojson` parameter is set to `2`, the `$filename` variable, which is directly taken from user input, is embedded into a `htmldoc` command executed via `passthru()`.

**Weaknesses/vulnerabilities present:**
- **Command Injection (CWE-77):** The primary vulnerability is a command injection. By manipulating the filename parameter, an attacker can inject arbitrary shell commands that will be executed on the server. The injected filename is used within a command that uses `passthru()` function, which executes the command directly on the underlying system.
- **Insufficient Input Validation:** The `filename` parameter is not validated or sanitized, allowing for arbitrary user-controlled input to be passed to the shell.

**Impact of exploitation:**
- **Remote Code Execution (RCE):** Successful exploitation allows an attacker to execute arbitrary shell commands on the server with the privileges of the web server user (typically `www-data`).
- **Full System Compromise:** RCE can lead to a full system compromise, allowing attackers to access sensitive data, modify files, and potentially pivot to other systems in the network.
- **Webshell creation:** The attacker can create a webshell by injecting PHP code into a file.

**Attack vectors:**
- **HTTP Request:** The vulnerability can be exploited by sending a malicious HTTP POST request to `/fog/management/export.php`.
- **`filename` parameter:** The filename parameter in the GET request is used to inject shell commands by utilizing subshell execution like `$(command)`.
- **`nojson` parameter:** The `nojson` parameter must be set to `2` to trigger the vulnerable code path.

**Required attacker capabilities/position:**
- **Network Access:** The attacker must have network access to the FOG Project server.
- **No Authentication Required:** The vulnerability is unauthenticated, meaning an attacker does not need valid credentials to exploit it.
- **Basic HTTP knowledge:** Knowledge of HTTP requests is necessary to craft the malicious request to exploit the vulnerability.
- **Understanding of bash:** Knowledge on how to use subshells in bash is necessary to form the malicious payload.

**Additional Information:**
- The provided content includes Proof-of-Concept (PoC) code in shell script and python, demonstrating how to create a webshell using this vulnerability.
- The vulnerability was fixed in version 1.5.10.34 of FOG Project by escaping the filename parameter using `escapeshellarg()`.
- CVSS Score: 9.8 (Critical)

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 77 | Improper Neutralization of Special Elements used in a Command ('Command Injection') | Class | Allowed-with-Review | alternate_terms | 1.000 |
| 2 | 78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | alternate_terms | 0.700 |
| 3 | 1336 | Improper Neutralization of Special Elements Used in a Template Engine | Base | Allowed | sparse | 0.247 |
| 4 | 1236 | Improper Neutralization of Formula Elements in a CSV File | Base | Allowed | sparse | 0.246 |
| 5 | 89 | Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection') | Base | Allowed | sparse | 0.242 |
| 6 | 95 | Improper Neutralization of Directives in Dynamically Evaluated Code ('Eval Injection') | Variant | Allowed | sparse | 0.239 |
| 7 | 434 | Unrestricted Upload of File with Dangerous Type | Base | Allowed | sparse | 0.239 |
| 8 | 138 | Improper Neutralization of Special Elements | Class | Discouraged | sparse | 0.237 |
| 9 | 88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | dense | 0.455 |
| 10 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | graph | 0.002 |

