# Vulnerability Information: CVE-2024-11662

## Vulnerability Description
A vulnerability was found in welliamcao OpsManage 3.0.1/3.0.2/3.0.3/3.0.4/3.0.5. It has been rated as critical. This issue affects the function deploy_host_vars of the file /apps/api/views/deploy_api.py of the component API Endpoint. The manipulation leads to **deserialization**. The attack may be initiated remotely. The exploit has been disclosed to the public and may be used. The vendor was contacted early about this disclosure but did not respond in any way.

### Vulnerability Description Key Phrases
- **weakness:** **deserialization**
- **product:** welliamcao OpsManage
- **version:** 3.0.1/3.0.2/3.0.3/3.0.4/3.0.5
- **component:** API Endpoint

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**

*   The vulnerability stems from the use of the `eval()` function in the `deploy_host_vars()` function within the `deploy_api.py` file of the OpsManage application. This function directly executes arbitrary Python code provided in the `host_vars` parameter of a POST request.

**Weaknesses/Vulnerabilities Present:**

*   **Remote Code Execution (RCE):** The primary vulnerability is the ability to execute arbitrary Python code remotely by sending a crafted POST request to the `/api/host/vars/{id}/` endpoint.
*   **Lack of Input Validation/Sanitization:** The `host_vars` parameter is not sanitized, allowing attackers to inject and execute malicious code.
*   **Bypassable ID Check**: Although there is a check to verify the existence of the 'id' parameter in the database, it's easily bypassed, leading to the code execution.

**Impact of Exploitation:**

*   **Complete System Compromise:** Successful exploitation allows an attacker to execute arbitrary code on the server hosting the OpsManage application. This can lead to complete compromise, data theft, denial of service, and other malicious activities.
*   **Privilege Escalation (Potentially):** The attacker may be able to escalate privileges further, depending on the context and permissions of the user the application is running as.

**Attack Vectors:**

*   **HTTP POST Request:** The vulnerability is triggered through a malicious HTTP POST request sent to the `/api/host/vars/{id}/` endpoint.
*   **`host_vars` Parameter:** The payload containing the malicious Python code is injected through the `host_vars` parameter in the POST request body.
*    **CSRF Bypass**: The application has CSRF protection enabled by default. However, it can be bypassed by setting the `X-CSRFTOKEN` header to a valid `csrftoken` value.

**Required Attacker Capabilities/Position:**

*   **Network Access:** The attacker must have network access to the OpsManage application's server.
*   **Authentication:** The attacker needs to be authenticated to access the API endpoint. Although, the report shows a bypass to get a valid `sessionid` and `csrftoken` using a low privileged account.
*    **Knowledge of the API:** The attacker needs knowledge of the vulnerable API endpoint (`/api/host/vars/{id}/`) and how to manipulate the `host_vars` parameter to inject malicious code.
*    **Valid `id`**: The attacker must find or enumerate a valid 'id' parameter value in the database.

**Additional Details:**

*   The vulnerability affects OpsManage versions v3.0.1 to v3.0.5.
*   The vulnerable code is located in `apps/api/views/deploy_api.py`.
*   The report includes an example payload to demonstrate the RCE using the ping command as a proof of concept.
*   The report also mentions a publicly available instance of the application to demonstrate the vulnerability.

**Fix Recommendations (from the report):**

1.  **Add Permissions:** Implement proper access control and permissions for the `deploy_host_vars` endpoint to restrict access to authorized users.
2.  **Filter `host_vars` Value:** Sanitize or filter the value of the `host_vars` parameter to prevent the execution of arbitrary code. Avoid using `eval()` with user-provided input. Use safer alternatives or consider alternative ways to parse the `host_vars` values.

The provided information offers significant details about the vulnerability, including the vulnerable code, exploitation process and recommendations, thus providing much more information than what would be available in a typical CVE description.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 89 | Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection') | Base | Allowed | sparse | 0.469 |
| 2 | 79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | sparse | 0.468 |
| 3 | 502 | Deserialization of Untrusted Data | Base | Allowed | sparse | 0.418 |
| 4 | 306 | Missing Authentication for Critical Function | Base | Allowed | sparse | 0.412 |
| 5 | 117 | Improper Output Neutralization for Logs | Base | Allowed | sparse | 0.406 |
| 6 | 1336 | Improper Neutralization of Special Elements Used in a Template Engine | Base | Allowed | sparse | 0.404 |
| 7 | 285 | Improper Authorization | Class | Discouraged | sparse | 0.392 |
| 8 | 99 | Improper Control of Resource Identifiers ('Resource Injection') | Class | Allowed-with-Review | sparse | 0.390 |
| 9 | 78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | dense | 0.598 |
| 10 | 93 | Improper Neutralization of CRLF Sequences ('CRLF Injection') | Base | Allowed | graph | 0.002 |

