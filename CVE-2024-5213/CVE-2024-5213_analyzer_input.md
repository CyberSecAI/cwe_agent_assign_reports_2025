# Vulnerability Information: CVE-2024-5213

## Vulnerability Description
In mintplex-labs/anything-llm versions up to and including 1.5.3, an issue was discovered where the password hash of a user is returned in the response after login (`POST /api/request-token`) and after account creations (`POST /api/admin/users/new`). This exposure occurs because the entire User object, including the bcrypt password hash, is included in the response sent to the frontend. This practice could potentially lead to **sensitive information exposure** despite the use of bcrypt, a strong hashing algorithm. It is recommended not to expose any clues about passwords to the frontend.

### Vulnerability Description Key Phrases
- **weakness:** **sensitive information exposure**
- **vector:** POST /api/request-token and POST /api/admin/users/new
- **product:** mintplex-labs/anything-llm
- **version:** up to and including 1.5.3

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the changes made in the commit `9df4521113ddb9a3adb5d0e3941e7d494992629c` which is relevant to CVE-2024-5213:

**Root Cause of Vulnerability:**

The vulnerability stems from the exposure of sensitive user data, specifically password hashes, when retrieving user information. The original code in `server/endpoints/admin.js` and `server/endpoints/api/admin/index.js` was directly returning the entire user object, including the `password` field.

**Weaknesses/Vulnerabilities Present:**

- **Information Disclosure:** The primary vulnerability is the exposure of password hashes to unauthorized users. Even if the hashes are securely stored, disclosing them increases the risk of offline attacks like brute-forcing or rainbow table lookups, which could lead to account compromise.
- **Lack of Proper Data Sanitization:** The code was not filtering out sensitive information when returning user data.

**Impact of Exploitation:**

- An attacker who gains access to the exposed user data, particularly the password hashes, could potentially compromise user accounts through offline attacks.
- This can lead to unauthorized access to the application, data breaches, and other malicious activities.

**Attack Vectors:**

- An attacker could exploit this vulnerability by making requests to the admin endpoints that are intended to return user data.
- If the attacker has compromised admin or manager privileges this would be an easier attack vector, but a vulnerability in the authentication process or an exposed endpoint could lead to the same result.

**Required Attacker Capabilities/Position:**

- The attacker would need to have the ability to make API requests to the affected endpoints (`/admin/users` or `/api/admin/users`) that return user data.
- The attacker would need to have or find a way to bypass authorization to access the data.

**Mitigation:**

The commit `9df4521113ddb9a3adb5d0e3941e7d494992629c` addresses this vulnerability by implementing the following changes:

- **Filtering Sensitive Data:** Introduced a `filterFields` function in `server/models/user.js` that removes the `password` field from the user object before it's returned. This function is now called whenever user data is returned by the API.
- **Modified Endpoints:** Updated `server/endpoints/admin.js`, `server/endpoints/api/admin/index.js` and `server/endpoints/system.js` to use the new `filterFields` function to remove the password from the user data before it is returned in responses.

**Summary of Changes:**

- Modification of `admin.js`, `index.js` and `system.js` to properly filter the user object before returning it.
- Introduction of a `filterFields` function in `user.js` model.
- Modification of the `create` user function to use the `filterFields` function.
- Modification of the `get` and `where` user functions to use the `filterFields` function.

This commit effectively mitigates the risk of password hash exposure by ensuring the password field is never included in the returned user data.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 522 | Insufficiently Protected Credentials | Class | Allowed-with-Review | sparse | 0.507 |
| 2 | 201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | sparse | 0.497 |
| 3 | 916 | Use of Password Hash With Insufficient Computational Effort | Base | Allowed | sparse | 0.496 |
| 4 | 306 | Missing Authentication for Critical Function | Base | Allowed | sparse | 0.489 |
| 5 | 209 | Generation of Error Message Containing Sensitive Information | Base | Allowed | sparse | 0.488 |
| 6 | 639 | Authorization Bypass Through User-Controlled Key | Base | Allowed | sparse | 0.487 |
| 7 | 1390 | Weak Authentication | Class | Allowed-with-Review | sparse | 0.486 |
| 8 | 532 | Insertion of Sensitive Information into Log File | Base | Allowed | sparse | 0.486 |
| 9 | 836 | Use of Password Hash Instead of Password for Authentication | Base | Allowed | dense | 0.590 |
| 10 | 756 | Missing Custom Error Page | Base | Allowed | graph | 0.002 |

