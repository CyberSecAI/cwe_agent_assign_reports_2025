## Vulnerability Description
ESPTouch is a connection protocol for internet of things devices. In the ESPTouchV2 protocol, while there is an option to use a custom AES key, there is no option to set the IV (Initialization Vector) prior to versions 5.3.2, 5.2.4, 5.1.6, and 5.0.8. The IV is set to zero and remains constant throughout the products lifetime. In AES/CBC mode, if the IV is not properly initialized, the encrypted output becomes deterministic, leading to potential data leakage. To address the aforementioned issues, the application generates a random IV when activating the AES key starting in versions 5.3.2, 5.2.4, 5.1.6, and 5.0.8. This IV is then transmitted along with the provision data to the provision device. The provision device has also been equipped with a parser for the AES IV. The upgrade is applicable for all applications and users of ESPTouch v2 component from ESP-IDF. As it is implemented in the ESP Wi-Fi stack, there is no workaround for the user to fix the application layer without upgrading the underlying firmware.

### Vulnerability Description Key Phrases
- **rootcause:** **The IV (Initialization Vector) is set to zero and remains constant throughout the products lifetime**
- **impact:** encrypted output becomes deterministic, leading to potential data leakage
- **product:** ESPTouchV2 protocol
- **version:** prior to versions 5.3.2, 5.2.4, 5.1.6, and 5.0.8

## CVE Reference Links Content Summary
```
{
  "CVE-2024-53845": {
    "Description": "The ESPTouchV2 protocol, while allowing a custom AES key, lacks an option to set the Initialization Vector (IV). The IV is set to zero and remains constant, making the encrypted output deterministic in AES/CBC mode, leading to potential data leakage. This vulnerability affects multiple versions of ESP-IDF framework (v5.3.1, v5.2.3, v5.1.5, v5.0.7).",
    "Root cause": "The root cause is the use of a constant IV (set to zero) in the AES/CBC encryption of the ESPTouch v2 protocol. This was due to a missing option for IV configuration in the protocol implementation.",
    "Weaknesses": [
      "CWE-1204: Improper Initialization for Cryptographic Algorithm"
    ],
    "Impact": "The impact is potential data leakage due to the deterministic nature of the encryption. Since the IV is fixed, identical plaintexts will produce the same ciphertext, allowing an attacker to potentially identify patterns and deduce the data being transmitted. The risk applies to credentials for WiFi network and any custom data transmitted during the provisioning process.",
    "Attack vectors": "The attack vector involves intercepting and analyzing the wireless communication during the ESPTouch v2 provisioning process. An attacker within the range of the Wi-Fi communication can capture encrypted provisioning data and potentially decrypt it due to the weakness of the fixed IV in the AES encryption.",
      "Required attacker capabilities/position": "The attacker needs to be within the Wi-Fi communication range of the device undergoing provisioning. They need to be able to capture the wireless communication packets being transmitted using ESPTouch v2. No other special capabilities are required besides the ability to capture wireless packets."
  }
}
```

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 1204 | Generation of Weak Initialization Vector (IV) | Base | Allowed | sparse | 1.385 |
| 2 | 329 | Generation of Predictable IV with CBC Mode | Variant | Allowed | sparse | 1.175 |
| 3 | 321 | Use of Hard-coded Cryptographic Key | Variant | Allowed | sparse | 1.116 |
| 4 | 327 | Use of a Broken or Risky Cryptographic Algorithm | Class | Allowed-with-Review | sparse | 1.074 |
| 5 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 1.028 |
| 6 | 319 | Cleartext Transmission of Sensitive Information | Base | Allowed | sparse | 1.027 |
| 7 | 1390 | Weak Authentication | Class | Allowed-with-Review | sparse | 0.985 |
| 8 | 306 | Missing Authentication for Critical Function | Base | Allowed | sparse | 0.982 |
| 9 | 780 | Use of RSA Algorithm without OAEP | Variant | Allowed | dense | 0.446 |
| 10 | 208 | Observable Timing Discrepancy | Base | Allowed | graph | 0.002 |



# Complete CWE Specifications

CWE-1204: Generation of Weak Initialization Vector (IV)

CWE-329: Generation of Predictable IV with CBC Mode

CWE-321: Use of Hard-coded Cryptographic Key

CWE-327: Use of a Broken or Risky Cryptographic Algorithm

CWE-1284: Improper Validation of Specified Quantity in Input

CWE-319: Cleartext Transmission of Sensitive Information

CWE-1390: Weak Authentication

CWE-306: Missing Authentication for Critical Function

CWE-780: Use of RSA Algorithm without OAEP

CWE-208: Observable Timing Discrepancy