# Vulnerability Information: CVE-2024-42072

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved bpf Fix may_goto with negative offset. Zacs syzbot crafted a bpf prog that exposed two bugs in may_goto. The 1st bug is the way may_goto is patched. When offset is negative it should be patched differently. The 2nd bug is in the verifier when current state may_goto_depth is equal to visited state may_goto_depth it means there is an actual infinite loop. Its not correct to prune exploration of the program at this point. Note, that this check doesnt limit the program to only one may_goto insn, since 2nd and any further may_goto will increment may_goto_depth only in the queued state pushed for future exploration. The current state will have may_goto_depth == 0 regardless of number of may_goto insns and the verifier has to explore the program until bpf_exit.

### Vulnerability Description Key Phrases
- **rootcause:** **incorrect use of negative offset in may_goto**
- **vector:** bpf program with infinite loop
- **attacker:** syzbot
- **product:** Linux kernel
- **component:** bpf verifier

## CVE Reference Links Content Summary
Based on the provided information, the content relates to CVE-2024-42072.

**Root cause of vulnerability:**
The vulnerability arises from two bugs in the handling of the `may_goto` instruction within the BPF verifier in the Linux kernel.

1.  **Incorrect Patching of `may_goto` with Negative Offset:** The first bug lies in how `may_goto` instructions with negative offsets are patched. The kernel was not correctly adjusting the jump offset when a negative offset was used.
2.  **Incorrect Infinite Loop Detection in the Verifier:** The second bug is related to the verifier's handling of loops. The verifier incorrectly pruned exploration of the program when the current state's `may_goto_depth` equaled a visited state's `may_goto_depth`. This logic incorrectly assumed an infinite loop, potentially halting verification prematurely in some cases.

**Weaknesses/Vulnerabilities present:**
- Incorrect handling of negative offsets in `may_goto` instruction patching.
-  Flawed logic in the verifier that prematurely stops program exploration when a specific loop condition is met.

**Impact of exploitation:**
- An attacker can craft a BPF program that exploits the incorrect patching, potentially causing unexpected program behavior.
- The incorrect loop detection in the verifier may allow a specially crafted BPF program to bypass the verifier's checks, leading to further exploitation.

**Attack vectors:**
- A malicious actor can craft a BPF program containing `may_goto` instructions with negative offsets.
- This crafted program could also exploit the verifier's flawed infinite loop detection mechanism by manipulating the `may_goto_depth`.

**Required attacker capabilities/position:**
- The attacker needs the ability to load BPF programs into the kernel. This typically requires `CAP_SYS_ADMIN` capabilities.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 197 | Numeric Truncation Error | Base | Allowed | sparse | 0.711 |
| 2 | 823 | Use of Out-of-range Pointer Offset | Base | Allowed | sparse | 0.700 |
| 3 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 0.667 |
| 4 | 191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | sparse | 0.667 |
| 5 | 1390 | Weak Authentication | Class | Allowed-with-Review | sparse | 0.661 |
| 6 | 125 | Out-of-bounds Read | Base | Allowed | sparse | 0.656 |
| 7 | 1285 | Improper Validation of Specified Index, Position, or Offset in Input | Base | Allowed | sparse | 0.649 |
| 8 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.649 |
| 9 | 1342 | Information Exposure through Microarchitectural State after Transient Execution | Base | Allowed | dense | 0.514 |
| 10 | 129 | Improper Validation of Array Index | Variant | Allowed | graph | 0.003 |

