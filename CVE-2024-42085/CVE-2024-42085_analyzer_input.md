# Vulnerability Information: CVE-2024-42085

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved usb dwc3 core remove lock of otg mode during gadget suspend/resume to avoid **deadlock** When config CONFIG_USB_DWC3_DUAL_ROLE is selected, and trigger system to enter suspend status with below command echo mem > /sys/power/state There will be a **deadlock** issue occurring. Detailed invoking path as below dwc3_suspend_common() spin_lock_irqsave(&dwc->lock, flags) lock, flags) gadget_driver is NULL or not. It causes the following code is executed and **deadlock** occurs when trying to get the spinlock. In fact, the root cause is the commit 5265397f9442(usb dwc3 **Remove DWC3 locking during gadget suspend/resume**) that forgot to remove the lock of otg mode. So, remove the redundant lock of otg mode during gadget suspend/resume.

### Vulnerability Description Key Phrases
- **rootcause:** **Remove DWC3 locking during gadget suspend/resume**
- **weakness:** **deadlock**
- **vector:** echo mem > /sys/power/state
- **product:** Linux kernel
- **component:** usb dwc3 core

## CVE Reference Links Content Summary
The provided content describes a fix for a deadlock vulnerability in the Linux kernel's DWC3 USB driver.

**Root Cause:**
The root cause is a missing removal of a spinlock during gadget suspend/resume operations when the DWC3 controller operates in dual-role mode, specifically when acting as a USB device. The commit 5265397f9442 ("usb: dwc3: Remove DWC3 locking during gadget suspend/resume") removed some locks but forgot to remove the otg mode lock, causing a deadlock.

**Vulnerabilities/Weaknesses:**
- **Deadlock:** The code attempts to acquire the same spinlock (`dwc->lock`) twice within the `dwc3_suspend_common` function during suspend, resulting in a deadlock. This occurs because `dwc3_gadget_suspend` calls `dwc3_gadget_soft_disconnect` which attempts to acquire the same spinlock a second time.
- **Missing Lock Removal:**  The primary weakness is that commit 5265397f9442 did not completely remove all relevant locks during gadget suspend/resume, specifically the lock related to the otg mode, leaving a double lock situation in the gadget suspend path.

**Impact of Exploitation:**
- **System Hang/Deadlock:** The system becomes unresponsive when entering suspend mode because the kernel threads are blocked waiting on the same lock.
- **Denial of Service:** The deadlock prevents the system from suspending correctly and can cause a denial of service, as the device becomes unusable and might require a hard reset.

**Attack Vectors:**
- **System Suspend:** The vulnerability is triggered by putting the system into suspend state using `echo mem > /sys/power/state`.
- **Dual-Role Configuration:** The system must have the `CONFIG_USB_DWC3_DUAL_ROLE` option enabled for the vulnerability to be exposed.

**Required Attacker Capabilities/Position:**
- **User-level Access:** The attacker needs user-level access to the system to execute the command to trigger the system suspend.
- **System Configuration:** The system must be configured to enable dual role support for the DWC3 USB controller.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.665 |
| 2 | 833 | Deadlock | Base | Allowed | sparse | 0.650 |
| 3 | 476 | NULL Pointer Dereference | Base | Allowed | sparse | 0.531 |
| 4 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.522 |
| 5 | 88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | sparse | 0.519 |
| 6 | 191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | sparse | 0.517 |
| 7 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 0.511 |
| 8 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.497 |
| 9 | 1234 | Hardware Internal or Debug Modes Allow Override of Locks | Base | Allowed | dense | 0.482 |
| 10 | 609 | Double-Checked Locking | Base | Allowed | graph | 0.003 |

