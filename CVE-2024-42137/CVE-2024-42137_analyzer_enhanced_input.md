## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved Bluetooth qca Fix BT enable failure again for QCA6390 after warm reboot Commit 272970be3dab (Bluetooth hci_qca Fix driver shutdown on closed serdev) will cause below regression issue BT cant be enabled after below steps cold boot -> enable BT -> disable BT -> warm reboot -> BT enable failure if property enable-gpios is not configured within DT|ACPI for QCA6390. The commit is to fix a use-after-free issue within qca_serdev_shutdown() by adding condition to avoid the serdev is flushed or wrote after closed but also introduces this regression issue regarding above steps since the VSC is not sent to reset controller during warm reboot. Fixed by sending the VSC to reset controller within qca_serdev_shutdown() once BT was ever enabled, and the use-after-free issue is also fixed by this change since the serdev is still opened before it is flushed or wrote. Verified by the reported machine Dell XPS 13 9310 laptop over below two kernel commits commit e00fc2700a3f (Bluetooth btusb Fix triggering coredump implementation for QCA) of bluetooth-next tree. commit b23d98d46d28 (Bluetooth btusb Fix triggering coredump implementation for QCA) of linus mainline tree.

### Vulnerability Description Key Phrases
- **rootcause:** **missing VSC reset during warm reboot**
- **impact:** BT enable failure
- **product:** Linux kernel
- **component:** Bluetooth qca

## CVE Reference Links Content Summary
The provided content relates to CVE-2024-42137.

**Root cause of vulnerability:**
The vulnerability arises from a regression introduced by commit 272970be3dab, which aimed to fix a use-after-free issue in `qca_serdev_shutdown()`. This fix added a condition to prevent flushing or writing to the serdev after it was closed. However, it inadvertently stopped the VSC (Vendor Specific Command) from being sent during a warm reboot, which is necessary to reset the controller. As a result, the Bluetooth device fails to enable after a warm reboot if the `enable-gpios` property is not configured in the device tree or ACPI for the QCA6390 chipset.

**Weaknesses/vulnerabilities present:**
- **Regression:** A previous fix for a use-after-free issue caused a new regression where the Bluetooth device could not be enabled after a warm reboot in certain configurations.
- **Missing VSC during warm reboot:** The VSC, needed to reset the Bluetooth controller, was not sent in the `qca_serdev_shutdown()` function during a warm reboot.
- **Use-after-free (indirect):** Although the primary fix aimed to address a use-after-free, the regression reintroduced a scenario where the serdev might be accessed in an incorrect state, if not handled correctly.

**Impact of exploitation:**
- **Bluetooth Enable Failure:** The primary impact is that the Bluetooth device on systems using the QCA6390 chipset will fail to enable after a warm reboot if the `enable-gpios` property is not configured in the device tree or ACPI. This means that the user won't be able to use their Bluetooth device, which will render it useless.

**Attack vectors:**
- The vulnerability is triggered by a specific sequence of actions: cold boot, enabling Bluetooth, disabling Bluetooth, warm reboot, and then attempting to enable Bluetooth.
- The vulnerability manifests in systems using the QCA6390 chipset with specific device tree or ACPI configurations lacking the `enable-gpios` property.
- The vulnerability can be triggered by a simple reboot and toggling the bluetooth on and off, making it easily reproducible.

**Required attacker capabilities/position:**
- The attacker needs to be able to trigger a warm reboot of the system.
- The attacker needs to have a system with a QCA6390 Bluetooth chipset where the `enable-gpios` property isn't configured in the device tree or ACPI.
- No specific privileges are required to exploit this vulnerability. A normal user could trigger this if they have access to a machine with the specified conditions.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.818 |
| 2 | 833 | Deadlock | Base | Allowed | sparse | 0.780 |
| 3 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | sparse | 0.768 |
| 4 | 287 | Improper Authentication | Class | Discouraged | sparse | 0.767 |
| 5 | 119 | Improper Restriction of Operations within the Bounds of a Memory Buffer | Class | Discouraged | sparse | 0.757 |
| 6 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 0.725 |
| 7 | 415 | Double Free | Variant | Allowed | sparse | 0.712 |
| 8 | 401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | sparse | 0.710 |
| 9 | 1285 | Improper Validation of Specified Index, Position, or Offset in Input | Base | Allowed | dense | 0.495 |
| 10 | 123 | Write-what-where Condition | Base | Allowed | graph | 0.003 |



# Complete CWE Specifications

CWE-667: Improper Locking

CWE-833: Deadlock

CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')

CWE-287: Improper Authentication

CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer

CWE-1284: Improper Validation of Specified Quantity in Input

CWE-415: Double Free

CWE-401: Missing Release of Memory after Effective Lifetime

CWE-1285: Improper Validation of Specified Index, Position, or Offset in Input

CWE-123: Write-what-where Condition