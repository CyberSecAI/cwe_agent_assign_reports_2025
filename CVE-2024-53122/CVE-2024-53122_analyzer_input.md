# Vulnerability Information: CVE-2024-53122

## Vulnerability Description
In the Linux kernel, the following vulnerability has been resolved mptcp cope racing subflow creation in mptcp_rcv_space_adjust Additional active subflows - i.e. created by the in kernel path manager - are included into the subflow list before starting the 3whs. A racing recvmsg() spooling data received on an already established subflow would unconditionally call tcp_cleanup_rbuf() on all the current subflows, potentially hitting a divide by zero error on the newly created ones. Explicitly check that the subflow is in a suitable state before invoking tcp_cleanup_rbuf().

### Vulnerability Description Key Phrases
- **rootcause:** **race condition**
- **impact:** divide by zero error
- **vector:** recvmsg() spooling data received on an already established subflow
- **product:** Linux kernel
- **component:** mptcp_rcv_space_adjust

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root Cause:**
A race condition exists in the `mptcp_rcv_space_adjust` function when new subflows are created in the kernel path manager. Specifically, a `recvmsg()` call on an established subflow can race with the creation of a new subflow.

**Vulnerabilities/Weaknesses:**
- **Race Condition:** The core issue is the race between `recvmsg()` and subflow creation. When `recvmsg()` is called, it unconditionally calls `tcp_cleanup_rbuf()` on *all* current subflows.
- **Uninitialized Subflow:** Newly created subflows might not be fully initialized when `tcp_cleanup_rbuf()` is called on them.
- **Divide-by-Zero:** The `tcp_cleanup_rbuf()` function, when called on uninitialized subflows, can lead to a divide-by-zero error.

**Impact of Exploitation:**
- **Kernel Crash:** The divide-by-zero error will likely cause a kernel panic, leading to a denial-of-service condition.

**Attack Vectors:**
- **Network Traffic:** An attacker can trigger the race condition by sending network traffic that creates new subflows while simultaneously attempting to receive data on existing subflows.

**Required Attacker Capabilities/Position:**
- The attacker needs to be able to send and receive network traffic on an MPTCP connection. They must be able to cause new subflows to be created and trigger a `recvmsg()` operation simultaneously.

**Technical Details:**
- The vulnerability lies in `net/mptcp/protocol.c` within the `mptcp_rcv_space_adjust` function.
- The fix involves checking if the subflow is in a suitable state using `tcp_can_send_ack(ssk)` before calling `tcp_cleanup_rbuf(ssk, 1)`.
- The fix commit is ce7356ae35943cc6494cc692e62d51a734062b7d. This commit is referenced in other commits in the provided content.
- The issue was introduced by commit c76c6956566f ("mptcp: call tcp_cleanup_rbuf on subflows").

**Summary:** The vulnerability is a race condition that leads to a potential divide-by-zero error in the Linux kernel's MPTCP implementation, triggered by racing subflow creation with receiving data, leading to a kernel panic. The fix is to verify the state of the subflow before calling `tcp_cleanup_rbuf`.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage  | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|------------|-------------------|
| 1 | 362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | alternate_terms | 1.000 |
| 2 | 367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | sparse | 0.413 |
| 3 | 59 | Improper Link Resolution Before File Access ('Link Following') | Base | Allowed | sparse | 0.375 |
| 4 | 863 | Incorrect Authorization | Class | Allowed-with-Review | sparse | 0.371 |
| 5 | 1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | sparse | 0.362 |
| 6 | 667 | Improper Locking | Class | Allowed-with-Review | sparse | 0.362 |
| 7 | 20 | Improper Input Validation | Class | Discouraged | sparse | 0.360 |
| 8 | 427 | Uncontrolled Search Path Element | Base | Allowed | sparse | 0.360 |
| 9 | 421 | Race Condition During Access to Alternate Channel | Base | Allowed | dense | 0.483 |
| 10 | 363 | Race Condition Enabling Link Following | Base | Allowed | graph | 0.003 |

